<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MULTI FC - ì‹¤ì‹œê°„ ì±„íŒ…</title>
    <link rel="stylesheet" th:href="@{/css/style.css}">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700;900&family=Noto+Sans+KR:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">

    <style>
        /* [ê¸°ì¡´ ìŠ¤íƒ€ì¼ ìœ ì§€] */
        .chat-main {
            padding-top: 70px;
            display: flex;
            min-height: 100vh;
            background-color: #f7f7f7;
            position: relative;
            overflow-x: hidden;
            transition: all 0.3s ease-in-out;
        }
        .chat-sidebar {
            width: 300px;
            background: white;
            border-right: 1px solid #ddd;
            flex-shrink: 0;
            display: flex;
            flex-direction: column;
        }
        .chat-content-area {
            flex-grow: 1;
            background: #fff;
            display: flex;
            flex-direction: column;
            position: relative;
            transition: all 0.3s ease-in-out;
            min-width: 0;
        }

        /* í•µì‹¬ CSS: ì‚¬ì´ë“œë°”ê°€ ì—´ë¦´ ë•Œ ë©”ì¸ ì½˜í…ì¸ ë¥¼ ë°€ì–´ëƒ…ë‹ˆë‹¤. */
        .chat-main.sidebar-open {
            margin-right: 280px;
        }

        .chat-header {
            padding: 15px 20px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 18px;
            font-weight: 700;
            color: #2c3e50;
        }

        /* â˜…ì±„íŒ… ìœ í˜• íƒ­ ë²„íŠ¼ ìŠ¤íƒ€ì¼ (ê¹”ë”í•œ ê¸€ì”¨ ë°‘ì¤„ í˜•ì‹)â˜… */
        .chat-type-tabs {
            display: flex;
            justify-content: space-around;
            padding: 10px 0 0 0;
            margin-bottom: 0;
            border-bottom: 1px solid #eee;
        }
        .chat-type-tabs button {
            flex-grow: 1;
            padding: 10px 5px;
            margin: 0;
            background: none !important;
            border: none !important;
            border-radius: 0 !important;
            font-size: 14px;
            font-weight: 600;
            color: #999;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            transition: all 0.2s;
            outline: none;
        }
        .chat-type-tabs button.active {
            color: #6c5ce7;
            border-bottom-color: #6c5ce7;
        }
        .chat-type-tabs button:hover:not(.active) {
            color: #2c3e50;
            background-color: transparent;
        }


        /* ì±„íŒ…ë°© ëª©ë¡ */
        .room-list-container {
            flex-grow: 1;
            overflow-y: auto;
        }
        .room-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 10px 15px 20px;
            border-bottom: 1px solid #f7f7f7;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .room-item:hover, .room-item.active {
            background-color: #f0f0f0;
        }
        .room-info {
            flex-grow: 1;
            min-width: 0;
            padding-right: 10px;
        }
        .room-name {
            font-weight: 600;
            color: #2c3e50;
        }
        .last-message {
            font-size: 13px;
            color: #888;
            margin-top: 4px;
            overflow: hidden;
            white-space: nowrap;
            text-overflow: ellipsis;
        }

        /* ì‚­ì œ ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
        .delete-room-btn {
            background: none;
            border: none;
            color: #e74c3c;
            font-size: 15px;
            cursor: pointer;
            flex-shrink: 0;
            opacity: 0.7;
            padding: 5px;
        }
        .delete-room-btn:hover {
            opacity: 1;
        }

        /* ì±„íŒ…ë°© ìƒì„¸ */
        .chat-messages {
            flex-grow: 1;
            overflow-y: auto;
            padding: 20px;
            background-color: #f7f7f7;
        }
        .chat-input-area {
            border-top: 1px solid #ddd;
            padding: 10px 20px;
            display: flex;
            align-items: center;
            background: white;
        }
        .chat-input-area input {
            flex-grow: 1;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 20px;
            margin-right: 10px;
            font-size: 15px;
        }
        .chat-input-area button {
            background-color: #6c5ce7;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 20px;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        .chat-input-area button:hover {
            background-color: #8e44ad;
        }

        /* ë©”ì‹œì§€ ë²„ë¸” ìŠ¤íƒ€ì¼ */
        .message-bubble {
            margin-bottom: 15px;
            display: flex;
            align-items: flex-start;
        }
        .message-bubble.mine {
            justify-content: flex-end;
        }
        .message-bubble.mine .message-content {
            background-color: #ffe500;
            color: #191919;
            border-radius: 15px 15px 0 15px;
        }
        .message-bubble.other {
            justify-content: flex-start;
        }
        .message-bubble.other .message-content {
            background-color: white;
            color: #333;
            border-radius: 15px 15px 15px 0;
            border: 1px solid #ddd;
        }
        .message-text {
            padding: 10px 15px;
            max-width: 70%;
            word-wrap: break-word;
            font-size: 15px;
        }
        .message-meta {
            font-size: 11px;
            color: #888;
            align-self: flex-end;
            margin: 0 5px;
        }

        /* ë£¸ì´ ì„ íƒë˜ì§€ ì•Šì•˜ì„ ë•Œ */
        #chat-welcome-message {
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 20px;
            color: #999;
            height: 100%;
            text-align: center;
        }
        #current-chat-room {
            display: none;
            flex-direction: column;
            position: relative;
            height: 100%;
            overflow: hidden; /* ì¸ë¼ì¸ í”„ë¡œí•„ì´ ë²—ì–´ë‚˜ì§€ ì•Šë„ë¡ */
        }

        /* ìƒíƒœ ë©”ì‹œì§€ */
        #connection-status {
            position: absolute;
            top: 70px;
            left: 0;
            width: 100%;
            background-color: #f0f0f0;
            color: #e74c3c;
            padding: 8px;
            text-align: center;
            font-size: 14px;
            font-weight: 600;
            z-index: 990;
            display: none;
        }

        /* â˜…ì°¸ì—¬ì ëª©ë¡ ì‚¬ì´ë“œë°” ìŠ¤íƒ€ì¼â˜… */
        #participant-sidebar {
            position: fixed;
            top: 70px;
            right: 0;
            width: 280px;
            height: calc(100vh - 70px);
            background: white;
            box-shadow: -4px 0 10px rgba(0, 0, 0, 0.2);
            z-index: 1000;
            transform: translateX(100%);
            transition: transform 0.3s ease-in-out;
            display: flex;
            flex-direction: column;
            border-left: 1px solid #ddd;
        }
        #participant-sidebar.open {
            transform: translateX(0);
        }
        .sidebar-header {
            padding: 15px 20px;
            font-size: 18px;
            font-weight: 700;
            color: #2c3e50;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .sidebar-close-btn {
            background: none;
            border: none;
            font-size: 20px;
            cursor: pointer;
            color: #555;
        }
        .participant-list-container {
            flex-grow: 1;
            padding: 10px 0;
        }

        /* ì°¸ì—¬ì í•­ëª© ìŠ¤íƒ€ì¼ ê°œì„  */
        .participant-item {
            display: flex;
            align-items: center;
            padding: 10px 20px;
            border-bottom: 1px solid #f7f7f7;
            cursor: pointer;
        }
        .participant-item:hover {
            background-color: #fcfcfc;
        }
        .participant-icon-wrapper {
            width: 35px;
            height: 35px;
            border-radius: 50%;
            background-color: #f0f0f0;
            display: flex;
            justify-content: center;
            align-items: center;
            margin-right: 10px;
            flex-shrink: 0;
        }
        .participant-icon-wrapper i {
            font-size: 16px;
            color: #6c5ce7;
            margin: 0;
        }
        .participant-details {
            display: flex;
            flex-direction: column;
            line-height: 1.3;
        }
        .participant-name {
            font-size: 15px;
            color: #333;
            font-weight: 500;
        }
        .participant-role-badge {
            font-size: 11px;
            font-weight: 700;
            padding: 2px 5px;
            border-radius: 5px;
            margin-left: 5px;
            color: white;
            white-space: nowrap;
        }
        .role-admin { background-color: #6c5ce7; }
        .role-host { background-color: #e74c3c; }
        .role-me { background-color: #3498db; }

        /* ëª¨ë°”ì¼ ëŒ€ì‘ */
        @media (max-width: 900px) {
            .chat-main.sidebar-open {
                width: 100%;
                margin-right: 0;
            }
            #participant-sidebar {
                width: 100%;
                height: calc(100vh - 70px);
            }
        }

        /* â˜…ëª¨ë‹¬ ìŠ¤íƒ€ì¼â˜… */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 10001;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s;
        }
        .modal-overlay.open {
            opacity: 1;
            pointer-events: auto;
        }
        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            max-width: 400px;
            width: 90%;
            transform: translateY(-20px);
            transition: transform 0.3s;
            position: relative;
        }
        .modal-overlay.open .modal-content {
            transform: translateY(0);
        }
        .modal-content h2 {
            font-size: 24px;
            color: #2c3e50;
            margin-bottom: 20px;
            border-bottom: 2px solid #6c5ce7;
            padding-bottom: 10px;
        }
        .modal-content p {
            font-size: 15px;
            color: #555;
            margin-bottom: 10px;
        }
        .modal-content strong {
            color: #6c5ce7;
            margin-left: 5px;
        }
        .modal-actions {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 20px;
        }
        .modal-actions button {
            padding: 10px 20px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
        }
        .btn-cancel {
            background: #f0f0f0;
            color: #555;
            border: 1px solid #ddd;
        }
        .btn-create {
            background: #6c5ce7;
            color: white;
            border: none;
        }

        /* ìƒˆ ì±„íŒ… ëª¨ë‹¬ ì „ìš© ì…ë ¥ í•„ë“œ ìŠ¤íƒ€ì¼ */
        #new-chat-modal .modal-content input,
        #new-chat-modal .modal-content select {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 8px;
            margin-bottom: 15px;
            box-sizing: border-box;
            font-size: 15px;
        }

        /* â˜…ì¹œêµ¬ ì´ˆëŒ€ ëª¨ë‹¬ ëª©ë¡ ìŠ¤íƒ€ì¼ */
        .invite-friend-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid #f7f7f7;
            cursor: pointer;
        }
        .invite-friend-item:hover {
            background-color: #fafafa;
        }
        .invite-friend-item.selected {
            background-color: #e6e6ff; /* ì—°í•œ ë³´ë¼ìƒ‰ ë°°ê²½ */
        }
        .invite-friend-item span {
            font-size: 15px;
            color: #333;
        }
        .friend-status {
            font-size: 12px;
            color: #28a745; /* ì˜¨ë¼ì¸ ìƒ‰ìƒ */
            margin-left: 10px;
        }
        .friend-status.offline {
            color: #999;
        }
        .friend-checkbox {
            transform: scale(1.2);
            accent-color: #6c5ce7;
        }

        /* â˜…ì´ˆëŒ€ ëª¨ë‹¬ ë‚´ ë²„íŠ¼ */
        #invite-modal .modal-content button {
            padding: 5px 15px;
            border-radius: 5px;
            font-weight: 600;
        }
        #final-invite-btn:disabled {
            background-color: #aaa;
            cursor: not-allowed;
        }

        /* â˜…â˜…â˜… ìµœì¢… ìˆ˜ì •: ì¸ë¼ì¸ í”„ë¡œí•„ ìƒì„¸ ì •ë³´ ìŠ¤íƒ€ì¼ (ë²„ê·¸ í•´ê²° ë° UI í™•ì •) â˜…â˜…â˜… */
        .inline-profile-detail {
            /* â­â­â­ ìœ„ì¹˜ ì¡°ì •: FIXED + ìš°ì¸¡ ì°¸ì—¬ì ì‚¬ì´ë“œë°” ì˜†ì— ë‚˜ì˜¤ë„ë¡ â­â­â­ */
            position: fixed;
            top: 100px;
            right: 280px; /* ì°¸ì—¬ì ì‚¬ì´ë“œë°” ë„ˆë¹„ë§Œí¼ ì™¼ìª½ìœ¼ë¡œ ë„ìš°ê¸° (280px) */
            width: 200px; /* ì°½ í¬ê¸° ì¡°ì • */
            height: auto;
            background: white;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.2);
            border-radius: 10px;
            padding: 15px;

            /* â­â­â­ ì´ˆê¸° ìˆ¨ê¹€ ìƒíƒœ (JSì—ì„œ display:none ì œì–´) â­â­â­ */
            transform: translateX(100%);
            transition: transform 0.3s ease-in-out;
            display: none; /* â­â­ ì´ˆê¸° ë Œë”ë§ ì‹œ ì•„ì˜ˆ ìˆ¨ê¹€ â­â­ */
            flex-direction: column;
            z-index: 9999;
            border: 1px solid #ddd;
        }

        /* ì°½ì´ ì—´ë ¸ì„ ë•Œ (í˜„ì¬ ìœ„ì¹˜(right: 280px)ë¡œ ì´ë™) */
        .inline-profile-detail.open {
            transform: translateX(0%); /* Xì¶• ì´ë™ 0% = right: 280px ìœ„ì¹˜ì— í‘œì‹œ */
            display: flex; /* â­â­ ì—´ë¦´ ë•Œë§Œ ë³´ì´ê²Œ ì„¤ì • â­â­ */
        }

        .inline-profile-detail .close-profile-btn {
            position: absolute;
            top: 5px;
            right: 10px;
            background: none;
            border: none;
            font-size: 20px;
            cursor: pointer;
            color: #555;
        }
        .profile-detail-img {
            width: 70px;
            height: 70px;
            border-radius: 50%;
            object-fit: cover;
            margin-bottom: 8px;
            border: 2px solid #6c5ce7;
        }
        .profile-info-content h3 {
            font-size: 16px;
            color: #2c3e50;
            margin-bottom: 8px;
        }
        .profile-meta-info p {
            font-size: 12px;
            color: #555;
            margin-bottom: 4px;
        }
        .profile-meta-info strong {
            font-size: 13px;
        }
        .chat-one-on-one-btn, .send-friend-request-btn {
            padding: 8px 10px;
            margin-top: 8px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            width: 100%;
            transition: background-color 0.2s;
            font-size: 13px;
        }
        /* í”„ë¡œí•„ ìƒì„¸ ì°½ì´ ì—´ë ¸ì„ ë•Œ ë©”ì‹œì§€ ì˜ì—­ì„ ë°€ì–´ëƒ…ë‹ˆë‹¤. (fixed positionì´ë¼ í•„ìš” ì—†ìŒ) */
        .chat-content-area.profile-open {
            padding-left: 0;
        }
        /* â­â­ ë³´ê°•: ì±„íŒ…ë°© ìƒì„¸ ì •ë³´ (ì¸ì›/ìœ í˜•) í—¤ë” ìŠ¤íƒ€ì¼ â­â­ */
        .room-title-wrapper {
            display: flex;
            align-items: center;
        }
        .room-status-info {
            font-size: 13px;
            font-weight: 500;
            color: #6c5ce7;
            margin-left: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .room-status-info .fa-lock { color: #e74c3c; } /* 1:1 ì±„íŒ… ì•„ì´ì½˜ ìƒ‰ìƒ */
        .room-status-info .fa-users { color: #6c5ce7; } /* ê·¸ë£¹ ì±„íŒ… ì•„ì´ì½˜ ìƒ‰ìƒ */
        /* â­â­ ë³´ê°• ë â­â­ */
        /* â­â­ ë³´ê°•: ì•ˆ ì½ì€ ë©”ì‹œì§€ ë±ƒì§€ ë° ì¸ì› ìˆ˜ í‘œì‹œë¥¼ ìœ„í•œ ì»¨í…Œì´ë„ˆ â­â­ */
        .room-item-actions {
            display: flex;
            align-items: center;
            gap: 10px;
            flex-shrink: 0;
        }
        .unread-badge {
            background-color: #e74c3c;
            color: white;
            font-size: 11px;
            font-weight: 700;
            border-radius: 10px;
            padding: 3px 8px;
            flex-shrink: 0;
            min-width: 24px;
            text-align: center;
        }
        /* â­â­ ë³´ê°• ë â­â­ */

        /* â˜…ì¶”ê°€: ì¹œêµ¬ ì´ˆëŒ€ ë²„íŠ¼ ìŠ¤íƒ€ì¼ ê°œì„  */
        .invite-action-btn {
            padding: 15px 25px !important; /* ë‚´ë¶€ íŒ¨ë”© ì¦ê°€ë¡œ ë†’ì´/í¬ê¸° ì¦ê°€ */
            font-size: 16px !important; /* í°íŠ¸ í¬ê¸° ìœ ì§€ */
            font-weight: 700 !important;
            cursor: pointer !important; /* ë§ˆìš°ìŠ¤ í¬ì¸í„° ì¶”ê°€ */
            transition: background-color 0.3s, transform 0.2s;
        }
        .invite-action-btn:hover {
            transform: translateY(-1px);
            background-color: #27ae60 !important; /* hover ìƒ‰ìƒ ë³€ê²½ */
        }
    </style>
</head>
<body>

<header class="quick-menu">
    <div class="logo"><a href="/">Multi FC</a></div> <div class="header-icons">
    <button id="profile-menu-toggle" class="profile-icon" style="position: relative; display: none;"> <i class="fas fa-user-circle"></i> </button>
    <div id="profile-menu" class="user-menu"></div>
    <button id="menu-toggle" class="menu-toggle-btn"><i class="fas fa-bars"></i></button>
</div>
    <nav id="main-menu" class="main-nav">
        <ul>
            <li><a href="/"><i class="fas fa-home"></i> ë©”ì¸ (Home)</a></li>
            <li><a href="/fields"><i class="fas fa-search"></i> êµ¬ì¥ê²€ìƒ‰</a></li>
            <li><a href="/community"><i class="fas fa-users"></i> ì»¤ë®¤ë‹ˆí‹°</a></li>
            <li id="nav-chat-link-li"><a href="/chat" class="active"><i class="fas fa-comments"></i> ì‹¤ì‹œê°„ì±„íŒ…</a></li>
        </ul>
    </nav>
</header>

<div id="connection-status">
    WebSocket ì—°ê²° ì¤‘... ì„œë²„ê°€ ì¤€ë¹„ë˜ë©´ ìë™ìœ¼ë¡œ ì—°ê²°ë©ë‹ˆë‹¤.
</div>

<main id="chat-main-wrapper" class="chat-main">
    <div class="chat-sidebar">
        <div class="chat-header">
            ì±„íŒ… ëª©ë¡
            <button id="new-chat-btn" onclick="openNewChatModal(true)" style="background:none; border:none; color:#6c5ce7; font-size:16px; cursor:pointer;" title="ìƒˆ ì±„íŒ… ì‹œì‘">
                <i class="fas fa-plus-circle"></i>
            </button>
        </div>

        <div id="chat-type-tabs" class="chat-type-tabs">
            <button data-type="public">ì „ì²´ ì±„íŒ…</button>
            <button data-type="group">ê·¸ë£¹ ì±„íŒ…</button>
            <button data-type="one-on-one">1:1 ì±„íŒ…</button>
        </div>

        <div id="room-list-container" class="room-list-container">
        </div>
    </div>

    <div class="chat-content-area">
        <div id="chat-welcome-message">
            <p>ì±„íŒ… ëª©ë¡ì—ì„œ ë°©ì„ ì„ íƒí•´ì£¼ì„¸ìš”.</p>
        </div>

        <div id="current-chat-room">
            <div id="chat-room-header" class="chat-header">

                <div class="room-title-wrapper">
                    <span id="room-title">ì±„íŒ…ë°© ì œëª©</span>
                    <div id="room-status-display" class="room-status-info">
                        <span id="room-type-icon"></span>
                        <span id="room-participant-count">0/0</span>
                    </div>
                </div>
                <button onclick="openParticipantList()" style="background:none; border:none; color:#6c5ce7; font-size:18px; cursor:pointer;" title="ì°¸ì—¬ì ëª©ë¡">
                    <i class="fas fa-users"></i>
                </button>
            </div>

            <div id="inline-profile-detail" class="inline-profile-detail">
                <button class="close-profile-btn" onclick="openInlineProfileDetail(false)">&times;</button>
                <div class="profile-info-content" style="text-align: center;">
                    <div style="margin-bottom: 10px; padding-top: 5px;">
                        <img id="profile-img-detail" src="/images/default-profile.png" alt="í”„ë¡œí•„ ì´ë¯¸ì§€" class="profile-detail-img">
                        <h3 id="profile-nickname-detail">ë‹‰ë„¤ì„</h3>
                    </div>
                    <div class="profile-meta-info" style="border-top: 1px solid #eee; padding-top: 10px;">
                        <p style="font-weight: 500;">ì¥ì†Œ: <strong id="profile-location-detail">...</strong></p>
                        <p style="font-weight: 500;">í¬ì§€ì…˜: <strong id="profile-position-detail">...</strong></p>
                    </div>
                    <button class="chat-one-on-one-btn profile-action-button" id="profile-chat-btn">1:1 ì±„íŒ…í•˜ê¸°</button>
                    <button class="send-friend-request-btn profile-action-button" id="profile-friend-btn">ì¹œêµ¬ ìš”ì²­</button>
                </div>
            </div>

            <div id="chat-messages-container" class="chat-messages">
            </div>

            <div class="chat-input-area">
                <input type="text" id="message-input" placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”..." onkeypress="if(event.keyCode===13) sendMessage()" maxlength="500">
                <button onclick="sendMessage()">ì „ì†¡</button>
            </div>
        </div>

    </div>
</main>

<div id="participant-sidebar">
    <div class="sidebar-header">
        <span id="sidebar-room-name">ì°¸ì—¬ì ëª©ë¡</span>
        <button class="sidebar-close-btn" onclick="openParticipantList(false)">
            <i class="fas fa-times"></i>
        </button>
    </div>
    <div id="participant-list-container" class="participant-list-container">
    </div>
    <div style="padding: 15px; border-top: 1px solid #eee;">
        <button class="btn-create invite-action-btn" style="width: 100%;" onclick="openInviteModal()">
            <i class="fas fa-user-plus"></i> ì¹œêµ¬ ì´ˆëŒ€í•˜ê¸°
        </button>
    </div>
</div>

<div id="new-chat-modal" class="modal-overlay">
    <div class="modal-content">
        <h2>ìƒˆ ì±„íŒ…ë°© ì‹œì‘</h2>

        <label for="new-chat-type">ì±„íŒ…ë°© ìœ í˜• ì„ íƒ</label>
        <select id="new-chat-type" onchange="updateNewChatForm(this.value)">
            <option value="one-on-one" selected>1:1 ì±„íŒ…</option>
            <option value="group">ê·¸ë£¹ ì±„íŒ…</option>
            <option value="public">ì „ì²´ ì±„íŒ… (ì „ì²´ ê³µê°œ)</option>
        </select>

        <div id="max-participants-group" style="display: none;">
            <label for="new-chat-max-participants" style="margin-top: 10px;">ìµœëŒ€ ì°¸ì—¬ ì¸ì› (ê·¸ë£¹ ì±„íŒ…)</label>
            <input type="number" id="new-chat-max-participants" min="3" max="50" value="10">
        </div>
        <label for="new-chat-title" style="margin-top: 10px;">ì±„íŒ…ë°© ì´ë¦„</label>
        <input type="text" id="new-chat-title" placeholder="ì±„íŒ…ë°© ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”">

        <div id="recipient-input-group">
            <label for="new-chat-recipient" style="margin-top: 10px;">ìƒëŒ€ë°© ë‹‰ë„¤ì„ (1:1 ì±„íŒ…)</label>
            <input type="text" id="new-chat-recipient" placeholder="ì±„íŒ…í•  ìƒëŒ€ë°©ì˜ ë‹‰ë„¤ì„ì„ ì…ë ¥í•˜ì„¸ìš”">
            <p id="chat-form-info" style="font-size: 13px; color: #777; margin-bottom: 20px;">1:1 ì±„íŒ…ì€ ìƒëŒ€ë°© ë‹‰ë„¤ì„ì´ í•„ìˆ˜ì…ë‹ˆë‹¤.</p>
        </div>


        <div class="modal-actions">
            <button class="btn-cancel" onclick="openNewChatModal(false)">ì·¨ì†Œ</button>
            <button class="btn-create" onclick="createNewChat()">ì±„íŒ… ì‹œì‘</button>
        </div>
    </div>
</div>

<div id="profile-modal" class="modal-overlay" style="display: none;">
    <div class="modal-content">
        <h2 id="profile-username-title">ì‚¬ìš©ì í”„ë¡œí•„</h2>
        <div id="profile-details-content">
            <p>ë‹‰ë„¤ì„: <strong id="profile-nickname">...</strong></p>
            <p>í¬ì§€ì…˜: <strong id="profile-position">...</strong></p>
            <p>ì§€ì—­: <strong id="profile-location">...</strong></p>
            <p style="margin-top: 15px; font-size: 14px; color: #e74c3c;">
                (ì‹¤ì œ DB ì •ë³´ ì—°ë™ í•„ìš”)
            </p>
        </div>
        <div class="modal-actions" style="justify-content: center;">
            <button class="btn-cancel" onclick="openProfileModal(false)">ë‹«ê¸°</button>
        </div>
    </div>
</div>

<div id="invite-modal" class="modal-overlay">
    <div class="modal-content">
        <h2>ì¹œêµ¬ ì´ˆëŒ€</h2>
        <p id="invite-room-info">í˜„ì¬ ë°©: <strong id="invite-room-name">...</strong> (ì¸ì› ì œí•œ: <span id="invite-count-info">...</span>)</p>

        <div id="friend-list-to-invite">
        </div>

        <div class="modal-actions" style="justify-content: space-between;">
            <p style="font-size: 14px; color: #555; margin: 0; align-self: center;">
                <span id="selected-invite-count">0</span>ëª… ì„ íƒë¨
            </p>
            <div>
                <button class="btn-cancel" onclick="openInviteModal(false)">ì·¨ì†Œ</button>
                <button class="btn-create" id="final-invite-btn" onclick="sendInvite()">ì´ˆëŒ€í•˜ê¸°</button>
            </div>
        </div>
    </div>
</div>


<script src="https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.6.1/sockjs.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>

<script>
    // --- (â˜…ê³µí†µâ˜…) ë©”ë‰´ í† ê¸€ ë° ì¸ì¦ ë¡œì§ ---
    const menuToggle = document.getElementById('menu-toggle');
    const mainMenu = document.getElementById('main-menu');
    const profileMenuToggle = document.getElementById('profile-menu-toggle');
    const profileMenu = document.getElementById('profile-menu');
    const logoutButton = document.getElementById('logout-button');
    const navLoginLink = document.querySelector('#main-menu a[href="/login"]');
    const navLogoutLink = document.querySelector('#main-menu ul li:last-child');
    // ... (ì´í•˜ ê³µí†µ ë¡œì§ ìœ ì§€) ...

    if (menuToggle) {
        menuToggle.addEventListener('click', () => {
            mainMenu.classList.toggle('show');
            if (profileMenu) profileMenu.classList.remove('show');
        });
    }

    if (profileMenuToggle) {
        profileMenuToggle.addEventListener('click', () => {
            profileMenu.classList.toggle('show');
            if (mainMenu) mainMenu.classList.remove('show');
        });
    }
    // ... (ì´í•˜ ê³µí†µ ë¡œì§ ìœ ì§€) ...


    // ===========================================
    // ì±— í´ë¼ì´ì–¸íŠ¸ ë¡œì§ (WebSocket/STOMP)
    // ===========================================

    let stompClient = null;
    let currentRoomId = null;
    let myUsername = 'MyUser123';
    const chatContainer = document.getElementById('chat-messages-container');
    const inputArea = document.getElementById('message-input');
    const roomTitleElement = document.getElementById('room-title');
    const connectionStatus = document.getElementById('connection-status');
    const roomListContainer = document.getElementById('room-list-container');
    const chatTypeTabs = document.getElementById('chat-type-tabs');
    const participantSidebar = document.getElementById('participant-sidebar');
    const participantListContainer = document.getElementById('participant-list-container');
    const chatMainWrapper = document.getElementById('chat-main-wrapper'); // ë©”ì¸ wrapper
    const newChatModal = document.getElementById('new-chat-modal'); // ìƒˆ ì±„íŒ… ëª¨ë‹¬
    const profileModal = document.getElementById('profile-modal'); // â˜…í”„ë¡œí•„ ëª¨ë‹¬
    const inviteModal = document.getElementById('invite-modal'); // â˜…ì´ˆëŒ€ ëª¨ë‹¬
    const friendListToInvite = document.getElementById('friend-list-to-invite'); // â˜…ì´ˆëŒ€ ëª©ë¡ ì»¨í…Œì´ë„ˆ
    const selectedInviteCountElement = document.getElementById('selected-invite-count'); // â˜…ì„ íƒ ì¸ì› ìˆ˜ í‘œì‹œ
    let selectedInvitees = new Set(); // â˜…ì„ íƒëœ ì¹œêµ¬ Set

    // â˜…â˜…â˜… ì¶”ê°€ëœ ë³€ìˆ˜ â˜…â˜…â˜…
    const inlineProfileDetail = document.getElementById('inline-profile-detail');
    const chatContentArea = document.querySelector('.chat-content-area');
    const roomStatusDisplay = document.getElementById('room-status-display');
    const roomParticipantCount = document.getElementById('room-participant-count');
    const roomTypeIcon = document.getElementById('room-type-icon');
    const profileChatBtn = document.getElementById('profile-chat-btn');
    const profileFriendBtn = document.getElementById('profile-friend-btn');

    // â˜…ëª¨ë‹¬ ë‚´ ìš”ì†Œ
    const newChatTypeSelect = document.getElementById('new-chat-type');
    const newChatTitleInput = document.getElementById('new-chat-title');
    const newChatRecipientInput = document.getElementById('new-chat-recipient');
    const recipientInputGroup = document.getElementById('recipient-input-group');
    const chatFormInfo = document.getElementById('chat-form-info');

    const RECONNECT_INTERVAL = 5000;
    let currentChatType = 'public'; // â˜…ê¸°ë³¸ê°’ publicìœ¼ë¡œ ì„¤ì • (HTML íƒ­ê³¼ ì¼ì¹˜)
    let nextChatRoomId = 300; // ìƒˆë¡œìš´ ë°© ID ì‹œì‘ì 

    // --- ë”ë¯¸ ë°ì´í„° (ERD ë°˜ì˜: unreadCount ì¶”ê°€) ---
    const MOCK_ROOMS = {
        'public': [
            // â­â­ unreadCount ì¶”ê°€ (ERD: Chat_Message.read_at ë°˜ì˜) â­â­
            { id: 201, name: 'ğŸš¨ ê´€ë¦¬ì ê³µì§€', lastMessage: '[ê³µì§€] ë§¤ë„ˆ ì ìˆ˜ ì‹œìŠ¤í…œ ê°œí¸ ì•ˆë‚´', participants: ['ê´€ë¦¬ì', 'MyUser123', 'UserA', 'UserB', 'UserC', 'UserD', 'ìº¡í‹´ì†', 'êµ¬ì›íˆ¬ìˆ˜'], maxParticipants: 50, createdAt: '2025-10-20', unreadCount: 1 },
            { id: 202, name: 'ğŸ“¢ ììœ  ìˆ˜ë‹¤ë°©', lastMessage: 'ì˜¤ëŠ˜ í’‹ì‚´í™” ìƒ€ëŠ”ë° ì¶”ì²œ ì¢€ í•´ì£¼ì„¸ìš”!', participants: ['MyUser123', 'í’‹ì‚´ë§¤ë‹ˆì•„', 'ì¶•êµ¬ì™•'], maxParticipants: 50, createdAt: '2025-11-01', unreadCount: 0 }
        ],
        'group': [
            { id: 1, name: 'âš½ 11/05 ìˆ˜ì› í’‹ì‚´ (10ëª…)', lastMessage: 'UserA: ë„¤, ê±°ê¸°ì„œ ë´¬ìš”!', participants: ['MyUser123 (ë°©ì¥)', 'UserA', 'UserB', 'UserC', 'UserD'], maxParticipants: 10, createdAt: '2025-10-28', unreadCount: 5 },
            { id: 2, name: 'ğŸ“Œ íŒ€ì› ëª¨ì§‘ - ìº¡í‹´ì†', lastMessage: 'ì¢‹ì•„ìš”, í¬ì§€ì…˜ì€ DF ê°€ëŠ¥í•©ë‹ˆë‹¤.', participants: ['MyUser123 (ë°©ì¥)', 'ìº¡í‹´ì†', 'êµ¬ì›íˆ¬ìˆ˜'], maxParticipants: 12, createdAt: '2025-11-02', unreadCount: 0 }
        ],
        'one-on-one': [
            { id: 101, name: '1:1 ì±„íŒ… - ì‹¬íŒì¥ (ìš´ì˜ì§„)ë‹ˆ', lastMessage: 'ê·œì • ìœ„ë°˜ ê´€ë ¨ ë¬¸ì˜ ë‹µë³€ì…ë‹ˆë‹¤.', participants: ['MyUser123', 'ì‹¬íŒì¥ (ìš´ì˜ì§„)'], maxParticipants: 2, createdAt: '2025-09-01', unreadCount: 1 },
            { id: 102, name: '1:1 ì±„íŒ… - ìˆ˜ë¹„ìˆ˜ êµ¬í•¨', lastMessage: 'ì´ë²ˆ ì£¼ë§ ê²½ê¸° ê°€ëŠ¥í•˜ì„¸ìš”?', participants: ['MyUser123', 'ìˆ˜ë¹„ìˆ˜ êµ¬í•¨'], maxParticipants: 2, createdAt: '2025-11-03', unreadCount: 2 }
        ]
    };

    // â­â­ ë³´ê°•: MOCK_HISTORY ë”ë¯¸ ì±„íŒ… ë‚´ìš© ì¶”ê°€ â­â­
    const MOCK_HISTORY = {
        201: [
            { sender: 'ê´€ë¦¬ì', content: 'ğŸš¨ [í•„ë…] ë§¤ë„ˆ ì ìˆ˜ ì‹œìŠ¤í…œì´ ê°œí¸ë©ë‹ˆë‹¤. ê³µì§€ì‚¬í•­ì„ í™•ì¸í•´ì£¼ì„¸ìš”.', timestamp: 'ì˜¤ì „ 9:00' },
            { sender: 'UserA', content: 'ê³µì§€ ì˜ ì½ì—ˆìŠµë‹ˆë‹¤! ë§¤ë„ˆ ì ìˆ˜ ê´€ë¦¬ ì² ì €íˆ í•˜ê² ìŠµë‹ˆë‹¤.', timestamp: 'ì˜¤ì „ 9:05' }
        ],
        202: [
            { sender: 'í’‹ì‚´ë§¤ë‹ˆì•„', content: 'ì˜¤ëŠ˜ í’‹ì‚´í™” ìƒ€ëŠ”ë° ì¶”ì²œ ì¢€ í•´ì£¼ì„¸ìš”! ì•„ë””ë‹¤ìŠ¤ ì‹ ìƒì´ ê¶ê¸ˆí•´ìš”.', timestamp: 'ì˜¤í›„ 3:00' },
            { sender: 'MyUser123', content: 'ì €ëŠ” ë‚˜ì´í‚¤ í‹°ì— í¬ ì‚¬ìš© ì¤‘ì¸ë°, ë°œ í¸í•˜ê³  ì¢‹ì•„ìš”!', timestamp: 'ì˜¤í›„ 3:05' },
            { sender: 'ì¶•êµ¬ì™•', content: 'ì €ë„ í‹°ì— í¬ ì¶”ì²œí•©ë‹ˆë‹¤! ğŸ¤£', timestamp: 'ì˜¤í›„ 3:10' }
        ],
        1: [
            { sender: 'UserA', content: 'ê²½ê¸° ì¥ì†Œ í˜¹ì‹œ ë³€ê²½ëœ ê±´ ì—†ë‚˜ìš”?', timestamp: 'ì˜¤ì „ 10:00' },
            { sender: 'MyUser123', content: 'ì•„ë‹™ë‹ˆë‹¤, ê·¸ëŒ€ë¡œ ì„œìš¸ ê°•ë‚¨ í’‹ì‚´ì¥ì…ë‹ˆë‹¤. ì‹œê°„ ë§ì¶° ì˜¤ì„¸ìš”!', timestamp: 'ì˜¤ì „ 10:05' }
        ],
        2: [
            { sender: 'OtherUser', content: 'íŒ€ì› ëª¨ì§‘ ë³´ê³  ì—°ë½ë“œë ¸ìŠµë‹ˆë‹¤. DF í¬ì§€ì…˜ ê°€ëŠ¥í•©ë‹ˆë‹¤.', timestamp: 'ì˜¤í›„ 1:00' },
            { sender: 'MyUser123', content: 'ì¢‹ìŠµë‹ˆë‹¤! ì´ë²ˆì£¼ í† ìš”ì¼ 19ì‹œ ì°¸ì„ ê°€ëŠ¥í•˜ì‹ ê°€ìš”?', timestamp: 'ì˜¤í›„ 1:05' }
        ],
        101: [
            { sender: 'ì‹¬íŒì¥ (ìš´ì˜ì§„)', content: 'ê·œì • ìœ„ë°˜ ê´€ë ¨ ë¬¸ì˜ ë‹µë³€ì…ë‹ˆë‹¤. í•´ë‹¹ ê±´ì€ ê²½ê³  ì¡°ì¹˜ë¡œ ë§ˆë¬´ë¦¬ë©ë‹ˆë‹¤.', timestamp: 'ì˜¤í›„ 4:00' },
            { sender: 'MyUser123', content: 'ë¹ ë¥¸ ë‹µë³€ ê°ì‚¬í•©ë‹ˆë‹¤.', timestamp: 'ì˜¤í›„ 4:02' }
        ],
        102: [
            { sender: 'ìˆ˜ë¹„ìˆ˜ êµ¬í•¨', content: 'ì´ë²ˆ ì£¼ë§ ê²½ê¸° ê°€ëŠ¥í•˜ì„¸ìš”? ê¸‰í•˜ê²Œ í•œ ë¶„ êµ¬í•©ë‹ˆë‹¤.', timestamp: 'ì˜¤í›„ 7:00' },
            { sender: 'MyUser123', content: 'ì£„ì†¡í•©ë‹ˆë‹¤, ì´ë²ˆ ì£¼ë§ì€ ì„ ì•½ì´ ìˆì–´ìš”. ğŸ˜­', timestamp: 'ì˜¤í›„ 7:15' }
        ]
    };
    // â­â­ ë³´ê°• ë â­â­


    const MOCK_PROFILES = {
        'UserA': { nickname: 'UserA', position: 'FW', location: 'ì„œìš¸ ê°•ë‚¨êµ¬', profilePic: '/images/mock_user_a.png' },
        'UserB': { nickname: 'UserB', position: 'MF', location: 'ì„œìš¸ ì„œì´ˆêµ¬', profilePic: '/images/mock_user_b.png' },
        'ì‹¬íŒì¥ (ìš´ì˜ì§„)': { nickname: 'ìš´ì˜ì', position: 'GK', location: 'ì „êµ­', profilePic: '/images/mock_admin.png' },
        'MyUser123': { nickname: 'ë‚˜', position: 'DF', location: 'ì„œìš¸ ì¤‘êµ¬', profilePic: '/images/default-profile.png' },
        'ìº¡í‹´ì†': { nickname: 'ìº¡í‹´ì†', position: 'MF', location: 'ìˆ˜ì› ì˜í†µêµ¬', profilePic: '/images/mock_captain.png' },
        'êµ¬ì›íˆ¬ìˆ˜': { nickname: 'êµ¬ì›íˆ¬ìˆ˜', position: 'DF', location: 'ì„±ë‚¨ ë¶„ë‹¹êµ¬', profilePic: '/images/mock_closer.png' },
        'í’‹ì‚´ë§¤ë‹ˆì•„': { nickname: 'í’‹ì‚´ë§¤ë‹ˆì•„', position: 'ALA', location: 'ì¸ì²œ', profilePic: '/images/default-profile.png' },
        'ì¶•êµ¬ì™•': { nickname: 'ì¶•êµ¬ì™•', position: 'PIVO', location: 'ê°•ì›', profilePic: '/images/default-profile.png' },
    };

    const MOCK_FRIENDS = [
        { name: 'ìº¡í‹´ì†', status: 'ì˜¨ë¼ì¸' },
        { name: 'êµ¬ì›íˆ¬ìˆ˜', status: 'ì˜¤í”„ë¼ì¸' },
        { name: 'í’‹ì‚´ë§¤ë‹ˆì•„', status: 'ì˜¨ë¼ì¸' },
        { name: 'UserE', status: 'ì˜¨ë¼ì¸' },
        { name: 'UserF', status: 'ì˜¤í”„ë¼ì¸' }
    ];
    // ----------------------------------

    function updateStatus(message, isError = true) {
        connectionStatus.textContent = message;
        connectionStatus.style.display = 'block';
        connectionStatus.style.backgroundColor = isError ? '#ffe3e3' : '#e6ffed';
        connectionStatus.style.color = isError ? '#c0392b' : '#28a745';

        if (!isError) {
            setTimeout(() => {
                connectionStatus.style.display = 'none';
            }, 3000);
        } else {
            connectionStatus.style.display = 'none';
            console.error("WebSocket ì—°ê²° ì‹¤íŒ¨. 5ì´ˆ í›„ ì¬ì‹œë„í•©ë‹ˆë‹¤.");
            return;
        }
    }

    function connect() {
        if (stompClient && stompClient.connected) {
            console.log('Already connected.');
            return;
        }

        updateStatus("WebSocket ì—°ê²° ì‹œë„ ì¤‘...", true);

        const socket = new SockJS('/ws');
        stompClient = Stomp.over(socket);
        stompClient.debug = null;

        stompClient.connect({}, onConnected, onError);
    }

    function onConnected() {
        console.log('WebSocket ì—°ê²° ì„±ê³µ.');
        updateStatus("âœ… ì‹¤ì‹œê°„ ì±„íŒ… ì„œë²„ì— ì—°ê²°ë˜ì—ˆìŠµë‹ˆë‹¤.", false);

        if (currentRoomId) {
            subscribeToRoom(currentRoomId);
        }
    }

    function onError(error) {
        console.error('WebSocket ì—°ê²° ì˜¤ë¥˜: ì¬ì—°ê²° ì‹œë„', error);
        connectionStatus.style.display = 'none';

        if (stompClient && stompClient.ws && stompClient.ws.readyState === WebSocket.OPEN) {
            stompClient.disconnect(() => {
                stompClient = null;
                setTimeout(connect, RECONNECT_INTERVAL);
            });
        } else {
            stompClient = null;
            setTimeout(connect, RECONNECT_INTERVAL);
        }
    }

    function subscribeToRoom(roomId) {
        if (stompClient && stompClient.connected) {
            stompClient.subscribe('/topic/chat/room/' + roomId, onMessageReceived);
            console.log(`Room ${roomId} êµ¬ë… ì‹œì‘.`);
        }
    }

    function onMessageReceived(payload) {
        const message = JSON.parse(payload.body);
        displayMessage(message);
    }

    // â­â­ ë³´ê°•: ë©”ì‹œì§€ ì „ì†¡ ë¡œì§ (ì „ì†¡ í›„ í™”ë©´ í‘œì‹œ) â­â­
    function sendMessage() {
        const messageContent = inputArea.value.trim();
        if (messageContent && stompClient && stompClient.connected && currentRoomId) {
            const chatMessage = {
                roomId: currentRoomId,
                sender: myUsername,
                content: messageContent,
                timestamp: new Date().toLocaleTimeString('ko-KR', { hour: '2-digit', minute: '2-digit' })
            };

            // 1. ì„œë²„ë¡œ ì „ì†¡ (ì‹¤ì‹œê°„ ì›¹ì†Œì¼“)
            stompClient.send("/app/chat.sendMessage", {}, JSON.stringify(chatMessage));

            // 2. ì…ë ¥ í•„ë“œ ì´ˆê¸°í™”
            inputArea.value = '';

            // 3. í™”ë©´ì— ì¦‰ì‹œ í‘œì‹œ (UX ê°œì„ )
            displayMessage(chatMessage);

            // 4. ëª©ë¡ì˜ ë§ˆì§€ë§‰ ë©”ì‹œì§€ ì—…ë°ì´íŠ¸
            updateLastMessage(currentRoomId, messageContent);

        } else if (!currentRoomId) {
            alert("ì±„íŒ…ë°©ì„ ë¨¼ì € ì„ íƒí•´ì£¼ì„¸ìš”.");
        } else if (!stompClient || !stompClient.connected) {
            alert("âŒ ì±„íŒ… ì„œë²„ì— ì—°ê²°ë˜ì–´ ìˆì§€ ì•ŠìŠµë‹ˆë‹¤. ì ì‹œ í›„ ì¬ì‹œë„ í•´ì£¼ì„¸ìš”.");
        }
    }
    // â­â­ ë³´ê°• ë â­â­


    // â˜…ìƒˆë¡œìš´ í•¨ìˆ˜: ì±„íŒ… ëª©ë¡ì˜ ë§ˆì§€ë§‰ ë©”ì‹œì§€ ì—…ë°ì´íŠ¸
    function updateLastMessage(roomId, content) {
        const roomItem = document.querySelector(`.room-item[data-room-id="${roomId}"]`);
        if (roomItem) {
            const lastMessageDiv = roomItem.querySelector('.last-message');
            if (lastMessageDiv) {
                const preview = (content.length > 30 ? content.substring(0, 30) + '...' : content);
                lastMessageDiv.textContent = `ë‚˜: ${preview}`;
            }
        }
    }

    function displayMessage(message) {
        const isMine = message.sender === myUsername;
        const bubble = document.createElement('div');
        bubble.className = 'message-bubble ' + (isMine ? 'mine' : 'other');

        let senderName = isMine ? '' : message.sender;
        if (message.sender.includes("(ìš´ì˜ì§„)") || message.sender.includes("ê´€ë¦¬ì")) {
            senderName = `<span style="font-weight: 700; color: #6c5ce7;">${senderName}</span>`;
        } else if (message.sender.includes("(ë°©ì¥)")) {
            senderName = `<span style="font-weight: 700; color: #e74c3c;">${senderName}</span>`;
        }

        const meta = `<div class="message-meta">${message.timestamp}</div>`;
        const content = `<div class="message-content message-text">${senderName}${!isMine && senderName ? ': ' : ''}${message.content}</div>`;

        if (isMine) {
            bubble.innerHTML = meta + content;
        } else {
            bubble.innerHTML = content + meta;
        }

        chatContainer.appendChild(bubble);
        chatContainer.scrollTop = chatContainer.scrollHeight;
    }

    // â­â­ ë³´ê°•: loadRoomList í•¨ìˆ˜ (ì•ˆ ì½ì€ ë©”ì‹œì§€ ë±ƒì§€ ì¶”ê°€) â­â­
    function loadRoomList(type) {
        currentChatType = type;
        const rooms = MOCK_ROOMS[type] || [];
        roomListContainer.innerHTML = '';

        if (rooms.length === 0) {
            roomListContainer.innerHTML = `<div style="padding: 20px; text-align: center; color: #999;">í˜„ì¬ ${type} ìœ í˜•ì˜ ì±„íŒ…ë°©ì´ ì—†ìŠµë‹ˆë‹¤.</div>`;
            if (!rooms.find(room => room.id === currentRoomId)) {
                currentRoomId = null;
                document.getElementById('current-chat-room').style.display = 'none';
                document.getElementById('chat-welcome-message').style.display = 'flex';
                // ì±„íŒ…ë°© ìƒíƒœ í‘œì‹œ ì´ˆê¸°í™”
                roomStatusDisplay.style.display = 'none';
            }
            return;
        }

        rooms.forEach((room, index) => {
            const isActive = room.id === currentRoomId;
            const item = document.createElement('div');
            item.className = 'room-item' + (isActive ? ' active' : '');
            item.dataset.roomId = room.id;

            // â˜…ì±„íŒ…ë°© ì •ë³´ ì˜ì—­
            const roomInfo = document.createElement('div');
            roomInfo.className = 'room-info';
            roomInfo.innerHTML = `
                       <div class="room-name">${room.name}</div>
                       <div style="font-size: 11px; color: #aaa; margin-top: 2px;">
                           ê°œì„¤ì¼: ${room.createdAt}
                       </div>
                       <div class="last-message">${room.lastMessage}</div>
                   `;
            // roomInfo í´ë¦­ ì‹œ room ê°ì²´ ì „ì²´ ì „ë‹¬
            roomInfo.onclick = () => selectRoom(room);

            // â˜…ì‚­ì œ ë²„íŠ¼
            const deleteBtn = document.createElement('button');
            deleteBtn.className = 'delete-room-btn';
            deleteBtn.innerHTML = '<i class="fas fa-trash-alt"></i>';
            deleteBtn.onclick = (e) => {
                e.stopPropagation(); // ëª©ë¡ ì„ íƒ ì´ë²¤íŠ¸ ë°©ì§€
                if (confirm(`ì •ë§ë¡œ [${room.name}] ì±„íŒ…ë°©ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
                    deleteChatRoom(room.id);
                }
            };

            // â­â­ ë³´ê°•: ë±ƒì§€ì™€ ì‚­ì œ ë²„íŠ¼ ì»¨í…Œì´ë„ˆ â­â­
            const actionContainer = document.createElement('div');
            actionContainer.className = 'room-item-actions';

            // ì•ˆ ì½ì€ ë©”ì‹œì§€ ë±ƒì§€ ì¶”ê°€
            if (room.unreadCount > 0) {
                actionContainer.innerHTML += `<span class="unread-badge">${room.unreadCount}</span>`;
            }
            actionContainer.appendChild(deleteBtn);
            // â­â­ ë³´ê°• ë â­â­


            item.appendChild(roomInfo);
            item.appendChild(actionContainer);
            roomListContainer.appendChild(item);


            if (index === 0 && !currentRoomId) {
                // selectRoom(room); // í˜ì´ì§€ ë¡œë“œ ì‹œ ìë™ ì„ íƒ ë°©ì§€ (ìœ ì§€)
            }
        });

        // â­â­ ë³´ê°•: ì±„íŒ…ë°© ìë™ ì„ íƒ ë¡œì§ ì œê±° í›„, ì´ˆê¸° í™”ë©´ ë©”ì‹œì§€ í‘œì‹œ (ìœ ì§€) â­â­
        if (!currentRoomId) {
            document.getElementById('current-chat-room').style.display = 'none';
            document.getElementById('chat-welcome-message').style.display = 'flex';
        }
    }

    // â˜…ìƒˆë¡œìš´ í•¨ìˆ˜: ì±„íŒ…ë°© ì‚­ì œ ë¡œì§
    function deleteChatRoom(roomIdToDelete) {
        let roomDeleted = false;
        Object.keys(MOCK_ROOMS).forEach(type => {
            const initialLength = MOCK_ROOMS[type].length;
            MOCK_ROOMS[type] = MOCK_ROOMS[type].filter(room => room.id !== roomIdToDelete);
            if (MOCK_ROOMS[type].length < initialLength) {
                roomDeleted = true;
            }
        });

        if (roomDeleted) {
            delete MOCK_HISTORY[roomIdToDelete];
            alert('ì±„íŒ…ë°©ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');

            if (currentRoomId === roomIdToDelete) {
                currentRoomId = null;
            }
            loadRoomList(currentChatType);
        }
    }


    function loadRoomHistory(roomId) {
        const id = parseInt(roomId);
        const history = MOCK_HISTORY[id] || [];

        chatContainer.innerHTML = '';

        if (history.length === 0) {
            // â­â­ ë³´ê°•: ì±„íŒ… ë‚´ìš©ì´ ì—†ì„ ë•Œ ë©”ì‹œì§€ í‘œì‹œ â­â­
            chatContainer.innerHTML = `<div style="text-align: center; color: #999; margin-top: 50px;">ìƒˆë¡œìš´ ì±„íŒ…ì„ ì‹œì‘í•˜ì„¸ìš”.</div>`;
        } else {
            history.forEach(msg => displayMessage(msg));
        }
    }

    // â­â­ ë³´ê°•: selectRoom í•¨ìˆ˜ (ì±„íŒ…ë°© ìƒíƒœ í‘œì‹œ ì—…ë°ì´íŠ¸) â­â­
    function selectRoom(room) {
        const activeItem = document.querySelector('.room-item.active');
        if (activeItem) {
            activeItem.classList.remove('active');
            if(participantSidebar.classList.contains('open')) {
                openParticipantList(false);
            }
        }

        // â­â­â­ ë³´ê°•: ìƒˆë¡œìš´ ë°© ì„ íƒ ì‹œ ì¸ë¼ì¸ í”„ë¡œí•„ ì°½ ë‹«ê¸° â­â­â­
        openInlineProfileDetail(false);

        const newActiveItem = document.querySelector(`.room-item[data-room-id="${room.id}"]`);
        if (newActiveItem) {
            newActiveItem.classList.add('active');
            // ì„ íƒëœ ë°©ì˜ ë±ƒì§€ ì œê±° (ì½ìŒ ì²˜ë¦¬)
            const badge = newActiveItem.querySelector('.unread-badge');
            if(badge) badge.remove();
            room.unreadCount = 0;
        }

        currentRoomId = room.id;
        document.getElementById('sidebar-room-name').textContent = room.name;
        roomTitleElement.textContent = room.name;

        // ì±„íŒ…ë°© ìƒì„¸ ìƒíƒœ ì—…ë°ì´íŠ¸ (ERD: ChatRoom ë°˜ì˜)
        // â­â­ ë³´ê°•ëœ ì±„íŒ…ë°© í—¤ë” UI ì—…ë°ì´íŠ¸ ë¡œì§ â­â­
        roomStatusDisplay.style.display = 'flex';
        roomParticipantCount.textContent = `${room.participants.length}/${room.maxParticipants}`;

        let iconClass = '';
        if (currentChatType === 'one-on-one') {
            iconClass = 'fas fa-lock'; // 1:1 ì±„íŒ…ì€ ì ê¸ˆ ì•„ì´ì½˜
        } else {
            iconClass = 'fas fa-users'; // ê·¸ë£¹/ì „ì²´ ì±„íŒ…ì€ ì‚¬ìš©ì ì•„ì´ì½˜
        }
        roomTypeIcon.innerHTML = `<i class="${iconClass}"></i>`;

        // í—¤ë”ì— ìƒíƒœ í‘œì‹œ ìš”ì†Œë¥¼ DOMì— ì¶”ê°€/ì •ë ¬
        const chatHeader = document.getElementById('chat-room-header');
        if (!chatHeader.querySelector('.room-title-wrapper')) {
            const wrapper = document.createElement('div');
            wrapper.className = 'room-title-wrapper';
            wrapper.appendChild(roomTitleElement);
            wrapper.appendChild(roomStatusDisplay);
            chatHeader.prepend(wrapper);
        }
        // â­â­ ë³´ê°• ë â­â­


        document.getElementById('chat-welcome-message').style.display = 'none';
        document.getElementById('current-chat-room').style.display = 'flex';
        document.getElementById('current-chat-room').style.flexDirection = 'column';

        // â­â­ ë³´ê°•: ì±„íŒ… ë‚´ìš©ì„ ë¡œë“œ â­â­
        loadRoomHistory(room.id);

        if (stompClient && stompClient.connected) {
            subscribeToRoom(room.id);
        } else {
            connect();
        }
    }

    function openParticipantList(shouldOpen) {
        const isOpen = typeof shouldOpen === 'boolean' ? shouldOpen : !participantSidebar.classList.contains('open');

        if (isOpen) {
            loadParticipantList(currentRoomId);
            participantSidebar.classList.add('open');
            chatMainWrapper.classList.add('sidebar-open');
            // â­â­ ë³´ê°•: ì‚¬ì´ë“œë°” ì—´ ë•Œ ì¸ë¼ì¸ í”„ë¡œí•„ ì°½ ë‹«ê¸° â­â­
            openInlineProfileDetail(false);
        } else {
            participantSidebar.classList.remove('open');
            chatMainWrapper.classList.remove('sidebar-open');
        }
    }

    // â˜…â˜…â˜… ìˆ˜ì •: ì°¸ì—¬ì ëª©ë¡ ë¡œë“œ ì‹œ ì¸ë¼ì¸ í”„ë¡œí•„ ìƒì„¸ ì°½ ì—°ê²° â˜…â˜…â˜…
    function loadParticipantList(roomId) {
        const roomsOfType = MOCK_ROOMS[currentChatType];
        const room = roomsOfType ? roomsOfType.find(r => r.id === parseInt(roomId)) : null;

        participantListContainer.innerHTML = '';

        if (!room || !room.participants) {
            participantListContainer.innerHTML = '<p style="color: #999; text-align: center;">ì°¸ì—¬ì ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</p>';
            return;
        }

        document.getElementById('sidebar-room-name').textContent = `${room.name} (${room.participants.length}ëª…)`;

        room.participants.forEach(participant => {
            const item = document.createElement('div');
            item.className = 'participant-item';

            let iconClass = 'fas fa-user-circle';
            let roleBadge = '';

            if (participant.includes('(ìš´ì˜ì§„)') || participant.includes('ê´€ë¦¬ì')) {
                iconClass = 'fas fa-shield-alt';
                roleBadge = '<span class="participant-role-badge role-admin">ìš´ì˜ì§„</span>';
            } else if (participant.includes('(ë°©ì¥)')) {
                iconClass = 'fas fa-crown';
                roleBadge = '<span class="participant-role-badge role-host">ë°©ì¥</span>';
            }
            if (participant.includes(myUsername)) {
                if (!roleBadge) {
                    roleBadge = '<span class="participant-role-badge role-me">ë‚˜</span>';
                } else {
                    roleBadge += '<span class="participant-role-badge role-me">ë‚˜</span>';
                }
            }

            let displayName = participant.replace(/\s\(.*\)/g, '');

            // â˜… ìˆ˜ì •: ê¸°ì¡´ openProfileModal ëŒ€ì‹  openInlineProfileDetail í˜¸ì¶œ
            // **í´ë¦­ ì´ë²¤íŠ¸ì—ë§Œ** ì—°ê²°í•˜ì—¬ ìë™ í˜¸ì¶œ ë°©ì§€
            item.onclick = () => openInlineProfileDetail(displayName);

            item.innerHTML = `
                       <div class="participant-icon-wrapper">
                           <i class="${iconClass}"></i>
                       </div>
                       <div class="participant-details">
                           <span class="participant-name">${displayName}${roleBadge}</span>
                       </div>
                   `;
            participantListContainer.appendChild(item);
        });
    }

    // â˜…â˜…â˜… ìµœì¢… ìˆ˜ì •: ì¸ë¼ì¸ í”„ë¡œí•„ ìƒì„¸ ì •ë³´ í•¨ìˆ˜ (ë§¤ì¹­ë‚´ìš© ì œê±°) â˜…â˜…â˜…
    function openInlineProfileDetail(username) {

        const isCurrentlyOpen = inlineProfileDetail.classList.contains('open');

        // ë‹«ê¸° ìš”ì²­ì´ê±°ë‚˜, ì´ë¯¸ ì—´ë ¤ ìˆëŠ” ìƒíƒœì—ì„œ ê°™ì€ ìœ ì €ë¥¼ ë‹¤ì‹œ í´ë¦­í•˜ë©´ ë‹«ê¸°
        if (username === false || (isCurrentlyOpen && inlineProfileDetail.dataset.username === username)) {
            // â­â­ ë‹«ê¸° ì‹œ display: noneìœ¼ë¡œ ì™„ì „íˆ ìˆ¨ê¹€ â­â­
            inlineProfileDetail.classList.remove('open');
            inlineProfileDetail.style.display = 'none'; // ì¦‰ì‹œ ìˆ¨ê¹€
            delete inlineProfileDetail.dataset.username;
            return;
        }

        const profile = MOCK_PROFILES[username] ||
            { nickname: username, position: 'ë¯¸ë“±ë¡', location: 'ë¯¸ë“±ë¡', profilePic: '/images/default-profile.png' };

        // DOMì— í˜„ì¬ ìœ ì € ì´ë¦„ ì €ì¥
        inlineProfileDetail.dataset.username = username;

        document.getElementById('profile-img-detail').src = profile.profilePic || '/images/default-profile.png';
        document.getElementById('profile-nickname-detail').textContent = profile.nickname;
        document.getElementById('profile-location-detail').textContent = profile.location; // ì¥ì†Œ (ì§€ì—­)
        document.getElementById('profile-position-detail').textContent = profile.position;
        // document.getElementById('profile-match-info-detail').textContent = matchInfo; // â­â­ ë§¤ì¹­ë‚´ìš© ì œê±° â­â­

        // â­â­ ì—´ê¸° ì „ display: flexë¡œ ì„¤ì • â­â­
        inlineProfileDetail.style.display = 'flex';
        inlineProfileDetail.classList.add('open');
    }

    // ìƒˆ ì±„íŒ… ëª¨ë‹¬ ì—´ê¸°/ë‹«ê¸° (ìƒëŒ€ë°© ë‹‰ë„¤ì„ ì¸ì ì¶”ê°€)
    function openNewChatModal(open, recipientUsername = null) {
        if (open) {
            newChatModal.classList.add('open');
            newChatTitleInput.value = '';
            newChatTypeSelect.value = 'one-on-one';
            updateNewChatForm('one-on-one'); // 1:1 ì±„íŒ…ìœ¼ë¡œ ì„¤ì •

            // â­ ìƒëŒ€ë°© ë‹‰ë„¤ì„ì´ ì „ë‹¬ë˜ì—ˆë‹¤ë©´ input í•„ë“œì— ì±„ìš°ê¸° â­
            if (recipientUsername) {
                newChatRecipientInput.value = recipientUsername;
            } else {
                newChatRecipientInput.value = '';
            }

            newChatTitleInput.focus();
        } else {
            newChatModal.classList.remove('open');
        }
    }


    // â˜…ìƒˆë¡œìš´ í•¨ìˆ˜: ì±„íŒ…ë°© ìœ í˜•ì— ë”°ë¼ í¼ í•„ë“œë¥¼ ì—…ë°ì´íŠ¸
    function updateNewChatForm(type) {
        const maxParticipantsGroup = document.getElementById('max-participants-group'); // ì¶”ê°€ëœ ë³€ìˆ˜

        if (type === 'one-on-one') {
            recipientInputGroup.style.display = 'block';
            maxParticipantsGroup.style.display = 'none'; // 1:1ì€ ì¸ì› ì„¤ì • ìˆ¨ê¹€
            chatFormInfo.textContent = 'ìƒëŒ€ë°© ë‹‰ë„¤ì„ì´ í•„ìˆ˜ì…ë‹ˆë‹¤.';
            newChatRecipientInput.placeholder = '1:1 ì±„íŒ…í•  ìƒëŒ€ë°©ì˜ ë‹‰ë„¤ì„ì„ ì…ë ¥í•˜ì„¸ìš”';

        } else if (type === 'group') {
            recipientInputGroup.style.display = 'block';
            maxParticipantsGroup.style.display = 'block'; // ê·¸ë£¹ì€ ì¸ì› ì„¤ì • í‘œì‹œ
            chatFormInfo.textContent = 'ê·¸ë£¹ ì±„íŒ…ì— ì´ˆëŒ€í•  ì°¸ì—¬ì ë‹‰ë„¤ì„ì„ ì‰¼í‘œ(,)ë¡œ ì…ë ¥í•˜ì„¸ìš” (ì„ íƒ ì‚¬í•­).';
            newChatRecipientInput.placeholder = 'ì´ˆëŒ€í•  ë‹‰ë„¤ì„ ì…ë ¥ (ì„ íƒ ì‚¬í•­)';

        } else if (type === 'public') {
            recipientInputGroup.style.display = 'none';
            maxParticipantsGroup.style.display = 'none'; // ì „ì²´ ì±„íŒ…ì€ ì¸ì› ì„¤ì • ìˆ¨ê¹€
            chatFormInfo.textContent = 'ì „ì²´ ì±„íŒ…ë°©ì€ ëˆ„êµ¬ë‚˜ ì°¸ì—¬ ê°€ëŠ¥í•©ë‹ˆë‹¤.';
        }

        // í¼ ì´ˆê¸°í™” (í—·ê°ˆë¦¬ì§€ ì•Šë„ë¡)
        newChatRecipientInput.value = '';
    }

    // â˜…ìˆ˜ì •ëœ í•¨ìˆ˜: ì±„íŒ…ë°© ìƒì„± (ì¹´í…Œê³ ë¦¬ë³„)
    function createNewChat() {
        const type = newChatTypeSelect.value;
        const title = newChatTitleInput.value.trim();
        const recipientInput = newChatRecipientInput.value.trim();
        const maxParticipantsInput = document.getElementById('new-chat-max-participants'); // ì¶”ê°€ëœ ë³€ìˆ˜

        if (!title) {
            alert("ì±„íŒ…ë°© ì œëª©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
            return;
        }

        let newRoomName = title;
        let newParticipants = [myUsername];
        let maxCount = 50; // ê¸°ë³¸ê°’

        if (type === 'one-on-one') {
            if (!recipientInput) {
                alert("1:1 ì±„íŒ…ì€ ìƒëŒ€ë°© ë‹‰ë„¤ì„ì´ í•„ìˆ˜ì…ë‹ˆë‹¤.");
                return;
            }
            const recipient = recipientInput.split(',')[0].trim(); // ì²« ë²ˆì§¸ ë‹‰ë„¤ì„ë§Œ ì‚¬ìš©
            newRoomName = `1:1 ì±„íŒ… - ${recipient} (vs ${myUsername})`;
            newParticipants = [myUsername, recipient];

            // 1:1 ì¤‘ë³µ í™•ì¸ (ë”ë¯¸)
            const existingRoom = MOCK_ROOMS['one-on-one'].find(room =>
                room.participants.includes(recipient) && room.participants.includes(myUsername)
            );
            if (existingRoom) {
                alert(`${recipient}ë‹˜ê³¼ì˜ ì±„íŒ…ë°©ì´ ì´ë¯¸ ì¡´ì¬í•©ë‹ˆë‹¤.`);
                openNewChatModal(false);
                selectRoom(existingRoom);
                return;
            }
            maxCount = 2; // 1:1 ê³ ì •

        } else if (type === 'group') {
            newRoomName = `[ê·¸ë£¹] ${title}`;
            if (recipientInput) {
                const recipients = recipientInput.split(',').map(r => r.trim()).filter(r => r);
                newParticipants = [myUsername + ' (ë°©ì¥)', ...recipients];
            } else {
                newParticipants = [myUsername + ' (ë°©ì¥)'];
            }
            // â­â­ ìˆ˜ì •: ìµœëŒ€ ì¸ì› ê°’ ì‚¬ìš© â­â­
            maxCount = parseInt(maxParticipantsInput.value) || 10;
            if (maxCount < 3) maxCount = 3;

        } else if (type === 'public') {
            newRoomName = `[ì „ì²´] ${title}`;
            newParticipants = [myUsername]; // ë°©ì¥ë§Œ ì´ˆê¸° ì°¸ì—¬ìë¡œ ê°€ì •
            maxCount = 50; // Public ê³ ì •
        }

        // ìƒˆ ë°© ID ìƒì„± ë° ë°ì´í„° ì¶”ê°€
        const newRoomId = nextChatRoomId++;
        const newRoom = {
            id: newRoomId,
            name: newRoomName,
            lastMessage: 'ìƒˆë¡œìš´ ì±„íŒ…ë°©ì´ ì‹œì‘ë˜ì—ˆìŠµë‹ˆë‹¤.',
            participants: newParticipants,
            maxParticipants: maxCount,
            // â­â­ ìˆ˜ì •: í˜„ì¬ ë‚ ì§œë¡œ ê°œì„¤ì¼ ì„¤ì • â­â­
            createdAt: new Date().toISOString().slice(0, 10)
        };

        MOCK_ROOMS[type].unshift(newRoom); // ëª©ë¡ ë§¨ ì•ì— ì¶”ê°€
        MOCK_HISTORY[newRoomId] = [{ sender: 'System', content: newRoomName + 'ì´(ê°€) ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤.', timestamp: new Date().toLocaleTimeString('ko-KR') }]; // ì´ˆê¸° ëŒ€í™” ê¸°ë¡ ìƒì„±

        // 3. ëª¨ë‹¬ ë‹«ê³ , í•´ë‹¹ íƒ­ìœ¼ë¡œ ì´ë™ í›„, ìƒˆ ë°© ì„ íƒ
        openNewChatModal(false);

        // íƒ­ ì „í™˜
        chatTypeTabs.querySelectorAll('button').forEach(btn => btn.classList.remove('active'));
        const newTab = document.querySelector(`[data-type="${type}"]`);
        if (newTab) newTab.classList.add('active');

        loadRoomList(type); // ëª©ë¡ ê°±ì‹ 
        selectRoom(newRoom); // ìƒˆ ë°©ìœ¼ë¡œ ì´ë™
    }

    // â˜…ìˆ˜ì •ëœ í•¨ìˆ˜: í”„ë¡œí•„ ëª¨ë‹¬ ì—´ê¸°/ë‹«ê¸° (ê¸°ì¡´ ëª¨ë‹¬ì´ ì•„ë‹Œ ì¸ë¼ì¸ ìƒì„¸ ì •ë³´ ì°½ì„ ì“°ë¯€ë¡œ, ì´ í•¨ìˆ˜ëŠ” ì‚¬ìš©í•˜ì§€ ì•Šë„ë¡ ì²˜ë¦¬)
    // ì¸ë¼ì¸ ìƒì„¸ ì •ë³´ ì°½ì„ ë‹«ëŠ” ë¡œì§ë§Œ ë‚¨ê²¨ë‘ 
    function openProfileModal(username) {
        // ì´ í•¨ìˆ˜ëŠ” ê¸°ì¡´ ëª¨ë‹¬ì„ ë‹«ëŠ” ì—­í• ë§Œ ìˆ˜í–‰í•˜ê±°ë‚˜, ì•„ì˜ˆ ì‚¬ìš©í•˜ì§€ ì•Šë„ë¡ ì²˜ë¦¬í•©ë‹ˆë‹¤.
        // ëŒ€ì‹  openInlineProfileDetail(username)ì„ ì‚¬ìš©í•©ë‹ˆë‹¤.
        console.warn("openProfileModal ëŒ€ì‹  openInlineProfileDetailì„ ì‚¬ìš©í•˜ì„¸ìš”.");
        if (username === false) {
            const modal = document.getElementById('profile-modal');
            modal.classList.remove('open');
        }
    }


    // ===========================================
    // â˜…ì¹œêµ¬ ì´ˆëŒ€ ê¸°ëŠ¥ ë¡œì§â˜… (ì´ì „ ì½”ë“œì—ì„œ ë³µêµ¬)
    // ===========================================

    /**
     * ì¹œêµ¬ ì´ˆëŒ€ ëª¨ë‹¬ ì—´ê¸°/ë‹«ê¸°
     */
    function openInviteModal(open = true) {
        const currentRoom = MOCK_ROOMS[currentChatType].find(r => r.id === currentRoomId);

        if (currentRoomId === null || !currentRoom) {
            alert('ì±„íŒ…ë°©ì„ ë¨¼ì € ì„ íƒí•´ì£¼ì„¸ìš”.');
            return;
        }

        if (open) {
            const currentCount = currentRoom.participants.length;
            const maxCount = currentRoom.maxParticipants;
            const availableSlots = maxCount - currentCount;

            // 1:1 ì±„íŒ…ì´ê±°ë‚˜ ì´ë¯¸ ë§Œì›ì¸ ê²½ìš° ì œí•œ
            if (currentChatType === 'one-on-one' || availableSlots <= 0) {
                alert('ì´ ë°©ì€ í˜„ì¬ ì´ˆëŒ€í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. (1:1 ì±„íŒ… ë˜ëŠ” ì •ì› ì´ˆê³¼)');
                return;
            }

            // ëª¨ë‹¬ í—¤ë” ì •ë³´ ì—…ë°ì´íŠ¸
            document.getElementById('invite-room-name').textContent = currentRoom.name;
            document.getElementById('invite-count-info').textContent = `ìµœëŒ€ ${maxCount}ëª… ì¤‘ ${availableSlots}ëª… ì¶”ê°€ ê°€ëŠ¥`;

            loadFriendListForInvite(currentRoom);

            selectedInvitees.clear();
            selectedInviteCountElement.textContent = 0;

            inviteModal.classList.add('open');
        } else {
            inviteModal.classList.remove('open');
        }
    }

    /**
     * ì´ˆëŒ€ ê°€ëŠ¥í•œ ì¹œêµ¬ ëª©ë¡ì„ ë Œë”ë§
     */
    function loadFriendListForInvite(currentRoom) {
        const currentParticipantsNames = currentRoom.participants.map(p => p.split(' ')[0]);
        friendListToInvite.innerHTML = '';

        const availableSlots = currentRoom.maxParticipants - currentRoom.participants.length;

        MOCK_FRIENDS.filter(friend => friend.name !== myUsername.split(' ')[0] && !currentParticipantsNames.includes(friend.name))
            .forEach(friend => {
                const item = document.createElement('div');
                item.className = 'invite-friend-item';
                item.dataset.friendName = friend.name;

                const isAvailable = friend.status === 'ì˜¨ë¼ì¸'; // ì´ˆëŒ€ ë¡œì§ì€ ì˜¨ë¼ì¸ë§Œ ê°€ëŠ¥í•˜ë‹¤ê³  ê°€ì •

                // ì²´í¬ë°•ìŠ¤
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.className = 'friend-checkbox';
                checkbox.disabled = !isAvailable || selectedInvitees.size >= availableSlots;
                checkbox.checked = selectedInvitees.has(friend.name);

                checkbox.onchange = function() {
                    toggleInviteSelection(friend.name, item, this.checked);
                };

                const nameSpan = document.createElement('span');
                nameSpan.innerHTML = `${friend.name}
                       <span class="friend-status ${isAvailable ? '' : 'offline'}">(${friend.status})</span>`;

                item.appendChild(checkbox);
                item.appendChild(nameSpan);

                friendListToInvite.appendChild(item);
            });

        if (friendListToInvite.innerHTML === '') {
            friendListToInvite.innerHTML = '<p style="text-align: center; padding: 20px; color: #999;">ì´ˆëŒ€í•  ì¹œêµ¬ê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
        }
    }

    /**
     * ì¹œêµ¬ ì„ íƒ/í•´ì œ í† ê¸€ ë¡œì§
     */
    function toggleInviteSelection(name, itemElement, isChecked) {
        const currentRoom = MOCK_ROOMS[currentChatType].find(r => r.id === currentRoomId);
        const availableSlots = currentRoom.maxParticipants - currentRoom.participants.length;

        if (isChecked) {
            if (selectedInvitees.size < availableSlots) {
                selectedInvitees.add(name);
                itemElement.classList.add('selected');
            } else {
                // ì„ íƒ ì œí•œ ì‹œ ì²´í¬ë°•ìŠ¤ ìƒíƒœ ë¡¤ë°±
                itemElement.querySelector('.friend-checkbox').checked = false;
                alert(`ìµœëŒ€ ${availableSlots}ëª…ê¹Œì§€ë§Œ ì´ˆëŒ€í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.`);
                return;
            }
        } else {
            selectedInvitees.delete(name);
            itemElement.classList.remove('selected');
        }

        selectedInviteCountElement.textContent = selectedInvitees.size;

        // â˜…ìŠ¬ë¡¯ì´ ê°€ë“ ì°¼ì„ ë•Œ, ëª¨ë“  ë¯¸ì„ íƒ ì²´í¬ë°•ìŠ¤ ë¹„í™œì„±í™”
        const shouldDisable = selectedInvitees.size >= availableSlots;
        document.querySelectorAll('.invite-friend-item').forEach(item => {
            const checkbox = item.querySelector('.friend-checkbox');
            if (!checkbox.checked && shouldDisable) {
                checkbox.disabled = true;
            } else {
                const friendName = item.dataset.friendName;
                const friend = MOCK_FRIENDS.find(f => f.name === friendName);
                if (friend && friend.status === 'ì˜¨ë¼ì¸') {
                    checkbox.disabled = false;
                }
            }
        });
    }

    /**
     * ìµœì¢… ì´ˆëŒ€ ì „ì†¡ (ë”ë¯¸ ë¡œì§)
     */
    function sendInvite() {
        if (selectedInvitees.size === 0) {
            alert('ì´ˆëŒ€í•  ì¹œêµ¬ë¥¼ í•œ ëª… ì´ìƒ ì„ íƒí•´ì£¼ì„¸ìš”.');
            return;
        }

        const inviteList = Array.from(selectedInvitees).join(', ');
        const currentRoom = MOCK_ROOMS[currentChatType].find(r => r.id === currentRoomId);

        // â˜… ì‹¤ì œ ë¡œì§: ì„œë²„ì˜ /api/chat/invite ì—”ë“œí¬ì¸íŠ¸ì— POST ìš”ì²­ ì „ì†¡
        console.log(`[ì´ˆëŒ€ ì „ì†¡ ì‹œë®¬ë ˆì´ì…˜] ë°© ID ${currentRoomId}ì— ${inviteList}ë¥¼ ì´ˆëŒ€í•©ë‹ˆë‹¤.`);

        alert(`${inviteList} ë‹˜ì—ê²Œ ì´ˆëŒ€ ë©”ì‹œì§€ë¥¼ ë³´ëƒˆìŠµë‹ˆë‹¤! (ì‹¤ì œë¡œëŠ” ì„œë²„ì—ì„œ ì²˜ë¦¬)`);

        // ë”ë¯¸ ë°ì´í„°ì— ì°¸ì—¬ì ì¶”ê°€ (UI ë°˜ì˜)
        currentRoom.participants.push(...Array.from(selectedInvitees).map(name => name)); // ì´ë¦„ë§Œ ì¶”ê°€
        loadParticipantList(currentRoomId); // ì‚¬ì´ë“œë°” ê°±ì‹ 
        openInviteModal(false); // ëª¨ë‹¬ ë‹«ê¸°
    }
    // ===========================================
    // â˜…ê¸°íƒ€ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ (ê¸°ì¡´ ë¡œì§ ìœ ì§€)
    // ===========================================

    document.getElementById('room-list-container').addEventListener('click', (e) => {
        // ì‚­ì œ ë²„íŠ¼ í´ë¦­ì€ ì—¬ê¸°ì„œ ì²˜ë¦¬í•˜ì§€ ì•Šê³ , deleteChatRoomì—ì„œ ì²˜ë¦¬ë¨
    });

    chatTypeTabs.addEventListener('click', (e) => {
        const button = e.target.closest('button');
        if (button) {
            chatTypeTabs.querySelectorAll('button').forEach(btn => btn.classList.remove('active'));
            button.classList.add('active');

            const newType = button.dataset.type;
            loadRoomList(newType);
        }
    });

    // â­â­ ì¸ë¼ì¸ í”„ë¡œí•„ ì•¡ì…˜ ë²„íŠ¼ í•¸ë“¤ëŸ¬ ì—°ê²° â­â­
    document.addEventListener('DOMContentLoaded', () => {
        // ... (ê¸°ì¡´ DOMContentLoaded ë¡œì§ ìœ ì§€) ...

        if (profileChatBtn) {
            profileChatBtn.addEventListener('click', function() {
                const username = inlineProfileDetail.dataset.username;
                openInlineProfileDetail(false); // ì°½ ë‹«ê¸°
                openNewChatModal(true, username); // ìƒˆ ì±„íŒ… ëª¨ë‹¬ ì—´ê¸° ë° ìœ ì € ì´ë¦„ ì „ë‹¬
            });
        }

        if (profileFriendBtn) {
            profileFriendBtn.addEventListener('click', function() {
                const username = inlineProfileDetail.dataset.username;
                alert(`${username}ë‹˜ì—ê²Œ ì¹œêµ¬ ìš”ì²­ì„ ë³´ëƒ…ë‹ˆë‹¤.`); // â­ ìš”ì²­ ì‹œë®¬ë ˆì´ì…˜ ì•Œë¦¼ í‘œì‹œ â­
                openInlineProfileDetail(false); // â­ ì°½ ë‹«ê¸° â­
                // window.location.href = '/friends'; // â­ í˜ì´ì§€ ì´ë™ ë¡œì§ ì œê±° â­
            });
        }

        // â­â­â­ ë¹„íšŒì› ì ‘ê·¼ ì œì–´ ë¡œì§ (ì±„íŒ…ì€ íšŒì›ë§Œ ê°€ëŠ¥) â­â­â­
        const accessToken = localStorage.getItem('accessToken');
        if (!accessToken) {
            alert("âŒ ì‹¤ì‹œê°„ ì±„íŒ…ì€ íšŒì›ë§Œ ì´ìš©í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
            window.location.href = '/login';
            return;
        }

        // HTML íƒ­ ìˆœì„œì™€ JS ì´ˆê¸°í™”ë¥¼ ë§ì¶¥ë‹ˆë‹¤.
        const defaultType = 'public'; // HTMLì—ì„œ publicì´ ì²« ë²ˆì§¸ì´ë¯€ë¡œ ê¸°ë³¸ê°’ìœ¼ë¡œ ì„¤ì •
        let activeTab = document.querySelector(`[data-type="public"]`);

        // í˜„ì¬ active í´ë˜ìŠ¤ê°€ ì—†ëŠ” ê²½ìš° defaultTabì„ í™œì„±í™”í•©ë‹ˆë‹¤.
        if (!document.querySelector('.chat-type-tabs button.active')) {
            if (activeTab) activeTab.classList.add('active');
            currentChatType = defaultType;
        } else {
            currentChatType = document.querySelector('.chat-type-tabs button.active').dataset.type;
        }

        loadRoomList(currentChatType);
        // ì´ˆê¸° ë¡œë“œ í›„ UX ê°œì„ ì„ ìœ„í•´ 1:1 ì±„íŒ… í¼ ì´ˆê¸°í™”
        updateNewChatForm('one-on-one');

        // â­â­ ì´ˆê¸° ë¡œë“œ ì‹œ ì¸ë¼ì¸ í”„ë¡œí•„ ì°½ ìˆ¨ê¹€ â­â­
        openInlineProfileDetail(false);
    });
</script>
</body>
</html>