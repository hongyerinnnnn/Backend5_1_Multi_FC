<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FUTSAL MATCH - 커뮤니티</title>

    <link rel="stylesheet" th:href="@{/css/style.css}">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700;900&family=Noto+Sans+KR:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">

    <style>
        /* (style 태그 내용은 이전과 동일) */
        .community-main {
            padding: 100px 40px 40px 40px;
            background-color: #f7f7f7;
            min-height: 100vh;
        }
        .board-container {
            max-width: 1000px;
            margin: 0 auto;
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        }

        .board-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            border-bottom: 2px solid #eee;
            padding-bottom: 10px;
        }
        .board-tabs {
            display: flex;
            flex-grow: 1;
        }
        .board-tabs button {
            background: none;
            border: none;
            padding: 10px 15px;
            font-size: 16px;
            font-weight: 600;
            color: #777;
            border-bottom: 2px solid transparent;
            cursor: pointer;
            transition: color 0.2s, border-bottom 0.2s;
            margin-right: 5px;
        }
        .board-tabs button.active {
            color: #6c5ce7;
            border-bottom-color: #6c5ce7;
        }
        .write-button {
            padding: 8px 15px;
            background-color: #6c5ce7;
            color: white;
            font-weight: 600;
            border-radius: 8px;
            text-decoration: none;
            transition: background-color 0.3s;
            white-space: nowrap;
        }
        .write-button:hover {
            background-color: #8e44ad;
        }
        /* ⭐⭐ 추가된 스타일: 검색 섹션 ⭐⭐ */
        .search-area {
            display: flex;
            gap: 10px;
            margin-top: 20px;
            justify-content: flex-end;
        }
        .search-area select, .search-area input[type="text"] {
            padding: 8px 10px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
        }
        .search-area button {
            padding: 8px 15px;
            background-color: #2c3e50;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
        }

        /* 게시글 목록 테이블 */
        .post-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 25px;
        }
        .post-table th, .post-table td {
            padding: 12px 10px;
            text-align: center;
            border-bottom: 1px solid #eee;
            font-size: 14px;
        }
        .post-table th {
            background-color: #f8f8f8;
            font-weight: 700;
            color: #555;
        }
        .post-table td {
            color: #333;
        }
        .post-table .col-title {
            text-align: left;
            font-weight: 600;
            cursor: pointer;
            transition: color 0.2s;
        }
        .post-table .col-title:hover {
            color: #6c5ce7;
        }
        .col-category {
            color: #6c5ce7;
        }

        /* 페이지네이션 */
        .pagination {
            text-align: center;
            margin-top: 30px;
        }
        .pagination a {
            padding: 5px 10px;
            margin: 0 3px;
            border: 1px solid #ddd;
            border-radius: 5px;
            text-decoration: none;
            color: #555;
        }
        .pagination a.active {
            background-color: #6c5ce7;
            color: white;
            border-color: #6c5ce7;
        }
    </style>
</head>
<body>

<header class="quick-menu">
    <div class="logo"><a href="/">Multi FC</a></div>
    <div class="header-icons">
        <button id="profile-menu-toggle" class="profile-icon" style="position: relative; display: none;">
            <i class="fas fa-user-circle"></i>
            <span id="notification-badge" class="notification-badge"></span>
        </button>
        <div id="profile-menu" class="user-menu">
            <div class="user-info"> <strong><span id="user-menu-username">사용자</span>님</strong> <p>환영합니다!</p> </div>
            <ul>
                <li><a href="/notifications" id="nav-notifications-link"><i class="fas fa-bell"></i> 알림 목록</a></li>
                <li><a href="/mypage"><i class="fas fa-user"></i> 마이페이지</a></li>
                <li><a href="/profile/edit"><i class="fas fa-user-edit"></i> 프로필 수정</a></li>
                <li><a href="#" id="logout-button"><i class="fas fa-sign-out-alt"></i> 로그아웃</a></li>
            </ul>
        </div>
        <button id="menu-toggle" class="menu-toggle-btn"><i class="fas fa-bars"></i></button>
    </div>

    <nav id="main-menu" class="main-nav">
        <ul>
            <li><a href="/" class="active"><i class="fas fa-home"></i> 메인 (Home)</a></li>
            <li><a href="/fields"><i class="fas fa-search"></i> 구장검색</a></li>
            <li class="active"><a href="/community" class="active"><i class="fas fa-users"></i> 커뮤니티</a></li>
            <li><a href="/chat"><i class="fas fa-comments"></i> 실시간채팅</a></li>

            <li><a href="/login" id="nav-login-link"><i class="fas fa-sign-in-alt"></i> 로그인</a></li>
            <li style="display:none;"><a href="#" id="nav-logout-link"><i class="fas fa-sign-out-alt"></i> 로그아웃</a></li>
        </ul>
    </nav>
</header>

<main class="community-main">
    <div class="board-container">
        <div class="board-controls">
            <div class="board-tabs" id="community-tabs">
                <button data-category="all" class="active">전체 목록</button>
                <button data-category="notice">공지사항</button>
                <button data-category="free">자유게시판</button>
                <button data-category="team">팀원모집</button>
            </div>
            <a href="/community/write" class="write-button" id="write-post-btn">
                <i class="fas fa-pencil-alt"></i> 글쓰기
            </a>
        </div>

        <div class="search-area">
            <select id="search-type">
                <option value="title">제목</option>
                <option value="content">내용</option>
                <option value="writer">작성자</option>
            </select>
            <input type="text" id="search-keyword" placeholder="검색어를 입력하세요">
            <button id="search-exec-btn"><i class="fas fa-search"></i> 검색</button>
        </div>
        <table class="post-table">
            <thead>
            <tr>
                <th style="width: 8%;">번호</th>
                <th style="width: 10%;">카테고리</th>
                <th style="width: 45%;">제목</th> <th style="width: 10%;"><i class="fas fa-comment-dots" title="댓글 수"></i></th>
                <th style="width: 12%;">작성자</th>
                <th style="width: 15%;">날짜</th>
                <th style="width: 7%;"><i class="fas fa-eye"></i></th>
            </tr>
            </thead>
            <tbody id="post-list-body">
            </tbody>
        </table>

        <div class="pagination" id="community-pagination">
            <a href="#">&lt;</a>
            <a href="#" class="active">1</a>
            <a href="#">2</a>
            <a href="#">3</a>
            <a href="#">&gt;</a>
        </div>
    </div>
</main>

<script>
    // --- (★공통★) 메뉴 토글 및 로그아웃 로직 (생략) ---
    const menuToggle = document.getElementById('menu-toggle');
    const mainMenu = document.getElementById('main-menu');
    const profileMenuToggle = document.getElementById('profile-menu-toggle');
    const profileMenu = document.getElementById('profile-menu');
    const logoutButton = document.getElementById('logout-button');
    const navNotificationsLink = document.getElementById('nav-notifications-link');

    const navLoginLink = document.getElementById('nav-login-link');
    const navLogoutLink = document.getElementById('nav-logout-link');

    if (menuToggle) {
        menuToggle.addEventListener('click', () => {
            mainMenu.classList.toggle('show');
            if (profileMenu) profileMenu.classList.remove('show');
        });
    }
    if (profileMenuToggle) {
        profileMenuToggle.addEventListener('click', () => {
            profileMenu.classList.toggle('show');
            if (mainMenu) mainMenu.classList.remove('show');
        });
    }
    document.addEventListener('click', (event) => {
        const isClickInsideHeader = document.querySelector('header').contains(event.target);
        if (!isClickInsideHeader) {
            mainMenu.classList.remove('show');
            if (profileMenu) profileMenu.classList.remove('show');
        }
    });

    if (logoutButton) {
        logoutButton.addEventListener('click', (e) => {
            e.preventDefault();
            localStorage.removeItem('accessToken');
            localStorage.removeItem('hasReadReviews');
            localStorage.removeItem('hasReadSchedules');
            window.location.href = '/login';
        });
    }
    if (navLogoutLink) {
        navLogoutLink.addEventListener('click', (e) => {
            e.preventDefault();
            localStorage.removeItem('accessToken');
            localStorage.removeItem('hasReadReviews');
            localStorage.removeItem('hasReadSchedules');
            window.location.href = '/login';
        });
    }

    if (navNotificationsLink) {
        navNotificationsLink.addEventListener('click', (e) => {
            localStorage.setItem('hasReadReviews', 'true');
            localStorage.setItem('hasReadSchedules', 'true');
            window.location.href = '/notifications';
        });
    }

    // --- (★공통★) 알림 배지 로드 함수 (생략) ---
    const badge = document.getElementById('notification-badge');
    let hasReviewNotif = false;
    let hasScheduleNotif = false;

    function updateGlobalBadge() {
        if (hasReviewNotif || hasScheduleNotif) {
            if (badge) badge.style.display = 'block';
        } else {
            if (badge) badge.style.display = 'none';
        }
    }
    async function checkPendingReviews() {
        if (localStorage.getItem('hasReadReviews') === 'true') {
            hasReviewNotif = false;
            return;
        }
        try {
            await new Promise(r => setTimeout(r, 200));
            const mockReviews = { "count": 1 };
            if (mockReviews.count > 0) {
                hasReviewNotif = true;
            }
        } catch (error) { console.error("후기 알림 요청 중 오류:", error); }
    }
    async function checkUpcomingSchedules() {
        if (localStorage.getItem('hasReadSchedules') === 'true') {
            hasScheduleNotif = false;
            return;
        }
        try {
            await new Promise(r => setTimeout(r, 500));
            const mockSchedules = [ { id: 1, date: "2025-11-01" } ];
            if (mockSchedules.length > 0) {
                hasScheduleNotif = true;
            }
        } catch (error) { console.error("일정 요청 중 오류 발생:", error); }
    }

    // ▼▼▼ [수정] 커뮤니티 페이지 로직 ▼▼▼

    const postListBody = document.getElementById('post-list-body');
    const tabsContainer = document.getElementById('community-tabs');
    const writeButton = document.getElementById('write-post-btn');
    const searchExecBtn = document.getElementById('search-exec-btn'); // ⭐⭐ 추가

    // (★수정★) 카테고리별 더미 데이터 (likeCount 제거 반영)
    const allPosts = [
        { id: 10, category: 'notice', categoryDisplay: '공지', title: '[필독] 공지사항 및 매너 점수 안내', writer: '관리자', date: '2025-10-25', commentCount: 3, viewCount: 1200 },
        { id: 9, category: 'team', categoryDisplay: '팀모집', title: '일요 새벽 경기 인원 모집 (MF 급구)', writer: '캡틴손', date: '2025-10-31', commentCount: 12, viewCount: 150 },
        { id: 7, category: 'free', categoryDisplay: '자유', title: '이번 주말 풋살화 추천 받아요', writer: '풋살매니아', date: '2025-10-28', commentCount: 2, viewCount: 80 },
    ];

    /**
     * 목록 렌더링 함수
     */
    function renderPostList(category, searchKeyword = '', searchType = 'title') {
        let filteredPosts;
        if (category === 'all') {
            filteredPosts = allPosts;
        } else {
            filteredPosts = allPosts.filter(post => post.category === category);
        }

        // ⭐⭐ 검색 필터링 로직 ⭐⭐
        if (searchKeyword) {
            const keyword = searchKeyword.toLowerCase();
            filteredPosts = filteredPosts.filter(post => {
                if (searchType === 'title' && post.title.toLowerCase().includes(keyword)) return true;
                if (searchType === 'writer' && post.writer.toLowerCase().includes(keyword)) return true;
                return false;
            });
        }
        // ⭐⭐ 검색 필터링 로직 끝 ⭐⭐

        postListBody.innerHTML = '';

        if (filteredPosts.length === 0) {
            postListBody.innerHTML = `
                <tr>
                    <td colspan="7" style="text-align: center; color: #999; padding: 50px;">
                        검색 조건에 맞는 게시글이 없습니다.
                    </td>
                </tr>
            `;
            return;
        }

        // 목록 생성 및 번호(1, 2, 3...) 매기기
        filteredPosts.forEach((post, index) => {
            const row = document.createElement('tr');
            row.dataset.postId = post.id;
            row.innerHTML = `
                <td>${index + 1}</td>
                <td class="col-category">${post.categoryDisplay}</td>
                <td class="col-title" onclick="location.href='/community/detail/${post.id}'">${post.title}</td>
                <td>${post.commentCount}</td>
                <td>${post.writer}</td>
                <td>${post.date}</td>
                <td>${post.viewCount}</td>
            `;
            postListBody.appendChild(row);
        });
    }

    // ⭐⭐ 검색 실행 함수 ⭐⭐
    if (searchExecBtn) {
        searchExecBtn.addEventListener('click', () => {
            const activeTab = document.querySelector('.board-tabs button.active');
            const category = activeTab ? activeTab.dataset.category : 'all';
            const keyword = document.getElementById('search-keyword').value;
            const type = document.getElementById('search-type').value;

            renderPostList(category, keyword, type);
        });
    }

    // --- (★페이지별★) 로직 실행 ---
    document.addEventListener('DOMContentLoaded', async () => {
        const accessToken = localStorage.getItem('accessToken');
        const currentPath = window.location.pathname;

        // ⭐⭐ 회원 전용 페이지 접근 차단 로직 ⭐⭐
        if (!accessToken) {
            alert("❌ 회원 전용 페이지입니다.\n로그인 후에 이용하실 수 있습니다.");
            localStorage.setItem('redirectAfterLogin', currentPath);
            window.location.href = '/login';
            return;
        }

        // 1. 로그인 상태에 따른 UI 및 알림 배지 처리
        if (accessToken) {
            // ... (UI 표시 로직 유지) ...
            if (writeButton) writeButton.style.display = 'inline-block';

        } else {
            // ... (비회원 UI 숨김 로직 유지) ...
        }

        // 2. 카테고리 탭 이벤트 리스너 설정
        const tabs = tabsContainer.querySelectorAll('button');

        tabs.forEach(tab => {
            tab.addEventListener('click', () => {
                tabs.forEach(t => t.classList.remove('active'));
                tab.classList.add('active');

                const category = tab.dataset.category;
                // 탭 변경 시 검색 필드 초기화 후 렌더링
                document.getElementById('search-keyword').value = '';
                renderPostList(category);
            });
        });

        // 3. (★) 초기 로드 시 "전체 목록" 표시
        renderPostList('all');

        // 4. (★) 게시글 클릭 시 상세 페이지 이동 리스너 등록
        document.querySelectorAll('.post-table').forEach(table => {
            table.addEventListener('click', function(e) {
                const titleCell = e.target.closest('.col-title');
                if (titleCell) {
                    const postId = titleCell.closest('tr').dataset.postId;
                    location.href = `/community/detail/${postId}`;
                }
            });
        });
    });
</script>

</body>
</html>