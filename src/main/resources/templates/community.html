<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Multi FC - ì»¤ë®¤ë‹ˆí‹°</title>

    <link rel="stylesheet" th:href="@{/css/style.css}">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700;900&family=Noto+Sans+KR:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">

    <style>
        /* (style íƒœê·¸ ë‚´ìš©ì€ ì´ì „ê³¼ ë™ì¼) */
        .community-main {
            padding: 100px 40px 40px 40px;
            background-color: #f7f7f7;
            min-height: 100vh;
        }
        .board-container {
            max-width: 1000px;
            margin: 0 auto;
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        }

        .board-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            border-bottom: 2px solid #eee;
            padding-bottom: 10px;
        }
        .board-tabs {
            display: flex;
            flex-grow: 1;
        }
        .board-tabs button {
            background: none;
            border: none;
            padding: 10px 15px;
            font-size: 16px;
            font-weight: 600;
            color: #777;
            border-bottom: 2px solid transparent;
            cursor: pointer;
            transition: color 0.2s, border-bottom 0.2s;
            margin-right: 5px;
        }
        .board-tabs button.active {
            color: #6c5ce7;
            border-bottom-color: #6c5ce7;
        }
        .write-button {
            padding: 8px 15px;
            background-color: #6c5ce7;
            color: white;
            font-weight: 600;
            border-radius: 8px;
            text-decoration: none;
            transition: background-color 0.3s;
            white-space: nowrap;
        }
        .write-button:hover {
            background-color: #8e44ad;
        }
        /* â­â­ ì¶”ê°€ëœ ìŠ¤íƒ€ì¼: ê²€ìƒ‰ ì„¹ì…˜ â­â­ */
        .search-area {
            display: flex;
            gap: 10px;
            margin-top: 20px;
            justify-content: flex-end;
        }
        .search-area select, .search-area input[type="text"] {
            padding: 8px 10px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
        }
        .search-area button {
            padding: 8px 15px;
            background-color: #2c3e50;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
        }

        /* ê²Œì‹œê¸€ ëª©ë¡ í…Œì´ë¸” */
        .post-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 25px;
        }
        .post-table th, .post-table td {
            padding: 12px 10px;
            text-align: center;
            border-bottom: 1px solid #eee;
            font-size: 14px;
        }
        .post-table th {
            background-color: #f8f8f8;
            font-weight: 700;
            color: #555;
        }
        .post-table td {
            color: #333;
        }
        .post-table .col-title {
            text-align: left;
            font-weight: 600;
            cursor: pointer;
            transition: color 0.2s;
        }
        .post-table .col-title:hover {
            color: #6c5ce7;
        }
        .col-category {
            color: #6c5ce7;
        }

        /* í˜ì´ì§€ë„¤ì´ì…˜ */
        .pagination {
            text-align: center;
            margin-top: 30px;
        }
        .pagination a {
            padding: 5px 10px;
            margin: 0 3px;
            border: 1px solid #ddd;
            border-radius: 5px;
            text-decoration: none;
            color: #555;
        }
        .pagination a.active {
            background-color: #6c5ce7;
            color: white;
            border-color: #6c5ce7;
        }
    </style>
</head>
<body>

<header class="quick-menu">
    <div class="logo"><a href="/">Multi FC</a></div>
    <div class="header-icons">
        <button id="profile-menu-toggle" class="profile-icon" style="position: relative;">
            <i class="fas fa-user-circle"></i>
            <span id="notification-badge" class="notification-badge"></span>
        </button>
        <div id="profile-menu" class="user-menu">
            <div class="user-info">
                <strong><span id="user-menu-username">ì‚¬ìš©ì</span>ë‹˜</strong>
                <p>í™˜ì˜í•©ë‹ˆë‹¤!</p>
            </div>
            <ul>
                <li><a href="/notifications" id="nav-notifications-link"><i class="fas fa-bell"></i> ì•Œë¦¼ ëª©ë¡</a></li>
                <li><a href="/mypage"><i class="fas fa-user"></i> ë§ˆì´í˜ì´ì§€</a></li>
                <li><a href="/profile/edit"><i class="fas fa-user-edit"></i> í”„ë¡œí•„ ìˆ˜ì •</a></li>
                <li><a href="#" id="logout-button"><i class="fas fa-sign-out-alt"></i> ë¡œê·¸ì•„ì›ƒ</a></li>
            </ul>
        </div>
        <button id="menu-toggle" class="menu-toggle-btn"><i class="fas fa-bars"></i></button>
    </div>

    <nav id="main-menu" class="main-nav">
        <ul>
            <li><a href="/" class="active"><i class="fas fa-home"></i> ë©”ì¸ (Home)</a></li>
            <li><a href="/fields"><i class="fas fa-search"></i> êµ¬ì¥ê²€ìƒ‰</a></li>
            <li><a href="/community" ><i class="fas fa-users"></i> ì»¤ë®¤ë‹ˆí‹°</a></li>
            <li id="nav-chat-link-li"><a href="/chat" id="nav-chat-link"><i class="fas fa-comments"></i> ì‹¤ì‹œê°„ì±„íŒ…</a></li>
            <li><a href="/login" id="nav-login-link"><i class="fas fa-sign-in-alt"></i> ë¡œê·¸ì¸</a></li>
            <li><a href="#" id="nav-logout-link"><i class="fas fa-sign-out-alt"></i> ë¡œê·¸ì•„ì›ƒ</a></li>
        </ul>
    </nav>
</header>

<main class="community-main">
    <div class="board-container">
        <div class="board-controls">
            <div class="board-tabs" id="community-tabs">
                <button data-category="all" class="active">ì „ì²´ ëª©ë¡</button>
                <button data-category="notice">ê³µì§€ì‚¬í•­</button>
                <button data-category="free">ììœ ê²Œì‹œíŒ</button>
                <button data-category="team">íŒ€ì›ëª¨ì§‘</button>
            </div>
            <a href="/community/write" class="write-button" id="write-post-btn">
                <i class="fas fa-pencil-alt"></i> ê¸€ì“°ê¸°
            </a>
        </div>

        <div class="search-area">
            <select id="search-type">
                <option value="title">ì œëª©</option>
                <option value="content">ë‚´ìš©</option>
                <option value="writer">ì‘ì„±ì</option>
            </select>
            <input type="text" id="search-keyword" placeholder="ê²€ìƒ‰ì–´ë¥¼ ì…ë ¥í•˜ì„¸ìš”">
            <button id="search-exec-btn"><i class="fas fa-search"></i> ê²€ìƒ‰</button>
        </div>
        <table class="post-table">
            <thead>
            <tr>
                <th style="width: 8%;">ë²ˆí˜¸</th>
                <th style="width: 10%;">ì¹´í…Œê³ ë¦¬</th>
                <th style="width: 45%;">ì œëª©</th> <th style="width: 10%;"><i class="fas fa-comment-dots" title="ëŒ“ê¸€ ìˆ˜"></i></th>
                <th style="width: 12%;">ì‘ì„±ì</th>
                <th style="width: 15%;">ë‚ ì§œ</th>
                <th style="width: 7%;"><i class="fas fa-eye"></i></th>
            </tr>
            </thead>
            <tbody id="post-list-body">
            </tbody>
        </table>

        <div class="pagination" id="community-pagination">
            <a href="#">&lt;</a>
            <a href="#" class="active">1</a>
            <a href="#">2</a>
            <a href="#">3</a>
            <a href="#">&gt;</a>
        </div>
    </div>
</main>

<script>
    const menuToggle = document.getElementById('menu-toggle');
    const mainMenu = document.getElementById('main-menu');
    const profileMenuToggle = document.getElementById('profile-menu-toggle');
    const profileMenu = document.getElementById('profile-menu');
    const logoutButton = document.getElementById('logout-button');
    const navNotificationsLink = document.getElementById('nav-notifications-link');

    // í˜¹ì‹œ ë‚˜ì¤‘ì— login/logout ë©”ë‰´ë¥¼ navì— ë‹¤ì‹œ ë„£ì„ ê²½ìš° ëŒ€ë¹„
    const navLoginLink = document.getElementById('nav-login-link');
    const navLogoutLink = document.getElementById('nav-logout-link');

    // í–„ë²„ê±° ë²„íŠ¼ â†’ ë©”ì¸ ë©”ë‰´ ì—´ê¸°/ë‹«ê¸°
    if (menuToggle) {
        menuToggle.addEventListener('click', () => {
            if (mainMenu) mainMenu.classList.toggle('show');
            if (profileMenu) profileMenu.classList.remove('show');
        });
    }

    // í”„ë¡œí•„ ì•„ì´ì½˜ â†’ í”„ë¡œí•„ ë©”ë‰´ ì—´ê¸°/ë‹«ê¸°
    if (profileMenuToggle) {
        profileMenuToggle.addEventListener('click', () => {
            if (profileMenu) profileMenu.classList.toggle('show');
            if (mainMenu) mainMenu.classList.remove('show');
        });
    }

    // í—¤ë” ë°– í´ë¦­ ì‹œ ë‘˜ ë‹¤ ë‹«ê¸°
    document.addEventListener('click', (event) => {
        const header = document.querySelector('header');
        if (!header.contains(event.target)) {
            if (mainMenu) mainMenu.classList.remove('show');
            if (profileMenu) profileMenu.classList.remove('show');
        }
    });

    // ë¡œê·¸ì•„ì›ƒ (í”„ë¡œí•„ ë©”ë‰´ ì•ˆ)
    if (logoutButton) {
        logoutButton.addEventListener('click', (e) => {
            e.preventDefault();
            localStorage.removeItem('accessToken');
            localStorage.removeItem('hasReadReviews');
            localStorage.removeItem('hasReadSchedules');
            window.location.href = '/login';
        });
    }

    // ë¡œê·¸ì•„ì›ƒ (navì— ë”°ë¡œ ìˆì„ ê²½ìš°)
    if (navLogoutLink) {
        navLogoutLink.addEventListener('click', (e) => {
            e.preventDefault();
            localStorage.removeItem('accessToken');
            localStorage.removeItem('hasReadReviews');
            localStorage.removeItem('hasReadSchedules');
            window.location.href = '/login';
        });
    }

    // ì•Œë¦¼ ë©”ë‰´ í´ë¦­ ì‹œ
    if (navNotificationsLink) {
        navNotificationsLink.addEventListener('click', (e) => {
            e.preventDefault();
            localStorage.setItem('hasReadReviews', 'true');
            window.location.href = '/notifications';
        });
    }

    /* ============================
       (2) ì•Œë¦¼ ë°°ì§€ í‘œì‹œ í•¨ìˆ˜
       ============================ */
    function updateGlobalBadge() {
        const hasNew = localStorage.getItem('hasNewNotification') === 'true';
        const badge = document.getElementById('notification-badge');
        if (badge) badge.style.display = hasNew ? 'block' : 'none';
    }

    updateGlobalBadge();

    /* ============================
       (3) ë”ë¯¸ ì´ˆê¸° ê²Œì‹œê¸€ ë°ì´í„°
       ============================ */
    const initialPosts = [
        { id: 1000, category: 'notice', categoryDisplay: 'ê³µì§€', title: '[í•„ë…] ê³µì§€ì‚¬í•­ ë° ë§¤ë„ˆ ì ìˆ˜ ì•ˆë‚´', writer: 'ê´€ë¦¬ì', date: '2025-10-25', commentCount: 3, viewCount: 1200 },
        { id: 999, category: 'team', categoryDisplay: 'íŒ€ëª¨ì§‘', title: 'ì¼ìš” ìƒˆë²½ ê²½ê¸° ì¸ì› ëª¨ì§‘ (MF ê¸‰êµ¬)', writer: 'ìº¡í‹´ì†', date: '2025-10-31', commentCount: 12, viewCount: 150 },
        { id: 998, category: 'free', categoryDisplay: 'ììœ ', title: 'ì´ë²ˆ ì£¼ë§ í’‹ì‚´í™” ì¶”ì²œ ë°›ì•„ìš”', writer: 'í’‹ì‚´ë§¤ë‹ˆì•„', date: '2025-10-28', commentCount: 2, viewCount: 80 },
    ];

    /* ============================
       (4) ì»¤ë®¤ë‹ˆí‹° ëª©ë¡ / ê²€ìƒ‰ / í˜ì´ì§•
       ============================ */
    const postListBody = document.getElementById('post-list-body');
    const tabsContainer = document.getElementById('community-tabs');
    const writeButton = document.getElementById('write-post-btn');
    const searchExecBtn = document.getElementById('search-exec-btn');
    const paginationContainer = document.getElementById('community-pagination');

    const POSTS_PER_PAGE = 10;
    let allFilteredPosts = [];

    // ë¡œì»¬ìŠ¤í† ë¦¬ì§€ + ì´ˆê¸°ë°ì´í„° í†µí•©
    function getAllPosts() {
        let localPostsRaw = [];
        try {
            const storedData = localStorage.getItem('community_posts');
            if (storedData) {
                localPostsRaw = JSON.parse(storedData);
            }
        } catch (e) {
            console.error("Local Storage data corrupted, reset. Error:", e);
            localStorage.removeItem('community_posts');
            localPostsRaw = [];
        }

        const localPosts = localPostsRaw.map(post => ({
            ...post,
            id: String(post.id),
            commentCount: post.commentCount || 0,
            viewCount: post.viewCount || 0,
            categoryDisplay:
                post.categoryDisplay ||
                (post.category === 'notice'
                    ? 'ê³µì§€'
                    : post.category === 'free'
                        ? 'ììœ '
                        : 'íŒ€ëª¨ì§‘')
        }));

        const combinedPosts = [...localPosts];

        // ì´ˆê¸° ë°ì´í„° ì¤‘, ë¡œì»¬ì— ì—†ëŠ” ê²ƒë§Œ ì¶”ê°€
        initialPosts.forEach(initialPost => {
            if (!localPosts.some(p => String(p.id) === String(initialPost.id))) {
                combinedPosts.push({ ...initialPost, id: String(initialPost.id) });
            }
        });

        // ID ë‚´ë¦¼ì°¨ìˆœ ì •ë ¬
        combinedPosts.sort((a, b) => parseInt(b.id) - parseInt(a.id));
        return combinedPosts;
    }

    // í˜ì´ì§€ë„¤ì´ì…˜ ë Œë”ë§
    function renderPagination(totalPosts, currentPage) {
        const totalPages = Math.ceil(totalPosts / POSTS_PER_PAGE);
        paginationContainer.innerHTML = '';

        if (totalPages <= 1) return;

        const pagesPerGroup = 10;
        const currentGroup = Math.ceil(currentPage / pagesPerGroup);
        const startPage = (currentGroup - 1) * pagesPerGroup + 1;
        const endPage = Math.min(startPage + pagesPerGroup - 1, totalPages);

        const prevPage = currentPage > 1 ? currentPage - 1 : 1;
        const prevDisabled = currentPage === 1;
        paginationContainer.innerHTML += `<a href="#" data-page="${prevPage}" class="${prevDisabled ? 'disabled' : ''}">&lt;</a>`;

        for (let i = startPage; i <= endPage; i++) {
            paginationContainer.innerHTML += `<a href="#" data-page="${i}" class="${i === currentPage ? 'active' : ''}">${i}</a>`;
        }

        const nextPage = currentPage < totalPages ? currentPage + 1 : totalPages;
        const nextDisabled = currentPage === totalPages;
        paginationContainer.innerHTML += `<a href="#" data-page="${nextPage}" class="${nextDisabled ? 'disabled' : ''}">&gt;</a>`;

        paginationContainer.querySelectorAll('a').forEach(link => {
            if (!link.classList.contains('disabled')) {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    const newPage = parseInt(e.target.dataset.page);
                    if (newPage > 0 && newPage <= totalPages) {
                        const activeTab = document.querySelector('.board-tabs button.active');
                        const category = activeTab ? activeTab.dataset.category : 'all';
                        const keyword = document.getElementById('search-keyword').value;
                        const type = document.getElementById('search-type').value;
                        renderPostList(category, keyword, type, newPage);
                    }
                });
            }
        });
    }

    // ê²Œì‹œê¸€ ëª©ë¡ ë Œë”ë§
    function renderPostList(category, searchKeyword = '', searchType = 'title', page = 1) {
        const allPosts = getAllPosts();
        let filtered = allPosts;

        if (category !== 'all') {
            filtered = filtered.filter(post => String(post.category) === String(category));
        }

        if (searchKeyword) {
            const keyword = searchKeyword.toLowerCase();
            filtered = filtered.filter(post => {
                if (searchType === 'title' && post.title.toLowerCase().includes(keyword)) return true;
                if (searchType === 'writer' && post.writer.toLowerCase().includes(keyword)) return true;
                // content ê²€ìƒ‰ì€ ì‹¤ì œë¡œ contentë¥¼ ê°€ì§€ê³  ìˆì„ ë•Œë§Œ ê°€ëŠ¥ (ì§€ê¸ˆì€ ëª©ë¡ì—ì„œ ì‚¬ìš© X)
                return false;
            });
        }

        allFilteredPosts = filtered;
        const totalPosts = allFilteredPosts.length;

        const startIndex = (page - 1) * POSTS_PER_PAGE;
        const postsToDisplay = allFilteredPosts.slice(startIndex, startIndex + POSTS_PER_PAGE);

        postListBody.innerHTML = '';

        if (totalPosts === 0) {
            postListBody.innerHTML = `
                <tr>
                    <td colspan="7" style="text-align: center; color: #999; padding: 50px;">
                        ê²Œì‹œê¸€ì´ ì—†ìŠµë‹ˆë‹¤.
                    </td>
                </tr>
            `;
            renderPagination(0, 1);
            return;
        }

        postsToDisplay.forEach((post, index) => {
            const row = document.createElement('tr');
            row.dataset.postId = post.id;

            const sequentialId = startIndex + index + 1;

            row.innerHTML = `
                <td>${sequentialId}</td>
                <td class="col-category">${post.categoryDisplay}</td>
                <td class="col-title">${post.title}</td>
                <td>${post.commentCount}</td>
                <td>${post.writer}</td>
                <td>${post.date}</td>
                <td>${post.viewCount}</td>
            `;
            postListBody.appendChild(row);
        });

        renderPagination(totalPosts, page);
    }

    // ê²€ìƒ‰ ë²„íŠ¼
    if (searchExecBtn) {
        searchExecBtn.addEventListener('click', () => {
            const activeTab = document.querySelector('.board-tabs button.active');
            const category = activeTab ? activeTab.dataset.category : 'all';
            const keyword = document.getElementById('search-keyword').value;
            const type = document.getElementById('search-type').value;
            renderPostList(category, keyword, type, 1);
        });
    }

    document.addEventListener('DOMContentLoaded', () => {
        const accessToken = localStorage.getItem('accessToken');
        const profileIcon = document.getElementById('profile-menu-toggle');
        const userMenuName = document.getElementById('user-menu-username');

        // ğŸ”’ íšŒì› ì „ìš© í˜ì´ì§€: ë¹„ë¡œê·¸ì¸ ì‹œ ë§‰ê³  ë¡œê·¸ì¸ìœ¼ë¡œ ë³´ëƒ„
        if (!accessToken) {
            alert("âŒ íšŒì› ì „ìš© í˜ì´ì§€ì…ë‹ˆë‹¤.\në¡œê·¸ì¸ í›„ ì´ìš© ê°€ëŠ¥í•©ë‹ˆë‹¤.");
            localStorage.setItem('redirectAfterLogin', window.location.pathname);
            window.location.href = '/login';
            return;
        }

        // âœ… ë¡œê·¸ì¸ ìƒíƒœ UI
        if (profileIcon) profileIcon.style.display = 'flex';
        if (userMenuName) userMenuName.textContent = localStorage.getItem('username') || 'ì‚¬ìš©ì';

        // ë§Œì•½ navì— ë¡œê·¸ì¸/ë¡œê·¸ì•„ì›ƒ ë²„íŠ¼ì´ ìˆë‹¤ë©´ í† ê¸€ (ì—†ìœ¼ë©´ ê·¸ëƒ¥ ë¬´ì‹œë¨)
        if (navLoginLink && navLoginLink.parentElement) {
            navLoginLink.parentElement.style.display = 'none';
        }
        if (navLogoutLink && navLogoutLink.parentElement) {
            navLogoutLink.parentElement.style.display = 'list-item';
        }

        // ì•Œë¦¼ ë°°ì§€ ì´ˆê¸° í‘œì‹œ + ìŠ¤í† ë¦¬ì§€ ë³€ê²½ ì‹œ ë°˜ì˜
        updateGlobalBadge();
        window.addEventListener('storage', (e) => {
            if (e.key === 'hasNewNotification') updateGlobalBadge();
        });

        // ì¹´í…Œê³ ë¦¬ íƒ­ í´ë¦­ ì´ë²¤íŠ¸
        const tabs = tabsContainer.querySelectorAll('button');
        tabs.forEach(tab => {
            tab.addEventListener('click', () => {
                tabs.forEach(t => t.classList.remove('active'));
                tab.classList.add('active');
                document.getElementById('search-keyword').value = '';
                renderPostList(tab.dataset.category, '', 'title', 1);
            });
        });

        // ì´ˆê¸° ë¡œë“œ: ì „ì²´ ëª©ë¡
        renderPostList('all');

        // ì œëª© í´ë¦­ â†’ ìƒì„¸ í˜ì´ì§€ ì´ë™
        document.querySelector('.post-table').addEventListener('click', (e) => {
            const titleCell = e.target.closest('.col-title');
            if (!titleCell) return;
            const postId = titleCell.closest('tr').dataset.postId;
            location.href = `/community/detail/${postId}`;
        });
    });
</script>

</body>
</html>