<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Multi FC - 로그인</title>
    <link rel="stylesheet" th:href="@{/css/style.css?v=201}">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700;900&family=Noto+Sans+KR:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        /* 원래 CSS 복구 */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.6); display: flex;
            justify-content: center; align-items: center; z-index: 10000;
            display: none;
        }
        .modal-content {
            background: white; padding: 30px 40px; border-radius: 15px;
            text-align: center; box-shadow: 0 5px 20px rgba(0,0,0,0.2);
            max-width: 350px;
        }
        .modal-content h2 { font-size: 24px; color: #2c3e50; margin-bottom: 15px; }
        .modal-content p { font-size: 16px; color: #555; margin-bottom: 25px; line-height: 1.5; }
        .modal-content .login-button { width: 100%; margin-top: 10px; }

        /* 로그인 폼 스타일 보강 */
        .input-group { margin-bottom: 15px; }
        .input-group label { display: block; margin-bottom: 5px; font-weight: bold; }
        .input-with-icon { position: relative; }
        .input-with-icon input { width: 100%; padding: 10px 10px 10px 35px; border: 1px solid #ddd; border-radius: 5px; box-sizing: border-box; }
        .input-icon { position: absolute; left: 10px; top: 50%; transform: translateY(-50%); color: #888; }
        .toggle-password { position: absolute; right: 10px; top: 50%; transform: translateY(-50%); cursor: pointer; color: #888; }
        .login-button { width: 100%; padding: 12px; background-color: #333; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 16px; font-weight: bold; }
        .login-button:hover { background-color: #111; }
        .social-login { display: flex; justify-content: center; gap: 10px; margin-top: 20px; }
        .social-btn { width: 40px; height: 40px; border-radius: 50%; border: 1px solid #ddd; background: white; cursor: pointer; display: flex; align-items: center; justify-content: center; }
    </style>
</head>
<body>

<header class="quick-menu">
    <div class="logo"> <a href="/">Multi FC</a> </div>
    <div class="header-icons">
        <a href="/login" id="nav-login-link" class="active" style="font-weight:bold; color:#333; margin-right:10px;">로그인</a>
        <button id="menu-toggle" class="menu-toggle-btn"> <i class="fas fa-bars"></i> </button>
    </div>
    <nav id="main-menu" class="main-nav">
        <ul>
            <li><a href="/"><i class="fas fa-home"></i> 메인 (Home)</a></li>
            <li><a href="/fields"><i class="fas fa-search"></i> 구장검색</a></li>
            <li><a href="/community"><i class="fas fa-users"></i> 커뮤니티</a></li>
            <li><a href="/chat"><i class="fas fa-comments"></i> 실시간채팅</a></li>
        </ul>
    </nav>
</header>

<main class="login-page-main">
    <div class="main-wrapper" style="display: flex; justify-content: center; padding-top: 50px;">
        <div class="login-section">
            <div class="login-container" style="width: 400px; background: #fff; padding: 40px; border-radius: 10px; box-shadow: 0 0 20px rgba(0,0,0,0.1);">
                <h1 class="title-login" style="text-align: center; margin-bottom: 30px;">Login</h1>
                <p id="error-message" class="error-message" style="display:none; color:red; margin-bottom:15px; text-align:center;"></p>

                <form id="login-form">
                    <div class="input-group">
                        <label for="username">User name</label>
                        <div class="input-with-icon">
                            <i class="fas fa-user input-icon"></i>
                            <input type="text" id="username" name="username" placeholder="아이디를 입력하세요" required>
                        </div>
                    </div>
                    <div class="input-group">
                        <label for="password">Password</label>
                        <div class="password-wrapper input-with-icon">
                            <i class="fas fa-lock input-icon"></i>
                            <input type="password" id="password" name="password" placeholder="********" required>
                            <i class="fas fa-eye-slash toggle-password"></i>
                        </div>
                    </div>
                    <div class="forgot-remember" style="display: flex; justify-content: space-between; margin-bottom: 20px; font-size: 14px;">
                        <div class="remember-me">
                            <input type="checkbox" id="remember-me">
                            <label for="remember-me">Remember me</label>
                        </div>
                        <a href="/forgot-password" class="forgot-password" style="color: #6c5ce7;">Forgot?</a>
                    </div>
                    <button type="submit" class="login-button">Login</button>
                    <div class="signup-link" style="text-align: center; margin-top: 15px; font-size: 14px;">
                        Don't have an account? <a href="/register" style="color: #6c5ce7; font-weight: bold;">Sign up</a>
                    </div>
                </form>

                <p style="text-align: center; font-size: 14px; color: #555; font-weight: 500; margin-top: 30px;">Social Login</p>
                <div class="social-login">
                    <button class="social-btn google"><i class="fab fa-google"></i></button>
                    <button class="social-btn kakao" style="background-color: #FEE500; color: #191919;"><i class="fas fa-comment"></i></button>
                </div>
            </div>
        </div>
    </div>
</main>

<div id="login-success-modal" class="modal-overlay">
    <div class="modal-content">
        <h2>로그인 성공</h2>
        <p>환영합니다! ⚽<br>메인 페이지로 이동합니다.</p>
        <button id="modal-confirm-btn" class="login-button">확인</button>
    </div>
</div>

<script>
    // 메뉴 토글
    const menuToggle = document.getElementById('menu-toggle');
    const mainMenu = document.getElementById('main-menu');
    if (menuToggle) {
        menuToggle.addEventListener('click', () => mainMenu.classList.toggle('show'));
    }

    // Remember me
    document.addEventListener('DOMContentLoaded', () => {
        const savedUsername = localStorage.getItem('saved_username');
        if (savedUsername) {
            document.getElementById('username').value = savedUsername;
            document.getElementById('remember-me').checked = true;
        }
    });

    // 비밀번호 보기/숨기기
    document.querySelectorAll('.toggle-password').forEach(icon => {
        icon.addEventListener('click', function() {
            const passwordInput = this.parentElement.querySelector('input');
            const type = passwordInput.getAttribute('type') === 'password' ? 'text' : 'password';
            passwordInput.setAttribute('type', type);
            this.classList.toggle('fa-eye');
            this.classList.toggle('fa-eye-slash');
        });
    });

    // 로그인 로직 (수정됨)
    const loginForm = document.getElementById('login-form');
    const errorMsg = document.getElementById('error-message');
    const successModal = document.getElementById('login-success-modal');

    loginForm.addEventListener('submit', async function(e) {
        e.preventDefault();
        errorMsg.style.display = 'none';

        const username = document.getElementById('username').value.trim();
        const password = document.getElementById('password').value.trim();

        try {
            const response = await fetch('/api/users/login', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ username, password }),
            });

            if (response.ok) {
                const data = await response.json();

                if (data.accessToken && data.user) {
                    // Remember Me 저장
                    if (document.getElementById('remember-me').checked) {
                        localStorage.setItem('saved_username', username);
                    } else {
                        localStorage.removeItem('saved_username');
                    }

                    // ★★★ 핵심: 데이터 저장 (이름 통일) ★★★
                    localStorage.setItem('accessToken', data.accessToken);
                    localStorage.setItem('userId', data.user.userId);         // 숫자 ID
                    localStorage.setItem('userNickname', data.user.nickname); // 닉네임

                    successModal.style.display = 'flex';
                    document.getElementById('modal-confirm-btn').onclick = function() {
                        window.location.href = '/';
                    };
                } else {
                    errorMsg.textContent = '회원 정보를 불러올 수 없습니다.';
                    errorMsg.style.display = 'block';
                }
            } else {
                errorMsg.textContent = '아이디 또는 비밀번호가 일치하지 않습니다.';
                errorMsg.style.display = 'block';
            }
        } catch (error) {
            console.error(error);
            errorMsg.textContent = '서버 오류 발생';
            errorMsg.style.display = 'block';
        }
    });
</script>
</body>
</html>