<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MULTI FC - íšŒì›ê°€ì…</title>

    <link rel="stylesheet" th:href="@{/css/style.css}">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700;900&family=Noto+Sans+KR:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">

    <style>
        .input-group.address-group { display: flex; gap: 10px; align-items: flex-end; }
        .input-group.address-group .input-wrapper { flex-grow: 1; }
        .address-group button { padding: 12px 15px; font-size: 14px; font-weight: 600; color: #fff; background: #95a5a6; border: none; border-radius: 10px; cursor: pointer; transition: background 0.3s; white-space: nowrap; min-width: 80px; }
        .address-group button:hover { background: #7f8c8d; }
        .modal-overlay { position: fixed; inset: 0; background: rgba(0, 0, 0, 0.5); display: none; justify-content: center; align-items: center; z-index: 9999; }
        .modal-overlay.show { display: flex; }
        .modal { background: #fff; max-width: 900px; width: 90%; max-height: 80vh; border-radius: 12px; box-shadow: 0 10px 30px rgba(0, 0, 0, 0.25); display: flex; flex-direction: column; overflow: hidden; }
        .modal-header { padding: 16px 20px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; }
        .modal-header h1 { margin: 0; font-size: 20px; }
        .modal-close-btn { background: none; border: none; font-size: 22px; cursor: pointer; }
        .modal-body { padding: 16px 20px; overflow-y: auto; }
        .modal-body h2 { margin-top: 24px; }
        .modal-body .clause { background: #f4f4f4; border: 1px solid #ddd; padding: 15px; margin-top: 10px; }
        .modal-footer { padding: 16px 20px; border-top: 1px solid #eee; text-align: center; }
        .agree-btn { padding: 12px 24px; font-size: 16px; font-weight: 600; border: none; border-radius: 8px; background: #6c5ce7; color: #fff; cursor: pointer; }
        .agree-btn:hover { background: #574bdb; }
        .terms-link { color: #3498db; text-decoration: underline; cursor: pointer; }

        .info-message {
            font-size: 13px !important;
            font-weight: 500 !important;
            margin-top: 5px !important;
            display: none !important;
            min-height: 0 !important;
        }
        .info-message.success {
            color: #2ecc71 !important;
            display: block !important;
        }
        .info-message.error {
            color: #e74c3c !important;
            display: block !important;
        }
    </style>
</head>

<body>
<header class="quick-menu">
    <div class="logo"><a href="/">MULTI FC</a></div>
    <div class="header-icons">
        <button id="menu-toggle" class="menu-toggle-btn"><i class="fas fa-bars"></i></button>
    </div>
</header>

<main class="login-page-main">
    <div class="main-wrapper">
        <div class="main-section">
            <div class="login-container">
                <h1 class="title-login">Sign Up</h1>
                <p style="margin-bottom: 25px; font-size: 15px; color: #555;">
                    MULTI FC ê³„ì •ì„ ë§Œë“¤ê³  ë§¤ì¹˜ë¥¼ ì‹œì‘í•˜ì„¸ìš”.
                </p>

                <p id="error-message" class="error-message" style="display:none;"></p>

                <form id="register-form">

                    <div class="input-group">
                        <label for="email">ì´ë©”ì¼ (Email)</label>
                        <input type="email" id="email" name="email" placeholder="ë¹„ë°€ë²ˆí˜¸ ì°¾ê¸° ë“±ì— ì‚¬ìš©" required>
                        <p id="email-message" class="info-message"></p>
                    </div>

                    <div class="input-group">
                        <label for="username">ì•„ì´ë”” (User name)</label>
                        <input type="text" id="username" name="username" placeholder="5~20ì ì˜ë¬¸ ì†Œë¬¸ì, ìˆ«ì, (_)ë§Œ ì‚¬ìš©" required>
                        <p id="username-message" class="info-message"></p>
                    </div>

                    <div class="input-group">
                        <label for="nickname">ë‹‰ë„¤ì„</label>
                        <input type="text" id="nickname" name="nickname" placeholder="2~16ì í•œê¸€, ì˜ë¬¸, ìˆ«ì" required>
                        <p id="nickname-message" class="info-message"></p>
                    </div>

                    <div class="input-group">
                        <label for="password">ë¹„ë°€ë²ˆí˜¸</label>
                        <div class="password-wrapper">
                            <input type="password" id="password" name="password" placeholder="8ì ì´ìƒ, ì˜ë¬¸/ìˆ«ì/íŠ¹ìˆ˜ë¬¸ì ì¡°í•©" required pattern="^(?=.*[A-Za-z])(?=.*\d)(?=.*[@$!%*#?&])[A-Za-z\d@$!%*#?&]{8,}$">
                            <i class="fas fa-eye-slash toggle-password" data-target="password"></i>
                        </div>
                        <p id="password-message" class="info-message"></p>
                    </div>

                    <div class="input-group">
                        <label for="confirm-password">ë¹„ë°€ë²ˆí˜¸ í™•ì¸</label>
                        <div class="password-wrapper">
                            <input type="password" id="confirm-password" name="confirmPassword" placeholder="********" required>
                            <i class="fas fa-eye-slash toggle-password" data-target="confirm-password"></i>
                        </div>
                    </div>


                    <div class="input-group" style="display: flex; align-items: center; gap: 20px; margin-top: 5px;">
                        <label style="margin: 0; min-width: 100px; font-weight: 700; font-size: 20px;">
                            ì„±ë³„ (Gender)
                        </label>
                        <div style="display: flex; align-items: center; gap: 35px;  margin-top: 7px;">
                            <label style="display: inline-flex; align-items: center; gap: 6px; white-space: nowrap; font-size: 15px;">
                                <input type="radio" name="gender" value="ë‚¨ì„±" required style="accent-color: #6c5ce7; width: 18px; height: 18px;">
                                ë‚¨ì„± (M)
                            </label>
                            <label style="display: inline-flex; align-items: center; gap: 6px; white-space: nowrap; font-size: 15px;">
                                <input type="radio" name="gender" value="ì—¬ì„±" required style="accent-color: #e74c3c; width: 18px; height: 18px;">
                                ì—¬ì„± (F)
                            </label>
                        </div>
                    </div>

                    <div class="input-group">
                        <label for="position">ì„ í˜¸ í¬ì§€ì…˜</label>
                        <select id="position" name="position" style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 10px; font-size: 15px; background: #f7f7f7;">
                            <option value="ì „ì²´ (ALL)">ì „ì²´ (ALL)</option>
                            <option value="í”½ì†Œ (FIXO)">í”½ì†Œ (FIXO)</option>
                            <option value="ë¹„ë³´ (PIVO)">ë¹„ë³´ (PIVO)</option>
                            <option value="ì½œë ˆì´ë¡œ(GOLEIRO)">ì½œë ˆì´ë¡œ(GOLEIRO)</option>
                        </select>
                    </div>


                    <div class="input-group">
                        <label for="skill-level">ë‚˜ì˜ ì‹¤ë ¥ ë ˆë²¨</label>
                        <select id="skill-level" name="level" required style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 10px; font-size: 15px; background: #f7f7f7;">
                            <option value="">ì‹¤ë ¥ì„ ì„ íƒí•˜ì„¸ìš”</option>
                            <option value="ì´ˆê¸‰">ì´ˆê¸‰</option>
                            <option value="ì¤‘ê¸‰">ì¤‘ê¸‰</option>
                            <option value="ê³ ê¸‰">ê³ ê¸‰</option>
                        </select>
                    </div>

                    <div class="input-group address-group">
                        <div class="input-wrapper">
                            <label for="address">ì£¼ì†Œ</label>
                            <input type="text" id="address" name="address" placeholder="ì£¼ì†Œ ê²€ìƒ‰ ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”" required readonly>
                        </div>
                        <button type="button" onclick="searchAddress()">ì£¼ì†Œ ì°¾ê¸°</button>
                    </div>

                    <div class="input-group">
                        <input type="text" id="address-detail" placeholder="ìƒì„¸ ì£¼ì†Œë¥¼ ì…ë ¥í•˜ì„¸ìš” (ì˜ˆ: 101ë™ 1004í˜¸)">
                    </div>

                    <div class="input-group">
                        <label for="profile-pic">í”„ë¡œí•„ ì‚¬ì§„ (ì„ íƒ)</label>
                        <input type="file" id="profile-pic" name="profile_image_file" accept="image/*">
                    </div>

                    <div class="terms-agreement">
                        <input type="checkbox" id="terms-agree" name="termsAgree" value="true" required>
                        <label for="terms-agree">
                            <span id="open-terms-modal" class="terms-link">ì´ìš©ì•½ê´€</span>ì— ë™ì˜í•©ë‹ˆë‹¤. (í•„ìˆ˜)
                        </label>
                    </div>

                    <button type="submit" id="register-submit-btn" class="login-button" style="margin-top: 15px;" disabled>
                        Create Account (ëª¨ë“  í•­ëª© í™•ì¸ í•„ìš”)
                    </button>
                </form>

                <div class="back-to-login" style="margin-top: 20px;">
                    Already have an account? <a href="/login">Login</a>
                </div>
            </div>
        </div>
    </div>
</main>

<div id="terms-modal-overlay" class="modal-overlay">
    <div class="modal">
        <div class="modal-header">
            <h1>Multi FC ì´ìš©ì•½ê´€</h1>
            <button type="button" class="modal-close-btn" id="terms-modal-close">&times;</button>
        </div>
        <div class="modal-body">
            <h2>ì œ 1 ì¡° (ëª©ì )</h2>
            <div class="clause"><p>ë³¸ ì•½ê´€ì€ Multi FC(ì´í•˜ "íšŒì‚¬")ê°€ ì œê³µí•˜ëŠ” í’‹ì‚´ ë§¤ì¹­... (ì´í•˜ ìƒëµ)</p></div>
            <h2>ë¶€ì¹™</h2>
            <div class="clause"><p>ë³¸ ì•½ê´€ì€ <span id="terms-date"></span>ë¶€í„° ì ìš©ë©ë‹ˆë‹¤.</p></div>
        </div>
        <div class="modal-footer">
            <button type="button" class="agree-btn" id="terms-modal-agree">
                ìœ„ ì•½ê´€ ë‚´ìš©ì„ í™•ì¸í•˜ì˜€ìœ¼ë©°, ë™ì˜í•©ë‹ˆë‹¤.
            </button>
        </div>
    </div>
</div>
<script src="//t1.daumcdn.net/mapjsapi/bundle/postcode/prod/postcode.v2.js"></script>

<script>
    // ë¹„ë°€ë²ˆí˜¸ ë³´ê¸° í† ê¸€
    document.querySelectorAll('.toggle-password').forEach(icon => {
        icon.addEventListener('click', function() {
            const input = this.parentElement.querySelector('input');
            const type = input.getAttribute('type') === 'password' ? 'text' : 'password';
            input.setAttribute('type', type);
            this.classList.toggle('fa-eye');
            this.classList.toggle('fa-eye-slash');
        });
    });

    // Daum ìš°í¸ë²ˆí˜¸ ì„œë¹„ìŠ¤ ì—°ë™
    function searchAddress() {
        new daum.Postcode({
            oncomplete: function(data) {
                var addr = (data.userSelectedType === 'R') ? data.roadAddress : data.jibunAddress;
                if(data.userSelectedType === 'R' && data.bname !== '' && /[ë™|ë¡œ|ê°€]$/g.test(data.bname)){
                    addr += ' (' + data.bname + ')';
                }
                document.getElementById("address").value = addr;
                document.getElementById("address-detail").focus(); // ìƒì„¸ ì£¼ì†Œë¡œ í¬ì»¤ìŠ¤
            }
        }).open();
    }

    // íšŒì›ê°€ì… ë¡œì§
    document.addEventListener('DOMContentLoaded', () => {
        const registerForm = document.getElementById('register-form');
        const errorMsg = document.getElementById('error-message');
        const registerSubmitBtn = document.getElementById('register-submit-btn');

        // ì…ë ¥ í•„ë“œ
        const emailInput = document.getElementById('email');
        const usernameInput = document.getElementById('username');
        const nicknameInput = document.getElementById('nickname');
        const passwordInput = document.getElementById('password');
        const confirmPasswordInput = document.getElementById('confirm-password');
        const termsCheckbox = document.getElementById('terms-agree');

        // í”¼ë“œë°± ë©”ì‹œì§€ í•„ë“œ
        const emailMsg = document.getElementById('email-message');
        const usernameMsg = document.getElementById('username-message');
        const nicknameMsg = document.getElementById('nickname-message');
        const passwordMsg = document.getElementById('password-message');

        // ì•½ê´€ ëª¨ë‹¬ ê´€ë ¨
        const termsModalOverlay = document.getElementById('terms-modal-overlay');
        const openTermsModal = document.getElementById('open-terms-modal');
        const termsModalClose = document.getElementById('terms-modal-close');
        const termsModalAgree = document.getElementById('terms-modal-agree');
        const termsDateSpan = document.getElementById('terms-date');

        // ìœ íš¨ì„± ìƒíƒœ
        let validationStatus = {
            email: false,
            username: false,
            nickname: false,
            password: false,
            terms: false
        };

        // 1. ë²„íŠ¼ ìƒíƒœ ê´€ë¦¬ í•¨ìˆ˜
        function checkSubmitButtonState() {
            const allValid = Object.values(validationStatus).every(Boolean);
            registerSubmitBtn.disabled = !allValid;
            registerSubmitBtn.textContent = allValid ? 'Create Account' : 'ëª¨ë“  í•­ëª©ì„ í™•ì¸í•´ì£¼ì„¸ìš”';
        }

        // 2. UI í”¼ë“œë°± í•¨ìˆ˜
        function showFeedback(element, message, isError) {
            if (!element) return;
            element.textContent = message;
            element.className = isError ? 'info-message error' : 'info-message success';
            element.style.color = isError ? '#e74c3c' : '#2ecc71';
            element.style.display = "block";
        }
        function hideFeedback(element) {
            if (element) element.style.display = "none";
        }

        // 3. API ì¤‘ë³µ ì²´í¬
        let debounceTimer;
        async function validateField(field, value, messageElement, apiUrl, regex, regexMsg) {
            clearTimeout(debounceTimer);

            // 1. í˜•ì‹(Regex) ê²€ì‚¬
            if (!regex.test(value)) {
                showFeedback(messageElement, regexMsg, true);
                validationStatus[field] = false;
                checkSubmitButtonState();
                return;
            }

            // 2. ì¤‘ë³µ(API) ê²€ì‚¬
            debounceTimer = setTimeout(async () => {
                try {
                    const response = await fetch(`${apiUrl}?${field}=${encodeURIComponent(value)}`);
                    const isTaken = await response.json();

                    if (isTaken) {
                        showFeedback(messageElement, 'ì´ë¯¸ ì‚¬ìš© ì¤‘ì…ë‹ˆë‹¤.', true);
                        validationStatus[field] = false;
                    } else {
                        showFeedback(messageElement, 'ì‚¬ìš© ê°€ëŠ¥í•©ë‹ˆë‹¤.', false);
                        validationStatus[field] = true;
                    }
                } catch (e) {
                    showFeedback(messageElement, 'ì¤‘ë³µ í™•ì¸ ì¤‘ ì˜¤ë¥˜ ë°œìƒ.', true);
                    validationStatus[field] = false;
                }
                checkSubmitButtonState();
            }, 500);
        }

        // ì •ê·œì‹ ì œì•½ì¡°ê±´ ë° API ì—°ë™
        emailInput.addEventListener('input', () => {
            const regex = /^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$/;
            validateField('email', emailInput.value, emailMsg, '/api/users/check-email', regex, 'ì˜¬ë°”ë¥¸ ì´ë©”ì¼ í˜•ì‹ì´ ì•„ë‹™ë‹ˆë‹¤.');
        });
        usernameInput.addEventListener('input', () => {
            const regex = /^[a-z0-9_]{5,20}$/;
            validateField('username', usernameInput.value, usernameMsg, '/api/users/check-username', regex, '5~20ì ì˜ë¬¸ ì†Œë¬¸ì, ìˆ«ì, (_)ë§Œ ì‚¬ìš© ê°€ëŠ¥í•©ë‹ˆë‹¤.');
        });
        nicknameInput.addEventListener('input', () => {
            const regex = /^[ê°€-í£a-zA-Z0-9]{2,16}$/;
            validateField('nickname', nicknameInput.value, nicknameMsg, '/api/users/check-nickname', regex, '2~16ì í•œê¸€, ì˜ë¬¸, ìˆ«ìë§Œ ì‚¬ìš© ê°€ëŠ¥í•©ë‹ˆë‹¤.');
        });

        // 4. ë¹„ë°€ë²ˆí˜¸ ì¡°ê±´ ì‹¤ì‹œê°„ ê²€ì‚¬
        passwordInput.addEventListener('input', () => {
            const password = passwordInput.value;
            const regex = /^(?=.*[A-Za-z])(?=.*\d)(?=.*[@$!%*#?&])[A-Za-z\d@$!%*#?&]{8,}$/;

            if (regex.test(password)) {
                showFeedback(passwordMsg, 'ì•ˆì „í•œ ë¹„ë°€ë²ˆí˜¸ì…ë‹ˆë‹¤.', false);
                validationStatus.password = true;
            } else {
                showFeedback(passwordMsg, '8ì ì´ìƒ, ì˜ë¬¸/ìˆ«ì/íŠ¹ìˆ˜ë¬¸ì ì¡°í•©ì´ í•„ìš”í•©ë‹ˆë‹¤.', true);
                validationStatus.password = false;
            }
            checkSubmitButtonState();
        });

        // 5. ì•½ê´€ ëª¨ë‹¬ ë° ë™ì˜
        if (termsDateSpan) {
            const today = new Date();
            termsDateSpan.textContent = `${today.getFullYear()}ë…„ ${today.getMonth() + 1}ì›” ${today.getDate()}ì¼`;
        }
        openTermsModal.addEventListener('click', (e) => {
            e.preventDefault();
            termsModalOverlay.classList.add('show');
        });
        termsCheckbox.addEventListener('click', (e) => {
            e.preventDefault();
            termsModalOverlay.classList.add('show');
        });
        termsModalClose.addEventListener('click', () => {
            termsModalOverlay.classList.remove('show');
        });
        termsModalOverlay.addEventListener('click', (e) => {
            if (e.target === termsModalOverlay) {
                termsModalOverlay.classList.remove('show');
            }
        });
        termsModalAgree.addEventListener('click', () => {
            termsCheckbox.checked = true;
            validationStatus.terms = true;
            checkSubmitButtonState();
            termsModalOverlay.classList.remove('show');
        });

        // 6. íšŒì›ê°€ì… ì œì¶œ
        registerForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            errorMsg.style.display = 'none';

            // ìµœì¢… ìœ íš¨ì„± ê²€ì‚¬
            if (!Object.values(validationStatus).every(Boolean)) {
                errorMsg.textContent = 'âŒ ëª¨ë“  í•­ëª©ì„ ì˜¬ë°”ë¥´ê²Œ ì…ë ¥í•´ì£¼ì„¸ìš”.';
                errorMsg.style.display = 'block';
                return;
            }
            if (passwordInput.value !== confirmPasswordInput.value) {
                errorMsg.textContent = 'âŒ ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.';
                errorMsg.style.display = 'block';
                return;
            }

            // FormData ê°ì²´ ìƒì„±
            const formData = new FormData();

            // í…ìŠ¤íŠ¸ ë°ì´í„° ë‹´ê¸°
            formData.append('email', emailInput.value);
            formData.append('username', usernameInput.value);
            formData.append('nickname', nicknameInput.value);
            formData.append('password', passwordInput.value);
            formData.append('gender', document.querySelector('input[name="gender"]:checked').value);
            formData.append('position', document.getElementById('position').value);
            formData.append('level', document.getElementById('skill-level').value);

            // ì£¼ì†Œ í•©ì¹˜ê¸°
            const fullAddress = (document.getElementById('address').value + ' ' + document.getElementById('address-detail').value).trim();
            formData.append('address', fullAddress);

            // íŒŒì¼ ë°ì´í„° ë‹´ê¸°
            const profileFile = document.getElementById('profile-pic').files[0];
            if (profileFile) {
                formData.append('profile_image_file', profileFile);
            }

            try {
                registerSubmitBtn.textContent = 'ì²˜ë¦¬ ì¤‘...';
                registerSubmitBtn.disabled = true;

                //  /api/users/signup ìœ¼ë¡œ ì „ì†¡
                const response = await fetch('/api/users/signup', {
                    method: 'POST',
                    body: formData
                });

                if (response.ok) {
                    alert("ğŸ‰ íšŒì›ê°€ì… ì„±ê³µ! ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ ì´ë™í•©ë‹ˆë‹¤.");
                    window.location.href = '/login';
                } else {
                    const errorText = await response.text();
                    throw new Error(errorText || 'íšŒì›ê°€ì… ì‹¤íŒ¨');
                }
            } catch (error) {
                errorMsg.textContent = 'âŒ ' + error.message;
                errorMsg.style.display = 'block';
                registerSubmitBtn.textContent = 'Create Account';
                registerSubmitBtn.disabled = false;
            }
        });

        // ì´ˆê¸° ë²„íŠ¼ ìƒíƒœ ì„¤ì •
        checkSubmitButtonState();
    });
</script>
</body>
</html>