<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title th:text="'ê²½ê¸° ìƒì„¸ (ID: ' + ${matchId} + ') - MULTI FC'">MULTI FC - ì¼ì • ìƒì„¸</title>

    <link rel="stylesheet" th:href="@{/css/style.css}">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700;900&family=Noto+Sans+KR:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">

    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>

    <style>
        /* (ê¸°ì¡´ ìŠ¤íƒ€ì¼ ìœ ì§€) */
        .schedule-search-main {
            padding: 100px 40px 40px 40px;
            background-color: #f7f7f7;
            min-height: 100vh;
        }
        .search-container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        }
        .search-title {
            font-size: 28px;
            font-weight: 700;
            color: #2c3e50;
            margin-bottom: 25px;
            border-bottom: 2px solid #6c5ce7;
            padding-bottom: 10px;
        }
        .detail-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 30px;
        }
        @media (min-width: 768px) {
            .detail-grid {
                grid-template-columns: 1fr 350px;
            }
        }
        .map-area {
            width: 100%;
            height: 300px;
            background-color: #eee;
            border-radius: 10px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            color: #888;
        }
        .detail-info-item {
            display: flex;
            font-size: 16px;
            color: #333;
            margin-bottom: 15px;
            align-items: center;
        }
        .detail-info-item i {
            width: 30px;
            color: #6c5ce7;
            font-size: 18px;
        }
        .status-card {
            background: #f9f9f9;
            border: 1px solid #ddd;
            border-radius: 10px;
            padding: 20px;
        }
        .status-card h3 {
            font-size: 20px;
            color: #2c3e50;
            border-bottom: 1px solid #ddd;
            padding-bottom: 10px;
            margin-bottom: 15px;
        }
        .participant-list {
            list-style: none;
            padding: 0;
            margin: 10px 0 20px 0;
        }
        .participant-list li {
            padding: 8px 0;
            color: #555;
            font-size: 15px;
            border-bottom: 1px dashed #eee;
        }
        .participant-list li:last-child {
            border-bottom: none;
        }
        .participant-list .user-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-weight: 600;
        }
        .participant-list .user-info .role-badge {
            font-size: 12px;
            background: #e74c3c;
            color: white;
            padding: 2px 5px;
            border-radius: 5px;
            font-weight: 400;
        }
        .participant-list .detail-info {
            font-size: 12px;
            color: #999;
            margin-top: 3px;
        }
        .join-button {
            width: 100%;
            padding: 14px;
        }
        .btn-cancel {
            background-color: #e74c3c;
        }
    </style>
</head>
<body>

<header class="quick-menu">
    <div class="logo"><a href="/">MULTI FC</a></div>
    <div class="header-icons">
        <button id="profile-menu-toggle" class="profile-icon" style="position: relative; display: none;">
            <i class="fas fa-user-circle"></i>
            <span id="notification-badge" class="notification-badge"></span>
        </button>
        <div id="profile-menu" class="user-menu">
            <div class="user-info">
                <strong><span id="user-menu-username">ì‚¬ìš©ì</span>ë‹˜</strong>
                <p>í™˜ì˜í•©ë‹ˆë‹¤!</p>
            </div>
            <ul>
                <li><a href="/notifications" id="nav-notifications-link"><i class="fas fa-bell"></i> ì•Œë¦¼ ëª©ë¡</a></li>
                <li><a href="/mypage"><i class="fas fa-user"></i> ë§ˆì´í˜ì´ì§€</a></li>
                <li><a href="/profile/edit"><i class="fas fa-user-edit"></i> í”„ë¡œí•„ ìˆ˜ì •</a></li>
                <li><a href="#" id="logout-button"><i class="fas fa-sign-out-alt"></i> ë¡œê·¸ì•„ì›ƒ</a></li>
            </ul>
        </div>
        <button id="menu-toggle" class="menu-toggle-btn"><i class="fas fa-bars"></i></button>
    </div>
    <nav id="main-menu" class="main-nav">
        <ul>
            <li><a href="/"><i class="fas fa-home"></i> ë©”ì¸ (Home)</a></li>
            <li><a href="/fields"><i class="fas fa-search"></i> êµ¬ì¥ê²€ìƒ‰</a></li>
            <li><a href="/community"><i class="fas fa-users"></i> ì»¤ë®¤ë‹ˆí‹°</a></li>
            <li id="nav-chat-link-li"><a href="/chat" id="nav-chat-link"><i class="fas fa-comments"></i> ì‹¤ì‹œê°„ì±„íŒ…</a></li>
            <li><a href="/login" id="nav-login-link"><i class="fas fa-sign-in-alt"></i> ë¡œê·¸ì¸</a></li>
            <li style="display:none;"><a href="#" id="nav-logout-link"><i class="fas fa-sign-out-alt"></i> ë¡œê·¸ì•„ì›ƒ</a></li>
        </ul>
    </nav>
</header>

<main class="schedule-search-main">
    <div class="search-container">
        <h1 class="search-title" th:text="'ê²½ê¸° ìƒì„¸ ì •ë³´ (ID: ' + ${matchId} + ')'">ğŸ“… ì¼ì • ìƒì„¸</h1>
        <input type="hidden" id="match-id-hidden" th:value="${matchId}">

        <div class="detail-grid">
            <div class="detail-left-column">
                <div class="map-area" id="map">(KakaoMap APIê°€ í‘œì‹œë  ì˜ì—­)</div>

                <h3>ê²½ê¸° ì •ë³´</h3>
                <div class="detail-info-item">
                    <i class="fas fa-calendar-alt"></i>
                    <span id="detail-datetime">ë¡œë”©ì¤‘...</span>
                </div>
                <div class="detail-info-item">
                    <i class="fas fa-map-marker-alt"></i>
                    <span id="detail-location">ë¡œë”©ì¤‘...</span>
                </div>
                <div class="detail-info-item">
                    <i class="fas fa-users"></i>
                    <span id="detail-match-type">ë¡œë”©ì¤‘...</span>
                </div>
                <div class="detail-info-item">
                    <i class="fas fa-medal"></i>
                    <span id="detail-skill-level">ë¡œë”©ì¤‘...</span>
                </div>
            </div>

            <div class="detail-right-column">
                <div class="status-card">
                    <h3>ì°¸ì—¬ í˜„í™©</h3>
                    <strong><span id="current-players">0</span> / <span id="max-players">0</span> ëª…</strong>
                    <ul class="participant-list" id="participant-list">
                    </ul>

                    <button id="join-match-btn" class="login-button join-button" style="display:none;">ì°¸ì—¬í•˜ê¸°</button>
                    <button id="cancel-match-btn" class="login-button join-button btn-cancel" style="display:none;">ì°¸ì—¬ ì·¨ì†Œ</button>
                    <button id="host-msg-btn" class="login-button join-button" style="display:none; background-color: #555; cursor:default;">ë‚´ê°€ ì£¼ìµœí•œ ê²½ê¸°</button>

                    <p id="login-prompt-msg" style="display:none; text-align: center; margin-top: 15px; font-size: 14px;">
                        ì°¸ì—¬í•˜ë ¤ë©´ <a href="/login" style="color: #6c5ce7; font-weight: 600;">ë¡œê·¸ì¸</a>ì´ í•„ìš”í•©ë‹ˆë‹¤.
                    </p>
                </div>
            </div>
        </div>
    </div>
</main>

<script>
    /* =========================================================
       1. ê³µí†µ ë©”ë‰´ ë° ì¸ì¦ ë¡œì§
    ========================================================= */
    const menuToggle = document.getElementById('menu-toggle');
    const mainMenu = document.getElementById('main-menu');
    const profileMenuToggle = document.getElementById('profile-menu-toggle');
    const profileMenu = document.getElementById('profile-menu');
    const logoutButton = document.getElementById('logout-button');
    const navNotificationsLink = document.getElementById('nav-notifications-link');
    const navLoginLink = document.getElementById('nav-login-link');
    const navLogoutLink = document.getElementById('nav-logout-link');

    // ë©”ë‰´ í† ê¸€
    if (menuToggle) {
        menuToggle.addEventListener('click', () => {
            mainMenu.classList.toggle('show');
            profileMenu.classList.remove('show');
        });
    }
    if (profileMenuToggle) {
        profileMenuToggle.addEventListener('click', () => {
            profileMenu.classList.toggle('show');
            mainMenu.classList.remove('show');
        });
    }
    document.addEventListener('click', (event) => {
        if (!mainMenu.contains(event.target) && !menuToggle.contains(event.target) &&
            !profileMenu.contains(event.target) && !profileMenuToggle.contains(event.target)) {
            mainMenu.classList.remove('show');
            profileMenu.classList.remove('show');
        }
    });

    // ë¡œê·¸ì•„ì›ƒ
    if (logoutButton) {
        logoutButton.addEventListener('click', handleLogout);
    }
    if (navLogoutLink) {
        navLogoutLink.addEventListener('click', handleLogout);
    }
    function handleLogout(e) {
        e.preventDefault();
        localStorage.removeItem('accessToken');
        localStorage.removeItem('userId');
        localStorage.removeItem('userNickname');
        window.location.href = '/login';
    }

    /* =========================================================
       2. ê²½ê¸° ìƒì„¸ í˜ì´ì§€ í•µì‹¬ ë¡œì§ (ì‹¤ì‹œê°„ ì—°ë™)
    ========================================================= */
    let stompClient = null;
    let currentMatchData = null;
    let currentUserId = null;
    const matchId = document.getElementById('match-id-hidden').value;

    // (1) ê²½ê¸° ê¸°ë³¸ ì •ë³´ ë¡œë“œ
    async function fetchMatchDetail() {
        try {
            const res = await fetch(`/api/matchrooms/${matchId}`);
            if (!res.ok) throw new Error('ê²½ê¸° ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.');

            currentMatchData = await res.json();

            // í™”ë©´ ì—…ë°ì´íŠ¸
            document.getElementById('detail-datetime').textContent = `${currentMatchData.matchDate} ${currentMatchData.matchTime}`;
            document.getElementById('detail-location').textContent = `êµ¬ì¥ ID: ${currentMatchData.stadiumId}`;
            document.getElementById('detail-match-type').textContent = `ê°œì¸ ë§¤ì¹­ (${currentMatchData.maxPlayers}ëª… ëª¨ì§‘)`;
            document.getElementById('detail-skill-level').textContent = `${currentMatchData.level} (${currentMatchData.status})`;
            document.getElementById('max-players').textContent = currentMatchData.maxPlayers;

        } catch (err) {
            console.error(err);
        }
    }

    // (2) ì°¸ê°€ì ëª©ë¡ ë¡œë“œ (ì‹¤ì œ API í˜¸ì¶œ)
    async function fetchParticipantList() {
        try {
            // ìˆ˜ì •ëœ API (DTO ë°˜í™˜) í˜¸ì¶œ
            const res = await fetch(`/api/matchrooms/${matchId}/participants/all`);
            if (!res.ok) throw new Error('ì°¸ê°€ì ëª©ë¡ ë¡œë“œ ì‹¤íŒ¨');

            const participants = await res.json(); // ParticipantDto ë¦¬ìŠ¤íŠ¸
            renderParticipantList(participants);

        } catch (err) {
            console.error(err);
        }
    }

    // (3) ì°¸ê°€ì ëª©ë¡ í™”ë©´ ê·¸ë¦¬ê¸°
    function renderParticipantList(participants) {
        const listEl = document.getElementById('participant-list');
        listEl.innerHTML = '';

        const currentPlayersEl = document.getElementById('current-players');

        // ì°¸ê°€ì(Player) ìˆ˜ë§Œ ì¹´ìš´íŠ¸ (Host ì œì™¸)
        const playerCount = participants.filter(p => p.role === 'Player').length;
        currentPlayersEl.textContent = playerCount;

        participants.forEach(user => {
            const listItem = document.createElement('li');
            const roleBadge = user.role === 'Host' ? `<span class="role-badge">ì£¼ìµœì</span>` : '';

            let nicknameDisplay = user.nickname;
            if (Number(user.userId) === currentUserId) {
                nicknameDisplay = `${user.nickname} (ë‚˜)`;
            }

            listItem.innerHTML = `
                <div class="user-info">
                    <span>${nicknameDisplay}</span>
                    ${roleBadge}
                </div>
                <div class="detail-info">
                    í¬ì§€ì…˜: ${user.position || 'ë¯¸ì •'}
                </div>
            `;
            listEl.appendChild(listItem);
        });

        // ë²„íŠ¼ ìƒíƒœ ê°±ì‹ 
        updateButtonState(participants);
    }

    // (4) ë²„íŠ¼ ìƒíƒœ ê´€ë¦¬ (ì°¸ì—¬/ì·¨ì†Œ/ì£¼ìµœì í‘œì‹œ)
    function updateButtonState(participants) {
        const joinBtn = document.getElementById('join-match-btn');
        const cancelBtn = document.getElementById('cancel-match-btn');
        const hostMsgBtn = document.getElementById('host-msg-btn');
        const loginPrompt = document.getElementById('login-prompt-msg');

        joinBtn.style.display = 'none';
        cancelBtn.style.display = 'none';
        hostMsgBtn.style.display = 'none';
        loginPrompt.style.display = 'none';

        if (!currentUserId) {
            loginPrompt.style.display = 'block';
            return;
        }

        if (currentMatchData && Number(currentMatchData.hostId) === currentUserId) {
            hostMsgBtn.style.display = 'block'; // ë‚´ê°€ ë°©ì¥
        } else {
            // ë‚´ê°€ ì°¸ê°€ìì¸ì§€ í™•ì¸
            const isJoined = participants.some(p => Number(p.userId) === currentUserId);

            if (isJoined) {
                cancelBtn.style.display = 'block';
            } else {
                // ì •ì› ë§ˆê° ì—¬ë¶€ ì²´í¬
                const currentCount = participants.filter(p => p.role === 'Player').length;
                if (currentMatchData && currentCount < currentMatchData.maxPlayers) {
                    joinBtn.style.display = 'block';
                } else {
                    joinBtn.innerText = "ëª¨ì§‘ ë§ˆê°";
                    joinBtn.style.display = 'block';
                    joinBtn.disabled = true;
                    joinBtn.style.backgroundColor = "#ccc";
                }
            }
        }
    }

    // (5) ì°¸ê°€ ìš”ì²­
    async function handleJoin() {
        if (!currentUserId) return alert("ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.");
        if (!confirm("ì°¸ê°€í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;

        try {
            const res = await fetch(`/api/matchrooms/${matchId}/join`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ userId: currentUserId })
            });
            if (!res.ok) throw new Error('ì°¸ê°€ ì‹¤íŒ¨');
            // ì„±ê³µ ì‹œ WebSocketì´ ìë™ ê°±ì‹ í•˜ë¯€ë¡œ ë³„ë„ ì²˜ë¦¬ ë¶ˆí•„ìš”
        } catch (err) {
            alert(err.message);
        }
    }

    // (6) ì°¸ê°€ ì·¨ì†Œ
    async function handleCancel() {
        if (!confirm("ì°¸ê°€ë¥¼ ì·¨ì†Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;

        try {
            const res = await fetch(`/api/matchrooms/${matchId}/cancel`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ userId: currentUserId })
            });
            if (!res.ok) throw new Error('ì·¨ì†Œ ì‹¤íŒ¨');
        } catch (err) {
            alert(err.message);
        }
    }

    // (7) WebSocket ì—°ê²°
    function connectWebSocket() {
        const socket = new SockJS('/ws');
        stompClient = Stomp.over(socket);

        stompClient.connect({}, () => {
            console.log("ìƒì„¸í˜ì´ì§€ WS ì—°ê²° ì„±ê³µ");

            // ì´ ë°©ì˜ ì°¸ê°€ì ë³€ê²½ êµ¬ë…
            stompClient.subscribe(`/topic/matchroom/${matchId}/participants`, (msg) => {
                console.log("ì°¸ê°€ì ë³€ê²½ ê°ì§€! ëª©ë¡ ê°±ì‹ ");
                fetchParticipantList(); // ëª©ë¡ ë‹¤ì‹œ ë¶ˆëŸ¬ì˜¤ê¸°
            });
        });
    }

    /* =========================================================
       3. ì´ˆê¸°í™” ì‹¤í–‰
    ========================================================= */
    document.addEventListener('DOMContentLoaded', async () => {
        const token = localStorage.getItem('accessToken');
        currentUserId = Number(localStorage.getItem('userId'));

        // í—¤ë” UI ì²˜ë¦¬
        if (token) {
            document.getElementById('profile-menu-toggle').style.display = 'block';
            if (navLoginLink) navLoginLink.parentElement.style.display = 'none';
            if (navLogoutLink) navLogoutLink.parentElement.style.display = 'list-item';
        } else {
            if (navLoginLink) navLoginLink.parentElement.style.display = 'list-item';
            if (navLogoutLink) navLogoutLink.parentElement.style.display = 'none';
        }

        // ë°ì´í„° ë¡œë“œ
        await fetchMatchDetail();
        await fetchParticipantList();

        // ë²„íŠ¼ ì´ë²¤íŠ¸ ì—°ê²°
        document.getElementById('join-match-btn').addEventListener('click', handleJoin);
        document.getElementById('cancel-match-btn').addEventListener('click', handleCancel);

        // ì›¹ì†Œì¼“ ì—°ê²°
        connectWebSocket();
    });

</script>

</body>
</html>