<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title th:text="'ê²½ê¸° ìƒì„¸ (ID: ' + ${matchId} + ') - MULTI FC'">MULTI FC - ì¼ì • ìƒì„¸</title>

    <link rel="stylesheet" th:href="@{/css/style.css}">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700;900&family=Noto+Sans+KR:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">

    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
    <script src="//dapi.kakao.com/v2/maps/sdk.js?appkey=4caaf2cb0e09303d4dd13d3fb5ff15e9&libraries=services"></script>

    <style>
        /* ======================================= */
        /* í—¤ë”/ë©”ë‰´ ìŠ¤íƒ€ì¼ (Stadum/Image ê¸°ë°˜ ë””ìì¸ í†µí•©) */
        /* ======================================= */
        .quick-menu {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 30px;
            background: white;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 100;
        }
        .quick-menu .logo a {
            font-size: 24px;
            font-weight: 900;
            color: #333; /* ë¡œê³  ìƒ‰ìƒ ìœ ì§€ */
            text-decoration: none;
        }
        .header-icons {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        .profile-icon {
            font-size: 24px;
            cursor: pointer;
            border: none;
            background: none;
            color: #333;
        }
        .menu-toggle-btn {
            border: none;
            background: none;
            font-size: 20px;
            cursor: pointer;
        }
        .user-menu { /* í”„ë¡œí•„ ë©”ë‰´ */
            position: absolute;
            top: 60px;
            right: 30px;
            background: white;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 10px 0;
            display: none;
            width: 200px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            z-index: 1000;
        }
        .user-menu.show { display: block; }
        .user-info { padding: 10px 15px; border-bottom: 1px solid #eee; margin-bottom: 5px; }
        .user-menu ul { list-style: none; padding: 0; margin: 0; }
        .user-menu ul li a { padding: 8px 15px; text-decoration: none; color: #333; display: block; font-size: 14px;}

        .main-nav { /* ë©”ì¸ ë„¤ë¹„ê²Œì´ì…˜ ë©”ë‰´ */
            display: none;
            position: absolute;
            top: 60px;
            right: 0;
            background: white;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            width: 200px;
            border-radius: 8px;
            z-index: 90;
        }
        .main-nav.show { display: block; /* ë©”ë‰´ í† ê¸€ í™œì„±í™” CSS */ }
        .main-nav ul { list-style: none; padding: 10px 0; margin: 0; }
        .main-nav ul li a { display: block; padding: 10px 15px; text-decoration: none; color: #333; font-weight: 500;}


        /* ======================================= */
        /* ë³¸ë¬¸ ìƒì„¸ ë””ìì¸ (ì›ë³¸ ìœ ì§€) */
        /* ======================================= */
        .schedule-search-main { padding: 100px 40px 40px 40px; background-color: #f7f7f7; min-height: 100vh; }
        .search-container { max-width: 1200px; margin: 0 auto; background: white; padding: 30px; border-radius: 15px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); }
        .search-title { font-size: 28px; font-weight: 700; color: #2c3e50; margin-bottom: 25px; border-bottom: 2px solid #6c5ce7; padding-bottom: 10px; }
        .detail-grid { display: grid; grid-template-columns: 1fr; gap: 30px; }
        @media (min-width: 768px) { .detail-grid { grid-template-columns: 1fr 350px; } }
        .map-area { width: 100%; height: 300px; background-color: #eee; border-radius: 10px; margin-bottom: 20px; display: flex; align-items: center; justify-content: center; font-size: 20px; color: #888; }
        .detail-info-item { display: flex; font-size: 16px; color: #333; margin-bottom: 15px; align-items: center; }
        .detail-info-item i { width: 30px; color: #6c5ce7; font-size: 18px; }
        .status-card { background: #f9f9f9; border: 1px solid #ddd; border-radius: 10px; padding: 20px; }
        .status-card h3 { font-size: 20px; color: #2c3e50; border-bottom: 1px solid #ddd; padding-bottom: 10px; margin-bottom: 15px; }

        /* --- ì°¸ê°€ì ë¦¬ìŠ¤íŠ¸ & ê´€ë¦¬ ë²„íŠ¼ ìŠ¤íƒ€ì¼ (ì›ë³¸ ìœ ì§€) --- */
        .participant-list { list-style: none; padding: 0; margin: 10px 0 20px 0; }
        .participant-list li { padding: 10px 0; border-bottom: 1px dashed #eee; }
        .participant-list li:last-child { border-bottom: none; }

        .user-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 4px; }
        .user-info { font-weight: 600; font-size: 15px; color: #333; }
        .user-meta { font-size: 12px; color: #888; }

        /* ë°°ì§€ ìŠ¤íƒ€ì¼ */
        .badge { padding: 2px 6px; border-radius: 4px; font-size: 11px; margin-left: 5px; color: white; }
        .badge-host { background-color: #e74c3c; }
        .badge-me { background-color: #6c5ce7; }
        .badge-waiting { background-color: #f39c12; }
        .badge-confirmed { background-color: #27ae60; }

        /* ê´€ë¦¬ ë²„íŠ¼ ê·¸ë£¹ */
        .manage-btns { display: flex; gap: 5px; }
        .btn-sm { padding: 4px 8px; border: none; border-radius: 4px; font-size: 12px; cursor: pointer; color: white; }
        .btn-approve { background-color: #27ae60; }
        .btn-reject { background-color: #e74c3c; }

        /* í•˜ë‹¨ ë©”ì¸ ë²„íŠ¼ */
        .join-button { width: 100%; padding: 14px; border-radius: 8px; font-weight: 700; font-size: 16px; border: none; cursor: pointer; margin-top: 10px; transition: 0.2s; }
        .btn-join { background-color: #333; color: white; }
        .btn-cancel { background-color: #e74c3c; color: white; }
        .btn-close { background-color: #2c3e50; color: white; }
        .btn-disabled { background-color: #ccc; color: #666; cursor: not-allowed; }

        .match-status-label { font-weight: 800; margin-left: 10px; }
        .status-open { color: #27ae60; }
        .status-closed { color: #e74c3c; }
    </style>
</head>
<body>

<header class="quick-menu">
    <div class="logo"><a href="/">MULTI FC</a></div>
    <div class="header-icons">
        <a href="/login" id="nav-login-btn" style="margin-right:10px; font-weight:bold; color:#333; display:block;">ë¡œê·¸ì¸</a>
        <button id="profile-menu-toggle" class="profile-icon" style="position: relative; display: none;">
            <i class="fas fa-user-circle"></i>
        </button>
        <div id="profile-menu" class="user-menu">
            <div class="user-info">
                <strong><span id="user-menu-username">íšŒì›</span>ë‹˜</strong>
                <p>í™˜ì˜í•©ë‹ˆë‹¤!</p>
            </div>
            <ul>
                <li><a href="#" id="logout-button"><i class="fas fa-sign-out-alt"></i> ë¡œê·¸ì•„ì›ƒ</a></li>
            </ul>
        </div>
        <button id="menu-toggle" class="menu-toggle-btn" style="background:none; border:none; font-size:20px;"> <i class="fas fa-bars"></i> </button>
    </div>
    <nav id="main-menu" class="main-nav">
        <ul>
            <li><a href="/"><i class="fas fa-home"></i> ë©”ì¸ (Home)</a></li>
            <li><a href="/fields"><i class="fas fa-search"></i> êµ¬ì¥ê²€ìƒ‰</a></li>
            <li><a href="/community"><i class="fas fa-users"></i> ì»¤ë®¤ë‹ˆí‹°</a></li>
            <li id="nav-chat-link-li"><a href="/chat" id="nav-chat-link"><i class="fas fa-comments"></i> ì‹¤ì‹œê°„ì±„íŒ…</a></li>
        </ul>
    </nav>
</header>

<main class="schedule-search-main">
    <div class="search-container">
        <h1 class="search-title" th:text="'ê²½ê¸° ìƒì„¸ ì •ë³´ (ID: ' + ${matchId} + ')'">ğŸ“… ì¼ì • ìƒì„¸</h1>
        <input type="hidden" id="match-id-hidden" th:value="${matchId}">

        <div class="detail-grid">
            <div class="detail-left-column">
                <div class="map-area" id="map">ì§€ë„ë¥¼ ë¡œë“œí•˜ëŠ” ì¤‘...</div>

                <h3>
                    ê²½ê¸° ì •ë³´
                    <span id="match-status-display" class="match-status-label"></span>
                </h3>
                <div class="detail-info-item">
                    <i class="fas fa-calendar-alt"></i>
                    <span id="detail-datetime">ë¡œë”©ì¤‘...</span>
                </div>
                <div class="detail-info-item">
                    <i class="fas fa-map-marker-alt"></i>
                    <span id="detail-location">ë¡œë”©ì¤‘...</span>
                </div>
                <div class="detail-info-item">
                    <i class="fas fa-users"></i>
                    <span id="detail-match-type">ë¡œë”©ì¤‘...</span>
                </div>
                <div class="detail-info-item">
                    <i class="fas fa-medal"></i>
                    <span id="detail-skill-level">ë¡œë”©ì¤‘...</span>
                </div>
            </div>

            <div class="detail-right-column">
                <div class="status-card">
                    <h3>ì°¸ì—¬ í˜„í™©</h3>
                    <strong><span id="current-players">0</span> / <span id="max-players">0</span> ëª…</strong>

                    <ul class="participant-list" id="participant-list">
                    </ul>

                    <div id="button-container">
                    </div>

                    <p id="login-prompt-msg" style="display:none; text-align: center; margin-top: 15px; font-size: 14px;">
                        ì°¸ì—¬í•˜ë ¤ë©´ <a href="/login" style="color: #6c5ce7; font-weight: 600;">ë¡œê·¸ì¸</a>ì´ í•„ìš”í•©ë‹ˆë‹¤.
                    </p>
                </div>
            </div>
        </div>
    </div>
</main>

<script>
    /* =========================================================
       1. ì´ˆê¸°í™” ë° í—¤ë” ì²˜ë¦¬
    ========================================================= */
    let stompClient = null;
    let currentMatchData = null;
    let currentUserId = null;
    const matchId = document.getElementById('match-id-hidden').value;

    document.addEventListener('DOMContentLoaded', async () => {
        // ë¡œê·¸ì¸ ì •ë³´ í™•ì¸
        const token = localStorage.getItem('accessToken');
        const userIdStr = localStorage.getItem('userId');
        const nickname = localStorage.getItem('userNickname');

        if(userIdStr) currentUserId = Number(userIdStr);

        // í—¤ë” UI ì—…ë°ì´íŠ¸
        if (token) {
            document.getElementById('nav-login-btn').style.display = 'none';
            document.getElementById('profile-menu-toggle').style.display = 'block';
            document.getElementById('user-menu-username').textContent = nickname || 'íšŒì›';
        } else {
            document.getElementById('nav-login-btn').style.display = 'block';
            document.getElementById('profile-menu-toggle').style.display = 'none';
        }

        // ë©”ë‰´ ì´ë²¤íŠ¸
        document.getElementById('profile-menu-toggle')?.addEventListener('click', () => {
            document.getElementById('profile-menu').classList.toggle('show');
        });
        document.getElementById('logout-button')?.addEventListener('click', (e) => {
            e.preventDefault();
            localStorage.clear();
            window.location.href = '/login';
        });

        // â­â­ ë©”ë‰´ í† ê¸€ ì´ë²¤íŠ¸ (ë©”ë‰´ ë‚˜ì˜¤ê²Œ í•˜ëŠ” JS) â­â­
        document.getElementById('menu-toggle')?.addEventListener('click', () => {
            document.getElementById('main-menu').classList.toggle('show');
            document.getElementById('profile-menu')?.classList.remove('show');
        });
        // ---------------------------------------------

        // ë°ì´í„° ë¡œë“œ
        await fetchMatchDetail(); // â­ ì´ í•¨ìˆ˜ê°€ ì§€ë„ë¥¼ ì´ˆê¸°í™”í•˜ë„ë¡ ìˆ˜ì •ë¨
        await fetchParticipantList();

        // WebSocket ì—°ê²°
        connectWebSocket();
    });

    /* =========================================================
       2. ì§€ë„ ì´ˆê¸°í™” í•¨ìˆ˜
    ========================================================= */
    function initMap(lat, lng, name) {
        if (window.kakao && kakao.maps) {
            const mapContainer = document.getElementById('map');
            const mapOption = {
                center: new kakao.maps.LatLng(lat, lng), // ì§€ë„ì˜ ì¤‘ì‹¬ì¢Œí‘œ
                level: 3 // ì§€ë„ì˜ í™•ëŒ€ ë ˆë²¨
            };
            const map = new kakao.maps.Map(mapContainer, mapOption);

            // ë§ˆì»¤ í‘œì‹œ
            const markerPosition = new kakao.maps.LatLng(lat, lng);
            new kakao.maps.Marker({
                position: markerPosition,
                map: map
            });

            // ì¸í¬ìœˆë„ìš° í‘œì‹œ (ì„ íƒ ì‚¬í•­: êµ¬ì¥ ì´ë¦„ í‘œì‹œ)
            const infowindow = new kakao.maps.InfoWindow({
                content: `<div style="padding:5px;font-size:12px;font-weight:bold;">${name}</div>`
            });
            infowindow.open(map, new kakao.maps.Marker({ position: markerPosition }));

            console.log("Kakao Map initialized successfully.");
        } else {
            console.error("Kakao Map API is not loaded.");
        }
    }


    /* =========================================================
       3. ë°ì´í„° ë¡œë“œ í•¨ìˆ˜ (ì§€ë„ ì´ˆê¸°í™” ë¡œì§ í¬í•¨)
    ========================================================= */
    async function fetchMatchDetail() {
        try {
            const res = await fetch(`/api/matchrooms/${matchId}`);
            if (!res.ok) throw new Error('ê²½ê¸° ì •ë³´ ë¡œë“œ ì‹¤íŒ¨');
            currentMatchData = await res.json();

            // 1. ê²½ê¸° ì •ë³´ í‘œì‹œ
            document.getElementById('detail-datetime').textContent = `${currentMatchData.matchDate} ${currentMatchData.matchTime}`;
            document.getElementById('detail-match-type').textContent = `ê°œì¸ ë§¤ì¹­ (${currentMatchData.maxPlayers}ëª…)`;
            document.getElementById('detail-skill-level').textContent = currentMatchData.level;
            document.getElementById('max-players').textContent = currentMatchData.maxPlayers;

            // 2. êµ¬ì¥ ì •ë³´ ì¡°íšŒ ë° ì§€ë„ ì´ˆê¸°í™”
            const stadiumId = currentMatchData.stadiumId;
            const stadiumRes = await fetch(`/api/stadiums`);
            const allStadiums = await stadiumRes.json();
            const stadium = allStadiums.find(s => s.stadiumId === stadiumId);

            if (stadium) {
                document.getElementById('detail-location').textContent = stadium.name + ' (' + stadium.address + ')';
                // â­ ì¢Œí‘œë¥¼ ì–»ì€ í›„ ì§€ë„ ì´ˆê¸°í™” â­
                initMap(stadium.latitude, stadium.longitude, stadium.name);
            } else {
                document.getElementById('detail-location').textContent = `êµ¬ì¥ ID ${stadiumId} ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`;
                document.getElementById('map').textContent = 'êµ¬ì¥ ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ì–´ ì§€ë„ë¥¼ í‘œì‹œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.';
            }

            // 3. ìƒíƒœ í‘œì‹œ
            const statusEl = document.getElementById('match-status-display');
            if (currentMatchData.status === 'CLOSED') {
                statusEl.textContent = "(ëª¨ì§‘ ë§ˆê°)";
                statusEl.className = "match-status-label status-closed";
            } else {
                statusEl.textContent = "(ëª¨ì§‘ì¤‘)";
                statusEl.className = "match-status-label status-open";
            }
        } catch (err) {
            console.error(err);
            document.getElementById('map').textContent = 'ê²½ê¸° ì •ë³´ ë¡œë“œ ì¤‘ ì˜¤ë¥˜ ë°œìƒ.';
        }
    }

    async function fetchParticipantList() {
        try {
            const res = await fetch(`/api/matchrooms/${matchId}/participants/all`);
            if (!res.ok) throw new Error('ì°¸ê°€ì ëª©ë¡ ë¡œë“œ ì‹¤íŒ¨');
            const participants = await res.json();
            renderParticipantList(participants);
        } catch (err) { console.error(err); }
    }

    /* =========================================================
       4. í™”ë©´ ë Œë”ë§
    ========================================================= */
    function renderParticipantList(participants) {
        const listEl = document.getElementById('participant-list');
        listEl.innerHTML = '';

        // í”Œë ˆì´ì–´ ìˆ˜ ì¹´ìš´íŠ¸ (Host ì œì™¸, í™•ì •ëœ ì‚¬ëŒë§Œ ì…€ ìˆ˜ë„ ìˆìŒ. ì—¬ê¸°ì„  ì „ì²´ Player)
        const players = participants.filter(p => p.role === 'Player');
        document.getElementById('current-players').textContent = players.length;

        // ë‚´ê°€ ë°©ì¥ì¸ì§€ í™•ì¸
        const amIHost = (currentMatchData && Number(currentMatchData.hostId) === currentUserId);
        const isClosed = (currentMatchData && currentMatchData.status === 'CLOSED');

        participants.forEach(user => {
            const li = document.createElement('li');

            // ë‹‰ë„¤ì„ í‘œì‹œ
            let nameHtml = `<span class="user-info">${user.nickname}</span>`;

            // ë°°ì§€ í‘œì‹œ
            if (user.role === 'Host') nameHtml += ` <span class="badge badge-host">ë°©ì¥</span>`;
            if (Number(user.userId) === currentUserId) nameHtml += ` <span class="badge badge-me">ë‚˜</span>`;

            // ìƒíƒœ í‘œì‹œ (Playerì¸ ê²½ìš°ë§Œ)
            const status = user.status || 'ëŒ€ê¸°'; // ê¸°ë³¸ê°’ ëŒ€ê¸°
            if (user.role === 'Player') {
                if (status === 'í™•ì •') nameHtml += ` <span class="badge badge-confirmed">í™•ì •</span>`;
                else nameHtml += ` <span class="badge badge-waiting">ëŒ€ê¸°</span>`;
            }

            // ê´€ë¦¬ ë²„íŠ¼ (ë‚´ê°€ ë°©ì¥ì´ê³  + ìƒëŒ€ê°€ Playerì´ê³  + ê²½ê¸°ê°€ ì•ˆ ëë‚¬ì„ ë•Œ)
            let btnHtml = '';
            if (amIHost && user.role === 'Player' && !isClosed) {
                btnHtml = `
                    <div class="manage-btns">
                        ${status === 'ëŒ€ê¸°' ? `<button class="btn-sm btn-approve" onclick="approveUser(${user.userId})">ìˆ˜ë½</button>` : ''}
                        <button class="btn-sm btn-reject" onclick="rejectUser(${user.userId})">ê°•í‡´</button>
                    </div>
                `;
            }

            li.innerHTML = `
                <div class="user-row">
                    <div>${nameHtml}</div>
                    ${btnHtml}
                </div>
                <div class="user-meta">í¬ì§€ì…˜: ${user.position || 'ë¯¸ì •'}</div>
            `;
            listEl.appendChild(li);
        });

        // í•˜ë‹¨ ë©”ì¸ ë²„íŠ¼ ì—…ë°ì´íŠ¸
        renderMainButtons(participants, amIHost, isClosed);
    }

    function renderMainButtons(participants, amIHost, isClosed) {
        const container = document.getElementById('button-container');
        const loginPrompt = document.getElementById('login-prompt-msg');
        container.innerHTML = '';

        if (!currentUserId) {
            loginPrompt.style.display = 'block';
            return;
        }
        loginPrompt.style.display = 'none';

        // 1. ê²½ê¸°ê°€ ë§ˆê°ëœ ê²½ìš°
        if (isClosed) {
            container.innerHTML = `<button class="join-button btn-disabled" disabled>ëª¨ì§‘ì´ ë§ˆê°ë˜ì—ˆìŠµë‹ˆë‹¤</button>`;
            return;
        }

        // 2. ë‚´ê°€ ë°©ì¥ì¸ ê²½ìš° -> [ê²½ê¸° í™•ì •(ë§ˆê°)] ë²„íŠ¼
        if (amIHost) {
            container.innerHTML = `<button class="join-button btn-close" onclick="closeMatch()">ğŸ“¢ ëª¨ì§‘ ë§ˆê° (ê²½ê¸° í™•ì •)</button>`;
            return;
        }

        // 3. ì¼ë°˜ ì°¸ê°€ì
        const isJoined = participants.some(p => Number(p.userId) === currentUserId);
        if (isJoined) {
            container.innerHTML = `<button class="join-button btn-cancel" onclick="cancelMatch()">ì°¸ê°€ ì·¨ì†Œ</button>`;
        } else {
            // ìë¦¬ í™•ì¸ (ì˜ˆ: 10ëª…)
            const currentCount = participants.filter(p => p.role === 'Player').length;
            if (currentCount < currentMatchData.maxPlayers) {
                container.innerHTML = `<button class="join-button btn-join" onclick="joinMatch()">ì°¸ê°€ ì‹ ì²­</button>`;
            } else {
                container.innerHTML = `<button class="join-button btn-disabled" disabled>ì •ì› ì´ˆê³¼</button>`;
            }
        }
    }

    /* =========================================================
       5. ì•¡ì…˜ í•¨ìˆ˜ë“¤ (API í˜¸ì¶œ)
    ========================================================= */

    // ì°¸ê°€ ì‹ ì²­
    window.joinMatch = async () => {
        if (!confirm("ì°¸ê°€ ì‹ ì²­í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
        await fetch(`/api/matchrooms/${matchId}/join`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ userId: currentUserId })
        });
    };

    // ì°¸ê°€ ì·¨ì†Œ
    window.cancelMatch = async () => {
        if (!confirm("ì •ë§ ì·¨ì†Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
        await fetch(`/api/matchrooms/${matchId}/cancel`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ userId: currentUserId })
        });
    };

    // [ë°©ì¥] ì°¸ê°€ì ìˆ˜ë½
    window.approveUser = async (targetId) => {
        if (!confirm("ì´ ì°¸ê°€ìë¥¼ ìˆ˜ë½í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
        await fetch(`/api/matchrooms/${matchId}/approve`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ userId: targetId })
        });
    };

    // [ë°©ì¥] ì°¸ê°€ì ê°•í‡´
    window.rejectUser = async (targetId) => {
        if (!confirm("ì´ ì°¸ê°€ìë¥¼ ê°•í‡´í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
        await fetch(`/api/matchrooms/${matchId}/reject`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ userId: targetId })
        });
    };

    // [ë°©ì¥] ê²½ê¸° í™•ì • (ë§ˆê°)
    window.closeMatch = async () => {
        if (!confirm("ëª¨ì§‘ì„ ë§ˆê°í•˜ê³  ë§¤ì¹­ì„ í™•ì •í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n(ë” ì´ìƒ ì°¸ê°€ìë¥¼ ë°›ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤)")) return;
        const res = await fetch(`/api/matchrooms/${matchId}/close`, { method: 'POST' });
        if (res.ok) {
            alert("ë§¤ì¹­ì´ í™•ì •ë˜ì—ˆìŠµë‹ˆë‹¤!");
            location.reload(); // ìƒíƒœ ë³€ê²½ ë°˜ì˜ì„ ìœ„í•´ ìƒˆë¡œê³ ì¹¨
        }
    };

    /* =========================================================
       6. WebSocket (ì‹¤ì‹œê°„ ê°±ì‹ )
    ========================================================= */
    function connectWebSocket() {
        const socket = new SockJS('/ws');
        stompClient = Stomp.over(socket);
        stompClient.connect({}, () => {
            console.log("WebSocket Connected");
            // ì°¸ê°€ì ë³€ê²½ êµ¬ë…
            stompClient.subscribe(`/topic/matchroom/${matchId}/participants`, () => {
                console.log("Update detected, refreshing list...");
                fetchParticipantList(); // ëª©ë¡ ë‹¤ì‹œ ë¶ˆëŸ¬ì˜¤ê¸°
            });
        }, (err) => console.error("WebSocket Error:", err));
    }


</script>

</body>
</html>