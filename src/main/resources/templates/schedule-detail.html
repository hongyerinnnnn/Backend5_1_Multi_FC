<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title th:text="'ê²½ê¸° ìƒì„¸ (ID: ' + ${matchId} + ') - MULTI FC'">MULTI FC - ì¼ì • ìƒì„¸</title>

    <link rel="stylesheet" th:href="@{/css/style.css}">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700;900&family=Noto+Sans+KR:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">

    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>

    <style>
        /* --- ê¸°ì¡´ ìŠ¤íƒ€ì¼ ìœ ì§€ --- */
        .schedule-search-main { padding: 100px 40px 40px 40px; background-color: #f7f7f7; min-height: 100vh; }
        .search-container { max-width: 1200px; margin: 0 auto; background: white; padding: 30px; border-radius: 15px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); }
        .search-title { font-size: 28px; font-weight: 700; color: #2c3e50; margin-bottom: 25px; border-bottom: 2px solid #6c5ce7; padding-bottom: 10px; }
        .detail-grid { display: grid; grid-template-columns: 1fr; gap: 30px; }
        @media (min-width: 768px) { .detail-grid { grid-template-columns: 1fr 350px; } }
        .map-area { width: 100%; height: 300px; background-color: #eee; border-radius: 10px; margin-bottom: 20px; display: flex; align-items: center; justify-content: center; font-size: 20px; color: #888; }
        .detail-info-item { display: flex; font-size: 16px; color: #333; margin-bottom: 15px; align-items: center; }
        .detail-info-item i { width: 30px; color: #6c5ce7; font-size: 18px; }
        .status-card { background: #f9f9f9; border: 1px solid #ddd; border-radius: 10px; padding: 20px; }
        .status-card h3 { font-size: 20px; color: #2c3e50; border-bottom: 1px solid #ddd; padding-bottom: 10px; margin-bottom: 15px; }

        /* --- ì°¸ê°€ì ë¦¬ìŠ¤íŠ¸ & ê´€ë¦¬ ë²„íŠ¼ ìŠ¤íƒ€ì¼ (ì‹ ê·œ ì¶”ê°€) --- */
        .participant-list { list-style: none; padding: 0; margin: 10px 0 20px 0; }
        .participant-list li { padding: 10px 0; border-bottom: 1px dashed #eee; }
        .participant-list li:last-child { border-bottom: none; }

        .user-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 4px; }
        .user-info { font-weight: 600; font-size: 15px; color: #333; }
        .user-meta { font-size: 12px; color: #888; }

        /* ë°°ì§€ ìŠ¤íƒ€ì¼ */
        .badge { padding: 2px 6px; border-radius: 4px; font-size: 11px; margin-left: 5px; color: white; }
        .badge-host { background-color: #e74c3c; } /* ë°©ì¥ */
        .badge-me { background-color: #6c5ce7; }   /* ë‚˜ */
        .badge-waiting { background-color: #f39c12; } /* ëŒ€ê¸° */
        .badge-confirmed { background-color: #27ae60; } /* í™•ì • */

        /* ê´€ë¦¬ ë²„íŠ¼ ê·¸ë£¹ */
        .manage-btns { display: flex; gap: 5px; }
        .btn-sm { padding: 4px 8px; border: none; border-radius: 4px; font-size: 12px; cursor: pointer; color: white; }
        .btn-approve { background-color: #27ae60; }
        .btn-reject { background-color: #e74c3c; }
        .btn-approve:hover { background-color: #219150; }
        .btn-reject:hover { background-color: #c0392b; }

        /* í•˜ë‹¨ ë©”ì¸ ë²„íŠ¼ */
        .join-button { width: 100%; padding: 14px; border-radius: 8px; font-weight: 700; font-size: 16px; border: none; cursor: pointer; margin-top: 10px; transition: 0.2s; }
        .btn-join { background-color: #333; color: white; }
        .btn-cancel { background-color: #e74c3c; color: white; }
        .btn-close { background-color: #2c3e50; color: white; } /* ë§ˆê° ë²„íŠ¼ */
        .btn-disabled { background-color: #ccc; color: #666; cursor: not-allowed; }

        .match-status-label { font-weight: 800; margin-left: 10px; }
        .status-open { color: #27ae60; }
        .status-closed { color: #e74c3c; }
    </style>
</head>
<body>

<header class="quick-menu">
    <div class="logo"><a href="/">MULTI FC</a></div>
    <div class="header-icons">
        <a href="/login" id="nav-login-btn" style="margin-right:10px; font-weight:bold; color:#333; display:block;">ë¡œê·¸ì¸</a>
        <button id="profile-menu-toggle" class="profile-icon" style="position: relative; display: none;">
            <i class="fas fa-user-circle"></i>
        </button>
        <div id="profile-menu" class="user-menu">
            <div class="user-info">
                <strong><span id="user-menu-username">íšŒì›</span>ë‹˜</strong>
                <p>í™˜ì˜í•©ë‹ˆë‹¤!</p>
            </div>
            <ul>
                <li><a href="#" id="logout-button"><i class="fas fa-sign-out-alt"></i> ë¡œê·¸ì•„ì›ƒ</a></li>
            </ul>
        </div>
        <button id="menu-toggle" class="menu-toggle-btn"><i class="fas fa-bars"></i></button>
    </div>
    <nav id="main-menu" class="main-nav">
        <ul>
            <li><a href="/"><i class="fas fa-home"></i> ë©”ì¸ (Home)</a></li>
            <li><a href="/fields"><i class="fas fa-search"></i> êµ¬ì¥ê²€ìƒ‰</a></li>
            <li><a href="/community"><i class="fas fa-users"></i> ì»¤ë®¤ë‹ˆí‹°</a></li>
            <li id="nav-chat-link-li"><a href="/chat" id="nav-chat-link"><i class="fas fa-comments"></i> ì‹¤ì‹œê°„ì±„íŒ…</a></li>
        </ul>
    </nav>
</header>

<main class="schedule-search-main">
    <div class="search-container">
        <h1 class="search-title" th:text="'ê²½ê¸° ìƒì„¸ ì •ë³´ (ID: ' + ${matchId} + ')'">ğŸ“… ì¼ì • ìƒì„¸</h1>
        <input type="hidden" id="match-id-hidden" th:value="${matchId}">

        <div class="detail-grid">
            <div class="detail-left-column">
                <div class="map-area" id="map">(KakaoMap APIê°€ í‘œì‹œë  ì˜ì—­)</div>

                <h3>
                    ê²½ê¸° ì •ë³´
                    <span id="match-status-display" class="match-status-label"></span>
                </h3>
                <div class="detail-info-item">
                    <i class="fas fa-calendar-alt"></i>
                    <span id="detail-datetime">ë¡œë”©ì¤‘...</span>
                </div>
                <div class="detail-info-item">
                    <i class="fas fa-map-marker-alt"></i>
                    <span id="detail-location">ë¡œë”©ì¤‘...</span>
                </div>
                <div class="detail-info-item">
                    <i class="fas fa-users"></i>
                    <span id="detail-match-type">ë¡œë”©ì¤‘...</span>
                </div>
                <div class="detail-info-item">
                    <i class="fas fa-medal"></i>
                    <span id="detail-skill-level">ë¡œë”©ì¤‘...</span>
                </div>
            </div>

            <div class="detail-right-column">
                <div class="status-card">
                    <h3>ì°¸ì—¬ í˜„í™©</h3>
                    <strong><span id="current-players">0</span> / <span id="max-players">0</span> ëª…</strong>

                    <ul class="participant-list" id="participant-list">
                    </ul>

                    <div id="button-container">
                    </div>

                    <p id="login-prompt-msg" style="display:none; text-align: center; margin-top: 15px; font-size: 14px;">
                        ì°¸ì—¬í•˜ë ¤ë©´ <a href="/login" style="color: #6c5ce7; font-weight: 600;">ë¡œê·¸ì¸</a>ì´ í•„ìš”í•©ë‹ˆë‹¤.
                    </p>
                </div>
            </div>
        </div>
    </div>
</main>

<script>
    /* =========================================================
       1. ì´ˆê¸°í™” ë° í—¤ë” ì²˜ë¦¬
    ========================================================= */
    let stompClient = null;
    let currentMatchData = null;
    let currentUserId = null;
    const matchId = document.getElementById('match-id-hidden').value;

    document.addEventListener('DOMContentLoaded', async () => {
        // ë¡œê·¸ì¸ ì •ë³´ í™•ì¸
        const token = localStorage.getItem('accessToken');
        const userIdStr = localStorage.getItem('userId');
        const nickname = localStorage.getItem('userNickname');

        if(userIdStr) currentUserId = Number(userIdStr);

        // í—¤ë” UI ì—…ë°ì´íŠ¸
        if (token) {
            document.getElementById('nav-login-btn').style.display = 'none';
            document.getElementById('profile-menu-toggle').style.display = 'block';
            document.getElementById('user-menu-username').textContent = nickname || 'íšŒì›';
        } else {
            document.getElementById('nav-login-btn').style.display = 'block';
            document.getElementById('profile-menu-toggle').style.display = 'none';
        }

        // ë©”ë‰´ ì´ë²¤íŠ¸
        document.getElementById('profile-menu-toggle').addEventListener('click', () => {
            document.getElementById('profile-menu').classList.toggle('show');
        });
        document.getElementById('logout-button').addEventListener('click', (e) => {
            e.preventDefault();
            localStorage.clear();
            window.location.href = '/login';
        });

        // ë°ì´í„° ë¡œë“œ
        await fetchMatchDetail();
        await fetchParticipantList();

        // WebSocket ì—°ê²°
        connectWebSocket();
    });

    /* =========================================================
       2. ë°ì´í„° ë¡œë“œ í•¨ìˆ˜
    ========================================================= */
    async function fetchMatchDetail() {
        try {
            const res = await fetch(`/api/matchrooms/${matchId}`);
            if (!res.ok) throw new Error('ê²½ê¸° ì •ë³´ ë¡œë“œ ì‹¤íŒ¨');
            currentMatchData = await res.json();

            // ì •ë³´ í‘œì‹œ
            document.getElementById('detail-datetime').textContent = `${currentMatchData.matchDate} ${currentMatchData.matchTime}`;
            document.getElementById('detail-location').textContent = `êµ¬ì¥ ID: ${currentMatchData.stadiumId}`;
            document.getElementById('detail-match-type').textContent = `ê°œì¸ ë§¤ì¹­ (${currentMatchData.maxPlayers}ëª…)`;
            document.getElementById('detail-skill-level').textContent = currentMatchData.level;
            document.getElementById('max-players').textContent = currentMatchData.maxPlayers;

            // ìƒíƒœ í‘œì‹œ
            const statusEl = document.getElementById('match-status-display');
            if (currentMatchData.status === 'CLOSED') {
                statusEl.textContent = "(ëª¨ì§‘ ë§ˆê°)";
                statusEl.className = "match-status-label status-closed";
            } else {
                statusEl.textContent = "(ëª¨ì§‘ì¤‘)";
                statusEl.className = "match-status-label status-open";
            }
        } catch (err) { console.error(err); }
    }

    async function fetchParticipantList() {
        try {
            const res = await fetch(`/api/matchrooms/${matchId}/participants/all`);
            if (!res.ok) throw new Error('ì°¸ê°€ì ëª©ë¡ ë¡œë“œ ì‹¤íŒ¨');
            const participants = await res.json();
            renderParticipantList(participants);
        } catch (err) { console.error(err); }
    }

    /* =========================================================
       3. í™”ë©´ ë Œë”ë§ (í•µì‹¬!)
    ========================================================= */
    function renderParticipantList(participants) {
        const listEl = document.getElementById('participant-list');
        listEl.innerHTML = '';

        // í”Œë ˆì´ì–´ ìˆ˜ ì¹´ìš´íŠ¸ (Host ì œì™¸, í™•ì •ëœ ì‚¬ëŒë§Œ ì…€ ìˆ˜ë„ ìˆìŒ. ì—¬ê¸°ì„  ì „ì²´ Player)
        const players = participants.filter(p => p.role === 'Player');
        document.getElementById('current-players').textContent = players.length;

        // ë‚´ê°€ ë°©ì¥ì¸ì§€ í™•ì¸
        const amIHost = (currentMatchData && Number(currentMatchData.hostId) === currentUserId);
        const isClosed = (currentMatchData && currentMatchData.status === 'CLOSED');

        participants.forEach(user => {
            const li = document.createElement('li');

            // ë‹‰ë„¤ì„ í‘œì‹œ
            let nameHtml = `<span class="user-info">${user.nickname}</span>`;

            // ë°°ì§€ í‘œì‹œ
            if (user.role === 'Host') nameHtml += ` <span class="badge badge-host">ë°©ì¥</span>`;
            if (Number(user.userId) === currentUserId) nameHtml += ` <span class="badge badge-me">ë‚˜</span>`;

            // ìƒíƒœ í‘œì‹œ (Playerì¸ ê²½ìš°ë§Œ)
            const status = user.status || 'ëŒ€ê¸°'; // ê¸°ë³¸ê°’ ëŒ€ê¸°
            if (user.role === 'Player') {
                if (status === 'í™•ì •') nameHtml += ` <span class="badge badge-confirmed">í™•ì •</span>`;
                else nameHtml += ` <span class="badge badge-waiting">ëŒ€ê¸°</span>`;
            }

            // ê´€ë¦¬ ë²„íŠ¼ (ë‚´ê°€ ë°©ì¥ì´ê³  + ìƒëŒ€ê°€ Playerì´ê³  + ê²½ê¸°ê°€ ì•ˆ ëë‚¬ì„ ë•Œ)
            let btnHtml = '';
            if (amIHost && user.role === 'Player' && !isClosed) {
                btnHtml = `
                    <div class="manage-btns">
                        ${status === 'ëŒ€ê¸°' ? `<button class="btn-sm btn-approve" onclick="approveUser(${user.userId})">ìˆ˜ë½</button>` : ''}
                        <button class="btn-sm btn-reject" onclick="rejectUser(${user.userId})">ê°•í‡´</button>
                    </div>
                `;
            }

            li.innerHTML = `
                <div class="user-row">
                    <div>${nameHtml}</div>
                    ${btnHtml}
                </div>
                <div class="user-meta">í¬ì§€ì…˜: ${user.position || 'ë¯¸ì •'}</div>
            `;
            listEl.appendChild(li);
        });

        // í•˜ë‹¨ ë©”ì¸ ë²„íŠ¼ ì—…ë°ì´íŠ¸
        renderMainButtons(participants, amIHost, isClosed);
    }

    function renderMainButtons(participants, amIHost, isClosed) {
        const container = document.getElementById('button-container');
        const loginPrompt = document.getElementById('login-prompt-msg');
        container.innerHTML = '';

        if (!currentUserId) {
            loginPrompt.style.display = 'block';
            return;
        }
        loginPrompt.style.display = 'none';

        // 1. ê²½ê¸°ê°€ ë§ˆê°ëœ ê²½ìš°
        if (isClosed) {
            container.innerHTML = `<button class="join-button btn-disabled" disabled>ëª¨ì§‘ì´ ë§ˆê°ë˜ì—ˆìŠµë‹ˆë‹¤</button>`;
            return;
        }

        // 2. ë‚´ê°€ ë°©ì¥ì¸ ê²½ìš° -> [ê²½ê¸° í™•ì •(ë§ˆê°)] ë²„íŠ¼
        if (amIHost) {
            container.innerHTML = `<button class="join-button btn-close" onclick="closeMatch()">ğŸ“¢ ëª¨ì§‘ ë§ˆê° (ê²½ê¸° í™•ì •)</button>`;
            return;
        }

        // 3. ì¼ë°˜ ì°¸ê°€ì
        const isJoined = participants.some(p => Number(p.userId) === currentUserId);
        if (isJoined) {
            container.innerHTML = `<button class="join-button btn-cancel" onclick="cancelMatch()">ì°¸ê°€ ì·¨ì†Œ</button>`;
        } else {
            // ìë¦¬ í™•ì¸ (ì˜ˆ: 10ëª…)
            const currentCount = participants.filter(p => p.role === 'Player').length;
            if (currentCount < currentMatchData.maxPlayers) {
                container.innerHTML = `<button class="join-button btn-join" onclick="joinMatch()">ì°¸ê°€ ì‹ ì²­</button>`;
            } else {
                container.innerHTML = `<button class="join-button btn-disabled" disabled>ì •ì› ì´ˆê³¼</button>`;
            }
        }
    }

    /* =========================================================
       4. ì•¡ì…˜ í•¨ìˆ˜ë“¤ (API í˜¸ì¶œ)
    ========================================================= */

    // ì°¸ê°€ ì‹ ì²­
    window.joinMatch = async () => {
        if (!confirm("ì°¸ê°€ ì‹ ì²­í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
        await fetch(`/api/matchrooms/${matchId}/join`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ userId: currentUserId })
        });
    };

    // ì°¸ê°€ ì·¨ì†Œ
    window.cancelMatch = async () => {
        if (!confirm("ì •ë§ ì·¨ì†Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
        await fetch(`/api/matchrooms/${matchId}/cancel`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ userId: currentUserId })
        });
    };

    // [ë°©ì¥] ì°¸ê°€ì ìˆ˜ë½
    window.approveUser = async (targetId) => {
        if (!confirm("ì´ ì°¸ê°€ìë¥¼ ìˆ˜ë½í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
        await fetch(`/api/matchrooms/${matchId}/approve`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ userId: targetId })
        });
    };

    // [ë°©ì¥] ì°¸ê°€ì ê°•í‡´
    window.rejectUser = async (targetId) => {
        if (!confirm("ì´ ì°¸ê°€ìë¥¼ ê°•í‡´í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
        await fetch(`/api/matchrooms/${matchId}/reject`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ userId: targetId })
        });
    };

    // [ë°©ì¥] ê²½ê¸° í™•ì • (ë§ˆê°)
    window.closeMatch = async () => {
        if (!confirm("ëª¨ì§‘ì„ ë§ˆê°í•˜ê³  ë§¤ì¹­ì„ í™•ì •í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n(ë” ì´ìƒ ì°¸ê°€ìë¥¼ ë°›ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤)")) return;
        const res = await fetch(`/api/matchrooms/${matchId}/close`, { method: 'POST' });
        if (res.ok) {
            alert("ë§¤ì¹­ì´ í™•ì •ë˜ì—ˆìŠµë‹ˆë‹¤!");
            location.reload(); // ìƒíƒœ ë³€ê²½ ë°˜ì˜ì„ ìœ„í•´ ìƒˆë¡œê³ ì¹¨
        }
    };

    /* =========================================================
       5. WebSocket (ì‹¤ì‹œê°„ ê°±ì‹ )
    ========================================================= */
    function connectWebSocket() {
        const socket = new SockJS('/ws');
        stompClient = Stomp.over(socket);
        stompClient.connect({}, () => {
            console.log("WebSocket Connected");
            // ì°¸ê°€ì ë³€ê²½ êµ¬ë…
            stompClient.subscribe(`/topic/matchroom/${matchId}/participants`, () => {
                console.log("Update detected, refreshing list...");
                fetchParticipantList(); // ëª©ë¡ ë‹¤ì‹œ ë¶ˆëŸ¬ì˜¤ê¸°
            });
        }, (err) => console.error("WebSocket Error:", err));
    }

</script>

</body>
</html>