<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title th:text="'경기 상세 (ID: ' + ${matchId} + ') - MULTI FC'">MULTI FC - 경기 상세</title>

    <link rel="stylesheet" th:href="@{/css/style.css}">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700;900&family=Noto+Sans+KR:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet"
          href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">

    <!-- Kakao Map -->
    <script src="//dapi.kakao.com/v2/maps/sdk.js?appkey=4caaf2cb0e09303d4dd13d3fb5ff15e9&libraries=services"></script>

    <!-- WebSocket: SockJS + STOMP -->
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>

    <style>
        .schedule-main { padding: 100px 40px; background: #f7f7f7; min-height: 100vh; }
        .container { max-width: 1100px; margin: 0 auto; background: #fff; padding: 30px; border-radius: 15px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1); }

        h1 { font-size: 28px; font-weight: 700; color: #2c3e50;
            border-bottom: 2px solid #6c5ce7; padding-bottom: 10px; margin-bottom: 25px; }

        .grid { display: grid; grid-template-columns: 1fr 350px; gap: 30px; }

        .map-area { width:100%; height:300px; background:#eee; border-radius:10px;
            display:flex; align-items:center; justify-content:center; }

        .info-item { display:flex; align-items:center; margin-bottom:12px; font-size:16px; }
        .info-item i { width:25px; color:#6c5ce7; margin-right:10px; }

        .status-card { background:#fafafa; padding:20px; border-radius:10px; border:1px solid #ddd; }
        .participant-list { list-style:none; padding:0; margin-top:10px; }
        .participant-list li { padding:8px 5px; border-bottom:1px solid #eee; }

        .join-btn { margin-top:20px; width:100%; padding:12px; font-size:16px;
            border:none; border-radius:8px; background:#6c5ce7; color:white; font-weight:700; cursor:pointer; }
        .join-btn:hover { background:#4b3ecf; }
    </style>
</head>

<body>
<header class="quick-menu">
    <div class="logo"><a href="/">MULTI FC</a></div>
</header>

<main class="schedule-main">
    <div class="container">
        <h1 th:text="'경기 상세 정보 (ID: ' + ${matchId} + ')'">경기 상세 정보</h1>

        <!-- matchId 전달 -->
        <input type="hidden" id="match-id" th:value="${matchId}">

        <div class="grid">
            <!-- 왼쪽: 지도 + 경기 정보 -->
            <div>
                <div id="map" class="map-area">(지도 로딩중)</div>

                <h3 style="margin-top:20px;">경기 정보</h3>

                <div class="info-item">
                    <i class="fas fa-calendar-alt"></i>
                    <span id="match-date">-</span>
                </div>

                <div class="info-item">
                    <i class="fas fa-clock"></i>
                    <span id="match-time">-</span>
                </div>

                <div class="info-item">
                    <i class="fas fa-map-marker-alt"></i>
                    <span id="stadium-name">-</span>
                </div>

                <div class="info-item">
                    <i class="fas fa-users"></i>
                    <span id="max-players">-</span>
                </div>

                <div class="info-item">
                    <i class="fas fa-medal"></i>
                    <span id="match-level">-</span>
                </div>
            </div>

            <!-- 오른쪽: 참여 상태 -->
            <div class="status-card">
                <h3>참여 현황</h3>

                <strong><span id="current-players">0</span> / <span id="max-players-count">0</span> 명</strong>

                <ul id="participant-list" class="participant-list"></ul>

                <button id="join-btn" class="join-btn">참여하기</button>
            </div>
        </div>
    </div>
</main>

<script>
    let stompClient = null;

    /* Kakao Map */
    function loadMap(lat, lng) {
        const mapContainer = document.getElementById('map');
        const center = new kakao.maps.LatLng(lat, lng);
        const map = new kakao.maps.Map(mapContainer, { center: center, level: 3 });
        new kakao.maps.Marker({ position: center, map: map });
    }

    /* API 호출 */
    async function loadMatchDetail(matchId) {
        const res = await fetch(`/api/matchrooms/${matchId}`);
        if (!res.ok) throw new Error("match 조회 실패");
        return res.json();
    }

    async function loadStadiumDetail(stadiumId) {
        const res = await fetch(`/api/stadiums`);
        if (!res.ok) throw new Error("stadiums 조회 실패");
        const list = await res.json();
        return list.find(s => s.stadiumId == stadiumId);
    }

    async function loadParticipants(matchId) {
        const res = await fetch(`/api/matchrooms/${matchId}/participants`);
        if (!res.ok) throw new Error("participants 조회 실패");
        return res.json(); // [userId...]
    }

    /* 참여자 렌더링 */
    function renderParticipants(participants, maxPlayers) {
        const list = document.getElementById("participant-list");
        const currentEl = document.getElementById("current-players");
        const maxEl = document.getElementById("max-players-count");

        list.innerHTML = "";

        participants.forEach(uid => {
            const li = document.createElement("li");
            li.textContent = `참여자 ID: ${uid}`;
            list.appendChild(li);
        });

        currentEl.textContent = participants.length;
        maxEl.textContent = maxPlayers;
    }

    async function refreshParticipants(matchId, maxPlayers) {
        const participants = await loadParticipants(matchId);
        renderParticipants(participants, maxPlayers);
    }

    /* WebSocket 연결 */
    function connectParticipantWebSocket(matchId, maxPlayers) {
        const socket = new SockJS('/ws');
        stompClient = Stomp.over(socket);

        stompClient.connect({}, () => {
            console.log("WS connected");

            stompClient.subscribe(`/topic/matchroom/${matchId}/participants`, (message) => {
                const event = JSON.parse(message.body);
                console.log("participant event:", event);
                // 이벤트 받을 때마다 목록 새로고침
                refreshParticipants(matchId, maxPlayers);
            });
        }, err => {
            console.error("WS error", err);
        });
    }

    async function init() {
        const matchId = document.getElementById("match-id").value;
        if (!matchId) {
            console.error("matchId 없음");
            return;
        }

        // 1) 경기 데이터
        const match = await loadMatchDetail(matchId);

        document.getElementById("match-date").textContent = match.matchDate;
        document.getElementById("match-time").textContent = match.matchTime;
        document.getElementById("max-players").textContent = `${match.maxPlayers}명 모집`;
        document.getElementById("match-level").textContent = `레벨: ${match.level}`;
        document.getElementById("max-players-count").textContent = match.maxPlayers;

        // 2) 구장 데이터
        const stadium = await loadStadiumDetail(match.stadiumId);
        if (stadium) {
            document.getElementById("stadium-name").textContent = stadium.name;
            loadMap(stadium.latitude, stadium.longitude);
        } else {
            document.getElementById("stadium-name").textContent = "구장 정보 없음";
        }

        // 3) 초기 참여자 목록
        await refreshParticipants(matchId, match.maxPlayers);

        // 4) WebSocket 연결
        connectParticipantWebSocket(matchId, match.maxPlayers);

        // 5) 참여하기 버튼
        document.getElementById("join-btn").onclick = async () => {
            const userId = Number(localStorage.getItem("userId") || 0);
            if (!userId) {
                alert("로그인이 필요합니다.");
                return window.location.href = "/login";
            }

            const res = await fetch(`/api/matchrooms/${matchId}/join`, {
                method: "POST",
                headers: {"Content-Type": "application/json"},
                body: JSON.stringify({userId})
            });

            if (!res.ok) {
                alert("참여 실패");
                return;
            }

            alert("참여되었습니다!");
            // 이 클라이언트도 WS를 구독하고 있어서
            // 서버에서 broadcast한 event를 받아서 목록이 자동 갱신됨
        };
    }

    document.addEventListener("DOMContentLoaded", init);
</script>

</body>
</html>
