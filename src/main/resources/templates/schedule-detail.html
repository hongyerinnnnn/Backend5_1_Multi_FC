<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title th:text="'ê²½ê¸° ìƒì„¸ (ID: ' + ${matchId} + ') - MULTI FC'">MULTI FC - ì¼ì • ìƒì„¸</title>

    <link rel="stylesheet" th:href="@{/css/style.css}">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700;900&family=Noto+Sans+KR:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">

    <style>
        .schedule-search-main {
            padding: 100px 40px 40px 40px;
            background-color: #f7f7f7;
            min-height: 100vh;
        }
        .search-container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        }
        .search-title {
            font-size: 28px;
            font-weight: 700;
            color: #2c3e50;
            margin-bottom: 25px;
            border-bottom: 2px solid #6c5ce7;
            padding-bottom: 10px;
        }

        /* (â˜…) ìƒì„¸ í˜ì´ì§€ ì „ìš© ìŠ¤íƒ€ì¼ */
        .detail-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 30px;
        }
        @media (min-width: 768px) {
            .detail-grid {
                grid-template-columns: 1fr 350px; /* ë„“ì€ í™”ë©´ì—ì„œ 2ì—´ */
            }
        }

        .map-area {
            width: 100%;
            height: 300px;
            background-color: #eee;
            border-radius: 10px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            color: #888;
        }
        .detail-info-item {
            display: flex;
            font-size: 16px;
            color: #333;
            margin-bottom: 15px;
            align-items: center;
        }
        .detail-info-item i {
            width: 30px;
            color: #6c5ce7;
            font-size: 18px;
        }
        .status-card {
            background: #f9f9f9;
            border: 1px solid #ddd;
            border-radius: 10px;
            padding: 20px;
        }
        .status-card h3 {
            font-size: 20px;
            color: #2c3e50;
            border-bottom: 1px solid #ddd;
            padding-bottom: 10px;
            margin-bottom: 15px;
        }
        .participant-list {
            list-style: none;
            padding: 0;
            margin: 10px 0 20px 0;
        }
        /* â­â­ ì°¸ì—¬ì ëª©ë¡ ìƒì„¸ ìŠ¤íƒ€ì¼ (ERD ë°˜ì˜) â­â­ */
        .participant-list li {
            padding: 8px 0;
            color: #555;
            font-size: 15px;
            border-bottom: 1px dashed #eee;
        }
        .participant-list li:last-child {
            border-bottom: none;
        }
        .participant-list .user-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-weight: 600;
        }
        .participant-list .user-info .role-badge {
            font-size: 12px;
            background: #e74c3c;
            color: white;
            padding: 2px 5px;
            border-radius: 5px;
            font-weight: 400;
        }
        .participant-list .detail-info {
            font-size: 12px;
            color: #999;
            margin-top: 3px;
        }
        /* â­â­ ì°¸ì—¬ì ëª©ë¡ ìƒì„¸ ìŠ¤íƒ€ì¼ ë â­â­ */

        .join-button {
            width: 100%;
            padding: 14px;
        }
        .btn-cancel {
            background-color: #e74c3c; /* ì·¨ì†ŒëŠ” ë¹¨ê°„ìƒ‰ */
        }
    </style>
</head>
<body>

<header class="quick-menu">
    <div class="logo"><a href="/">MULTI FC</a></div>
    <div class="header-icons">
        <button id="profile-menu-toggle" class="profile-icon" style="position: relative; display: none;">
            <i class="fas fa-user-circle"></i>
            <span id="notification-badge" class="notification-badge"></span>
        </button>
        <div id="profile-menu" class="user-menu">
            <div class="user-info">
                <strong><span id="user-menu-username">ì‚¬ìš©ì</span>ë‹˜</strong>
                <p>í™˜ì˜í•©ë‹ˆë‹¤!</p>
            </div>
            <ul>
                <li><a href="/notifications" id="nav-notifications-link"><i class="fas fa-bell"></i> ì•Œë¦¼ ëª©ë¡</a></li>
                <li><a href="/mypage"><i class="fas fa-user"></i> ë§ˆì´í˜ì´ì§€</a></li>
                <li><a href="/profile/edit"><i class="fas fa-user-edit"></i> í”„ë¡œí•„ ìˆ˜ì •</a></li>
                <li><a href="#" id="logout-button"><i class="fas fa-sign-out-alt"></i> ë¡œê·¸ì•„ì›ƒ</a></li>
            </ul>
        </div>
        <button id="menu-toggle" class="menu-toggle-btn"><i class="fas fa-bars"></i></button>
    </div>
    <nav id="main-menu" class="main-nav">
        <ul>
            <li><a href="/"><i class="fas fa-home"></i> ë©”ì¸ (Home)</a></li>
            <li><a href="/fields"><i class="fas fa-search"></i> êµ¬ì¥ê²€ìƒ‰</a></li>
            <li><a href="/community"><i class="fas fa-users"></i> ì»¤ë®¤ë‹ˆí‹°</a></li>
            <li id="nav-chat-link-li"><a href="/chat" id="nav-chat-link"><i class="fas fa-comments"></i> ì‹¤ì‹œê°„ì±„íŒ…</a></li>
            <li><a href="/login" id="nav-login-link"><i class="fas fa-sign-in-alt"></i> ë¡œê·¸ì¸</a></li>
            <li style="display:none;"><a href="#" id="nav-logout-link"><i class="fas fa-sign-out-alt"></i> ë¡œê·¸ì•„ì›ƒ</a></li>
        </ul>
    </nav>
</header>

<main class="schedule-search-main">
    <div class="search-container">
        <h1 class="search-title" th:text="'ê²½ê¸° ìƒì„¸ ì •ë³´ (ID: ' + ${matchId} + ')'">ğŸ“… ì¼ì • ìƒì„¸</h1>
        <input type="hidden" id="match-id-hidden" th:value="${matchId}">

        <div class="detail-grid">

            <div class="detail-left-column">
                <div class="map-area" id="map">(KakaoMap APIê°€ í‘œì‹œë  ì˜ì—­)</div>

                <h3>ê²½ê¸° ì •ë³´</h3>
                <div class="detail-info-item">
                    <i class="fas fa-calendar-alt"></i>
                    <span id="detail-datetime">2025-11-01 (í† ) 19:00</span>
                </div>
                <div class="detail-info-item">
                    <i class="fas fa-map-marker-alt"></i>
                    <span id="detail-location">ì„œìš¸ ê°•ë‚¨ í’‹ì‚´ì¥</span>
                </div>
                <div class="detail-info-item">
                    <i class="fas fa-users"></i>
                    <span id="detail-match-type">ê°œì¸ ë§¤ì¹­ (10ëª… ëª¨ì§‘)</span>
                </div>
                <div class="detail-info-item">
                    <i class="fas fa-medal"></i>
                    <span id="detail-skill-level">ì¤‘ê¸‰ ë ˆë²¨ (3.0 ì´ìƒ)</span>
                </div>
                <div class="detail-info-item">
                    <i class="fas fa-info-circle"></i>
                    <span id="detail-info">ì´ˆê¸‰ì í™˜ì˜! ì¦ê²ê²Œ ì°° ë¶„ë“¤ ì˜¤ì„¸ìš”.</span>
                </div>
            </div>

            <div class="detail-right-column">
                <div class="status-card">
                    <h3>ì°¸ì—¬ í˜„í™©</h3>
                    <strong><span id="current-players">4</span> / <span id="max-players">10</span> ëª…</strong>
                    <ul class="participant-list" id="participant-list">
                    </ul>

                    <button id="join-match-btn" class="login-button join-button" style="display:none;" onclick="handleJoin()">ì°¸ì—¬í•˜ê¸°</button>
                    <button id="cancel-match-btn" class="login-button join-button btn-cancel" style="display:none;" onclick="handleCancel()">ì°¸ì—¬ ì·¨ì†Œ</button>

                    <p id="login-prompt-msg" style="display:none; text-align: center; margin-top: 15px; font-size: 14px;">
                        ì°¸ì—¬í•˜ë ¤ë©´ <a href="/login" style="color: #6c5ce7; font-weight: 600;">ë¡œê·¸ì¸</a>ì´ í•„ìš”í•©ë‹ˆë‹¤.
                    </p>
                </div>
            </div>
        </div>
    </div>
</main>

<script>
    // --- (â˜…ê³µí†µâ˜…) ë©”ë‰´ í† ê¸€ ë¡œì§ (ìœ ì§€) ---
    const menuToggle = document.getElementById('menu-toggle');
    const mainMenu = document.getElementById('main-menu');
    const profileMenuToggle = document.getElementById('profile-menu-toggle');
    const profileMenu = document.getElementById('profile-menu');
    const logoutButton = document.getElementById('logout-button');
    const navNotificationsLink = document.getElementById('nav-notifications-link');
    const navChatLinkElement = document.getElementById('nav-chat-link-li');
    const navLoginLink = document.getElementById('nav-login-link');
    const navLogoutLink = document.getElementById('nav-logout-link');

    if (menuToggle) {
        menuToggle.addEventListener('click', () => {
            mainMenu.classList.toggle('show');
            profileMenu.classList.remove('show');
        });
    }
    if (profileMenuToggle) {
        profileMenuToggle.addEventListener('click', () => {
            profileMenu.classList.toggle('show');
            mainMenu.classList.remove('show');
        });
    }
    document.addEventListener('click', (event) => {
        if (!mainMenu.contains(event.target) && !menuToggle.contains(event.target) &&
            !profileMenu.contains(event.target) && !profileMenuToggle.contains(event.target)) {
            mainMenu.classList.remove('show');
            profileMenu.classList.remove('show');
        }
    });
    if (logoutButton) {
        logoutButton.addEventListener('click', (e) => {
            e.preventDefault();
            localStorage.removeItem('accessToken');
            localStorage.removeItem('hasReadReviews');
            localStorage.removeItem('hasReadSchedules');
            window.location.href = '/login';
        });
    }
    if (navNotificationsLink) {
        navNotificationsLink.addEventListener('click', (e) => {
            e.preventDefault();
            localStorage.setItem('hasReadReviews', 'true');
            localStorage.setItem('hasReadSchedules', 'true');
            window.location.href = '/notifications';
        });
    }
    if (navLogoutLink) {
        navLogoutLink.addEventListener('click', (e) => {
            e.preventDefault();
            localStorage.removeItem('accessToken');
            localStorage.removeItem('hasReadReviews');
            localStorage.removeItem('hasReadSchedules');
            window.location.href = '/login';
        });
    }
    // --- (â˜…ê³µí†µâ˜…) ë©”ë‰´ í† ê¸€ ë¡œì§ ë ---


    // â­â­ ë§¤ë„ˆ ì ìˆ˜ ì œê±°: ë”ë¯¸ ì°¸ì—¬ì ë°ì´í„° ìˆ˜ì • â­â­
    // mannerScore í•„ë“œ ì œê±°
    const MOCK_PARTICIPANTS = [
        { id: 101, username: 'captain_son', nickname: 'ìº¡í‹´ì†', position: 'MF', role: 'Host' },
        { id: 102, username: 'closer_kim', nickname: 'êµ¬ì›íˆ¬ìˆ˜', position: 'DF', role: 'Player' },
        { id: 103, username: 'shootdori', nickname: 'ìŠ›ëŒì´', position: 'FW', role: 'Player' },
        { id: 104, username: 'keeper_k', nickname: 'ê³¨í‚¤í¼K', position: 'GK', role: 'Player' },
        // í˜„ì¬ ì‚¬ìš©ì (ì°¸ì—¬ ìƒíƒœ ì‹œë®¬ë ˆì´ì…˜)
        { id: 999, username: 'my_user_id', nickname: 'ë‚˜ì˜ë‹‰ë„¤ì„', position: 'ALA', role: 'Player' }
    ];

    const CURRENT_USER_ID = 999;
    let isParticipating = false;

    // â­â­ ë§¤ë„ˆ ì ìˆ˜ ì œê±°: ì°¸ì—¬ì ëª©ë¡ ë Œë”ë§ í•¨ìˆ˜ ìˆ˜ì • â­â­
    function renderParticipantList(participants) {
        const listEl = document.getElementById('participant-list');
        const currentPlayersEl = document.getElementById('current-players');
        const maxPlayersEl = document.getElementById('max-players');
        listEl.innerHTML = '';

        // í˜„ì¬ ì‚¬ìš©ì ì°¸ì—¬ ìƒíƒœ ì´ˆê¸°í™” ë° í™•ì¸
        isParticipating = participants.some(user => user.id === CURRENT_USER_ID);

        participants.forEach(user => {
            const listItem = document.createElement('li');
            const roleBadge = user.role === 'Host' ? `<span class="role-badge">ì£¼ìµœì</span>` : '';

            const nicknameDisplay = user.id === CURRENT_USER_ID ? `${user.nickname} (ë‚˜)` : `${user.nickname}`;
            const userIdDisplay = user.username ? ` (${user.username})` : '';

            listItem.innerHTML = `
                <div class="user-info">
                    <span>${nicknameDisplay}${userIdDisplay}</span>
                    ${roleBadge}
                </div>
                <div class="detail-info">
                    í¬ì§€ì…˜: ${user.position}
                    </div>
            `;
            listEl.appendChild(listItem);
        });

        // ì¸ì› ìˆ˜ ì—…ë°ì´íŠ¸
        currentPlayersEl.textContent = participants.length;
        maxPlayersEl.textContent = '10'; // ë”ë¯¸ ìµœëŒ€ ì¸ì›

        updateJoinButtonState();
    }

    // â­â­ ë²„íŠ¼ ìƒíƒœ ì—…ë°ì´íŠ¸ í•¨ìˆ˜ (ì´ì „ ë¡œì§ ìœ ì§€) â­â­
    function updateJoinButtonState() {
        const joinBtn = document.getElementById('join-match-btn');
        const cancelBtn = document.getElementById('cancel-match-btn');
        const loginPrompt = document.getElementById('login-prompt-msg');

        const isLoggedIn = localStorage.getItem('accessToken') !== null;

        if (!isLoggedIn) {
            joinBtn.style.display = 'none';
            cancelBtn.style.display = 'none';
            loginPrompt.style.display = 'block';
            return;
        }

        loginPrompt.style.display = 'none';

        if (isParticipating) {
            joinBtn.style.display = 'none';
            cancelBtn.style.display = 'block';
        } else {
            joinBtn.style.display = 'block';
            cancelBtn.style.display = 'none';
        }
    }

    // â­â­ ë§¤ì¹˜ ì°¸ê°€ ë¡œì§ (API í˜¸ì¶œ ì‹œë®¬ë ˆì´ì…˜) â­â­
    function handleJoin() {
        if (confirm("ì •ë§ë¡œ ì´ ê²½ê¸°ì— ì°¸ì—¬í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
            // â­ ë°±ì—”ë“œ API í˜¸ì¶œ: POST /api/match/join/{matchId}
            alert("ì°¸ì—¬ ìš”ì²­ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤. (ì‹œë®¬ë ˆì´ì…˜)");
            // ì„±ê³µ ì‹œ UI ì—…ë°ì´íŠ¸ (mannerScore í•„ë“œ ì—†ìŒ)
            isParticipating = true;
            const newUser = { id: CURRENT_USER_ID, username: 'my_user_id', nickname: 'ë‚˜ì˜ë‹‰ë„¤ì„', position: 'ALA', role: 'Player' };
            MOCK_PARTICIPANTS.push(newUser);
            renderParticipantList(MOCK_PARTICIPANTS);
        }
    }

    // â­â­ ë§¤ì¹˜ ì°¸ê°€ ì·¨ì†Œ ë¡œì§ (API í˜¸ì¶œ ì‹œë®¬ë ˆì´ì…˜) â­â­
    function handleCancel() {
        if (confirm("ì •ë§ë¡œ ì°¸ì—¬ë¥¼ ì·¨ì†Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
            // â­ ë°±ì—”ë“œ API í˜¸ì¶œ: DELETE /api/match/cancel/{matchId}
            alert("ì°¸ì—¬ ì·¨ì†Œ ìš”ì²­ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤. (ì‹œë®¬ë ˆì´ì…˜)");
            // ì„±ê³µ ì‹œ UI ì—…ë°ì´íŠ¸
            isParticipating = false;
            // í˜„ì¬ ì‚¬ìš©ìë¥¼ ëª©ë¡ì—ì„œ ì œê±°
            const updatedParticipants = MOCK_PARTICIPANTS.filter(p => p.id !== CURRENT_USER_ID);
            renderParticipantList(updatedParticipants);
        }
    }


    // --- (â˜…í˜ì´ì§€ë³„â˜…) ë¡œì§ ì‹¤í–‰ ---
    document.addEventListener('DOMContentLoaded', async () => {
        const accessToken = localStorage.getItem('accessToken');
        const matchId = document.querySelector('#match-id-hidden').value; // ìˆ¨ê²¨ì§„ í•„ë“œì—ì„œ ID ê°€ì ¸ì˜¤ê¸°

        // ê³µí†µ ì•Œë¦¼ ë° ì¸ì¦ ë¡œì§ ì‹¤í–‰
        if (accessToken) {
            document.getElementById('profile-menu-toggle').style.display = 'block';

            // ë¡œê·¸ì¸/ë¡œê·¸ì•„ì›ƒ ë©”ë‰´ ìƒíƒœ ì„¤ì •
            if (navLoginLink) navLoginLink.parentElement.style.display = 'none';
            if (navLogoutLink) navLogoutLink.parentElement.style.display = 'list-item';

            // ... (ì•Œë¦¼ ì²´í¬ ë° ë°°ì§€ ì—…ë°ì´íŠ¸) ...
        } else {
            // ë¹„íšŒì› ìƒíƒœì¼ ê²½ìš° ë©”ë‰´ ì„¤ì •
            if (navLoginLink) navLoginLink.parentElement.style.display = 'list-item';
            if (navLogoutLink) navLogoutLink.parentElement.style.display = 'none';
        }

        // â­â­ ë³´ê°•: ë©”ë‰´ë°”ì˜ ì±„íŒ… ë§í¬ í´ë¦­ ë°©ì§€ (íšŒì›ë§Œ í—ˆìš©) â­â­
        if (navChatLinkElement) {
            const chatLinkAnchor = navChatLinkElement.querySelector('a');
            if (chatLinkAnchor && !accessToken) {
                chatLinkAnchor.addEventListener('click', function(e) {
                    e.preventDefault();
                    alert("âŒ ì‹¤ì‹œê°„ ì±„íŒ…ì€ íšŒì›ë§Œ ì´ìš©í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
                    window.location.href = '/login';
                });
            }
        }

        // ë”ë¯¸ ë°ì´í„° ì´ˆê¸° ë Œë”ë§
        renderParticipantList(MOCK_PARTICIPANTS);
    });
</script>
</body>
</html>