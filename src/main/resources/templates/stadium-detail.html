<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title th:text="'구장 상세 (' + ${stadiumId} + ') - MULTI FC'">MULTI FC - 구장 상세</title>
    <link rel="stylesheet" th:href="@{/css/style.css}">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700;900&family=Noto+Sans+KR:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <script src="//dapi.kakao.com/v2/maps/sdk.js?appkey=4caaf2cb0e09303d4dd13d3fb5ff15e9&libraries=services"></script>
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>

    <style>
        /* 원래 CSS 완벽 복구 */
        .stadium-main { padding: 100px 40px 40px 40px; background-color: #f7f7f7; min-height: 100vh; }
        .stadium-container { max-width: 1200px; margin: 0 auto; background: white; padding: 40px; border-radius: 15px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); display: grid; grid-template-columns: 1fr 400px; gap: 30px; }
        .stadium-title { grid-column: 1 / -1; font-size: 32px; font-weight: 800; color: #333; margin-bottom: 5px; border-bottom: 3px solid #6c5ce7; padding-bottom: 10px; }
        .detail-left-column { grid-column: 1 / 2; display: flex; flex-direction: column; }
        .map-area { width: 100%; height: 350px; background-color: #eee; border-radius: 10px; margin-bottom: 25px; display: flex; align-items: center; justify-content: center; font-size: 20px; color: #888; }
        .review-right-column { grid-column: 2 / 3; grid-row: 2 / span 2; background: #fcfcfc; border-radius: 10px; padding: 15px; border: 1px solid #ddd; max-height: 685px; overflow-y: auto; }
        .info-card { border: 1px solid #ddd; border-radius: 10px; padding: 20px; margin-top: 0; }
        .info-card h2{ margin-bottom: 20px; }
        .info-item { display: flex; align-items: center; margin-bottom: 10px; font-size: 16px; }
        .info-item i { width: 25px; color: #6c5ce7; margin-right: 10px; }
        .action-button-group { text-align: center; grid-column: 1 / 2; display: flex; justify-content: center; gap: 15px; }
        .action-button-group a, .action-button-group button { display: inline-block; padding: 14px 28px; font-weight: 700; border-radius: 30px; text-decoration: none; transition: all 0.3s ease; box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1); font-size: 16px; flex-grow: 0; flex-shrink: 0; border:none; cursor:pointer; }
        .btn-schedule { background-color: #333; color: white; border: 2px solid #1a1a1a; }
        .btn-schedule:hover { background-color: #1a1a1a; transform: translateY(-2px); box-shadow: 0 6px 12px rgba(0, 0, 0, 0.3); }
        .btn-create-match { background-color: #e74c3c; color: white; border: 2px solid #c0392b; }
        .btn-create-match:hover { background-color: #c0392b; transform: translateY(-2px); box-shadow: 0 6px 12px rgba(231, 76, 60, 0.3); }
        .review-right-column h2 { font-size: 24px; color: #333; margin-bottom: 15px; }
        #match-list { margin-top: 10px; border-top: 1px solid #eee; }
        .match-item { padding: 10px 0; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; cursor: pointer; }
        .match-item:last-child { border-bottom: none; }
        .match-item-time { font-weight: 700; color: #333; }
        .match-item-meta { font-size: 13px; color: #777; }
        .match-item:hover .match-item-time { text-decoration: underline; }
        .match-status { font-weight: 700; margin-left: 4px; }
        .match-status.open { color: #27ae60; }
        .match-status.closed { color: #e74c3c; }
        .tab-header { display: flex; border-bottom: 2px solid #eee; margin-bottom: 15px; }
        .tab-button { flex: 1; text-align: center; padding: 10px 0; cursor: pointer; font-weight: 700; font-size: 15px; border: none; background: none; outline: none; transition: all 0.2s ease; }
        .tab-button.active { color: #6c5ce7; border-bottom: 3px solid #6c5ce7; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }

        /* 모달 */
        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.5); display: none; align-items: center; justify-content: center; z-index: 999; }
        .modal-overlay.show { display: flex; }
        .modal-content { background: #fff; border-radius: 15px; padding: 25px; width: 90%; max-width: 600px; box-shadow: 0 10px 25px rgba(0,0,0,0.25); }
        .modal-content h2 { font-size: 24px; margin-bottom: 15px; font-weight: 800; color: #2c3e50; }
        .modal-content label { display: block; font-size: 15px; font-weight: 700; color: #34495e; margin-top: 10px; margin-bottom: 6px; }
        .modal-content input, .modal-content select { width: 100%; padding: 10px; font-size: 15px; border: 1px solid #ddd; border-radius: 8px; background-color: #f9f9f9; color: #333; box-sizing: border-box; }
        .modal-actions { display: flex; justify-content: flex-end; gap: 10px; margin-top: 20px; }
        .btn-cancel { background-color: #e0e0e0; color: #555; padding: 8px 16px; border-radius: 8px; border: none; font-weight: 700; cursor: pointer; }
        .btn-create { background-color: #333; color: #fff; padding: 8px 16px; border-radius: 8px; border: none; font-weight: 700; cursor: pointer; }

        /* 헤더 스타일 (공통) */
        .user-menu { position: absolute; top: 60px; right: 20px; background: white; border: 1px solid #ddd; border-radius: 10px; padding: 15px; display: none; width: 200px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); z-index: 1000; }
        .user-menu.show { display: block; }
    </style>
</head>
<body>

<header class="quick-menu">
    <div class="logo"><a href="/">MULTI FC</a></div>
    <div class="header-icons">
        <a href="/login" id="nav-login-btn" style="margin-right:10px; font-weight:bold; color:#333; display:block;">로그인</a>
        <button id="profile-menu-toggle" class="profile-icon" style="position: relative; display: none; background:none; border:none; font-size:24px; cursor:pointer;">
            <i class="fas fa-user-circle"></i>
        </button>
        <div id="profile-menu" class="user-menu">
            <div class="user-info">
                <strong><span id="user-menu-username">회원</span>님</strong>
                <p>환영합니다!</p>
            </div>
            <ul>
                <li><a href="#" id="logout-button"><i class="fas fa-sign-out-alt"></i> 로그아웃</a></li>
            </ul>
        </div>
        <button id="menu-toggle" class="menu-toggle-btn" style="background:none; border:none; font-size:20px;"> <i class="fas fa-bars"></i> </button>
    </div>
    <nav id="main-menu" class="main-nav">
        <ul>
            <li><a href="/"><i class="fas fa-home"></i> 메인 (Home)</a></li>
            <li><a href="/fields" class="active"><i class="fas fa-search"></i> 구장검색</a></li>
            <li><a href="/community"><i class="fas fa-users"></i> 커뮤니티</a></li>
            <li id="nav-chat-link-li"><a href="/chat" id="nav-chat-link"><i class="fas fa-comments"></i> 실시간채팅</a></li>
        </ul>
    </nav>
</header>

<main class="stadium-main">
    <div class="stadium-container">
        <h1 class="stadium-title" id="stadium-name">구장 정보 로딩중... (ID: <span th:text="${stadiumId}"></span>)</h1>

        <div class="detail-left-column">
            <div class="map-area" id="map"></div>
            <div class="info-card">
                <h2>구장 기본 정보</h2>
                <div class="info-item"><i class="fas fa-map-marker-alt"></i> <span id="stadium-address">주소</span></div>
                <div class="info-item"><i class="fas fa-phone"></i> <span id="stadium-contact">-</span></div>
                <div class="info-item"><i class="fas fa-won-sign"></i> <span id="stadium-fee">-</span></div>
                <div class="info-item"><i class="fas fa-users"></i> <span id="stadium-size">-</span></div>
            </div>
        </div>

        <div class="review-right-column">
            <div class="tab-header">
                <button id="tab-btn-match" class="tab-button active">경기</button>
                <button id="tab-btn-review" class="tab-button">후기</button>
            </div>
            <div id="tab-match" class="tab-content active">
                <h2 style="font-size: 24px; color: #333; margin-bottom: 15px;">⚽ 경기 정보</h2>
                <div class="match-filter">
                    <label for="match-date-filter">날짜 선택</label>
                    <input type="date" id="match-date-filter">
                </div>
                <div id="match-list" class="match-list">
                    <p style="color:#777; font-size:13px; padding:10px 0;">날짜를 선택하면 경기가 표시됩니다.</p>
                </div>
            </div>
            <div id="tab-review" class="tab-content">
                <h2 style="font-size: 24px; color: #333; margin-bottom: 15px;">⭐ 구장 리뷰</h2>
                <div id="review-list"></div>
            </div>
        </div>

        <div class="action-button-group">
            <a href="/schedule?stadiumId=1" class="btn-schedule" id="btn-schedule"><i class="fas fa-calendar-alt"></i> 매치/일정 확인</a>
            <button class="btn-create-match" id="btn-create-match"><i class="fas fa-plus-circle"></i> 경기 생성</button>
        </div>
    </div>
</main>

<div id="match-create-modal" class="modal-overlay">
    <div class="modal-content">
        <h2>경기 개설</h2>
        <label>주최자</label>
        <input type="text" id="hostName" readonly>
        <label>장소</label>
        <input type="text" id="stadiumName" readonly>
        <input type="hidden" id="stadiumId">
        <label>날짜</label>
        <input type="date" id="matchDate">
        <label>시간</label>
        <div class="time-select-group">
            <select id="startTime"></select> <span>~</span> <select id="endTime"></select>
        </div>
        <div class="modal-actions">
            <button class="btn-cancel" onclick="openMatchModal(false)">취소</button>
            <button class="btn-create" onclick="submitMatchForm()">생성</button>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', async () => {
        // 1. 헤더 및 로그인 상태 확인
        const token = localStorage.getItem('accessToken');
        const nickname = localStorage.getItem('userNickname');

        if (token) {
            document.getElementById('nav-login-btn').style.display = 'none';
            document.getElementById('profile-menu-toggle').style.display = 'block';
            document.getElementById('user-menu-username').textContent = nickname || '회원';
        } else {
            document.getElementById('nav-login-btn').style.display = 'block';
            document.getElementById('profile-menu-toggle').style.display = 'none';
        }

        // 메뉴 이벤트
        document.getElementById('profile-menu-toggle')?.addEventListener('click', () => document.getElementById('profile-menu').classList.toggle('show'));
        document.getElementById('menu-toggle')?.addEventListener('click', () => document.getElementById('main-menu').classList.toggle('show'));
        document.getElementById('logout-button')?.addEventListener('click', (e) => {
            e.preventDefault();
            localStorage.clear();
            window.location.href = '/login';
        });

        // 2. 구장 정보 로드
        const stadiumId = new URLSearchParams(window.location.search).get('id');
        if(stadiumId) {
            const stadium = await (await fetch('/api/stadiums')).json().then(list => list.find(s => s.stadiumId == stadiumId));
            if(stadium) {
                document.getElementById('stadium-name').textContent = `${stadium.name} (ID: ${stadiumId})`;
                document.getElementById('stadium-address').textContent = stadium.address;
                document.getElementById('stadiumName').value = stadium.name;
                document.getElementById('stadiumId').value = stadiumId;

                if (window.kakao && kakao.maps) {
                    const map = new kakao.maps.Map(document.getElementById('map'), { center: new kakao.maps.LatLng(stadium.latitude, stadium.longitude), level: 3 });
                    new kakao.maps.Marker({ position: map.getCenter(), map: map });
                }
            }
            // 경기 목록
            let allMatches = await (await fetch(`/api/matchrooms/stadium/${stadiumId}`)).json();

            const today = new Date().toISOString().split("T")[0];
            document.getElementById('match-date-filter').value = today;
            renderMatches(allMatches, today);

            document.getElementById('match-date-filter').addEventListener('change', (e) => renderMatches(allMatches, e.target.value));

            // WebSocket
            const socket = new SockJS('/ws');
            const stompClient = Stomp.over(socket);
            stompClient.connect({}, () => {
                stompClient.subscribe(`/topic/matches/${stadiumId}`, (msg) => {
                    allMatches.push(JSON.parse(msg.body));
                    renderMatches(allMatches, document.getElementById('match-date-filter').value);
                });
            });
        }

        // 3. 경기 생성
        document.getElementById('btn-create-match').addEventListener('click', (e) => {
            e.preventDefault();
            if (!localStorage.getItem('accessToken')) {
                alert('로그인이 필요합니다.');
                return location.href = '/login';
            }
            document.getElementById('hostName').value = localStorage.getItem('userNickname') || '회원';
            setupTime();
            openMatchModal(true);
        });
    });

    function renderMatches(matches, date) {
        const list = document.getElementById('match-list');
        const filtered = matches.filter(m => m.matchDate === date);
        list.innerHTML = filtered.length ? filtered.map(m =>
            `<div class="match-item"><div class="match-item-time">${m.matchTime}</div><div class="match-item-meta">최대인원: ${m.maxPlayers}명 · <span class="match-status ${m.status==='closed'?'closed':'open'}">${m.status==='closed'?'마감':'모집중'}</span></div></div>`
        ).join('') : '<p style="color:#777; padding:10px 0;">등록된 경기가 없습니다.</p>';

        // 리스트 아이템 클릭 이벤트
        document.querySelectorAll('.match-item').forEach((el, idx) => {
            el.addEventListener('click', () => location.href=`/schedule/detail/${filtered[idx].roomId}`);
        });
    }

    function openMatchModal(show) {
        document.getElementById('match-create-modal').style.display = show ? 'flex' : 'none';
    }

    function setupTime() {
        const start = document.getElementById("startTime");
        const end = document.getElementById("endTime");
        start.innerHTML = ""; end.innerHTML = "";
        for(let i=0; i<24; i++) {
            const t = `${i < 10 ? '0'+i : i}:00`;
            start.innerHTML += `<option>${t}</option>`;
            end.innerHTML += `<option>${t}</option>`;
        }
        start.value = "19:00"; end.value = "20:00";
    }

    async function submitMatchForm() {
        // ★★★ 핵심: ID 가져오기 ★★★
        const hostId = localStorage.getItem('userId');
        if(!hostId) { alert("로그인 정보가 없습니다."); location.href='/login'; return; }

        const req = {
            stadiumId: Number(document.getElementById('stadiumId').value),
            hostId: Number(hostId),
            matchDate: document.getElementById('matchDate').value,
            matchTime: document.getElementById('startTime').value,
            maxPlayers: 10,
            level: "초급"
        };

        const res = await fetch('/api/matchrooms', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(req)
        });

        if(res.ok) {
            alert("경기 생성 완료!");
            openMatchModal(false);
            // WebSocket이 화면 갱신함
        } else {
            alert("생성 실패");
        }
    }

    window.openMatchModal = openMatchModal;
    window.submitMatchForm = submitMatchForm;
</script>

</body>
</html>