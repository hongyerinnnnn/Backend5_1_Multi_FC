<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FUTSAL MATCH - 마이페이지</title>

    <link rel="stylesheet" th:href="@{/css/style.css}">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700;900&family=Noto+Sans+KR:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">

    <style>
        /* 기존 스타일 유지 (생략) */
        .info-view-group { margin-bottom: 20px; }
        .info-view-group label { display: block; font-weight: 700; margin-bottom: 6px; color: #2c3e50; font-size: 14px; }
        .info-view-text { width: 100%; padding: 12px 15px; border: 1px solid #ddd; border-radius: 10px; font-size: 16px; background: #f7f7f7; color: #333; min-height: 47px; box-sizing: border-box; display: flex; align-items: center; }
        .info-view-profile-pic { width: 120px; height: 120px; border-radius: 50%; object-fit: cover; border: 3px solid #eee; margin-bottom: 15px; }

        /* --- 친구 관리 탭 전용 스타일 (2단계 탭 및 와이어프레임 레이아웃) --- */
        .tab-buttons.sub-tabs { display: flex; margin-bottom: 20px; border-bottom: 1px solid #eee; }
        .tab-buttons.sub-tabs .sub-tab-btn { flex-grow: 1; padding: 10px 15px; background-color: #f0f0f0; border: 1px solid #ddd; border-bottom: none; border-radius: 8px 8px 0 0; cursor: pointer; font-size: 15px; color: #555; transition: all 0.2s ease; margin-right: 5px; text-align: center; }
        .tab-buttons.sub-tabs .sub-tab-btn:last-child { margin-right: 0; }
        .tab-buttons.sub-tabs .sub-tab-btn.active { background-color: #6c5ce7; color: white; border-color: #6c5ce7; position: relative; top: 1px; z-index: 1; }
        .sub-tab-content { display: none; padding: 20px 0; border-top: 1px solid #eee; }
        .sub-tab-content.active { display: block; }

        /* 친구 검색 그룹 (친구 목록 탭) */
        .friend-list-search-group { display: flex; gap: 10px; margin-bottom: 20px; }
        .friend-list-search-group input { flex-grow: 1; padding: 10px; border: 1px solid #ddd; border-radius: 5px; }
        .friend-list-search-group button { padding: 10px 15px; background-color: #6c5ce7; color: white; border: none; border-radius: 5px; cursor: pointer; }

        /* 친구 목록 아이템 */
        .friend-item-list { list-style: none; padding: 0; margin: 0; }
        .friend-item-list li {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px;
            border: 1px solid #eee;
            border-radius: 8px;
            margin-bottom: 10px;
            background-color: #fdfdfd;
            box-shadow: 0 1px 2px rgba(0,0,0,0.03);
            font-size: 16px;
            cursor: pointer;
            position: relative;
            overflow: hidden;
            transition: background-color 0.2s ease;
        }
        .friend-item-list li:hover {
            background-color: #f0f0f0;
        }
        .friend-item-list li.active {
            background-color: #e6e6ff;
            border-color: #6c5ce7;
        }
        .friend-item-list li strong {
            flex-grow: 1;
            color: #333;
            margin-right: 150px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .action-buttons {
            display: none;
            position: absolute;
            right: 12px;
            top: 50%;
            transform: translateY(-50%);
            gap: 8px;
            background-color: inherit;
            padding-left: 10px;
            z-index: 10;
        }
        .friend-item-list li.active .action-buttons {
            display: flex;
        }
        .action-buttons button {
            padding: 8px 12px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
            white-space: nowrap;
            transition: background-color 0.2s ease;
        }
        .action-buttons .btn-chat {
            background-color: #4a90e2;
            color: white;
        }
        .action-buttons .btn-delete {
            background-color: #ff7675;
            color: white;
        }

        /* 친구 추가 탭 스타일 (기존 유지) */
        .friend-add-search-group { display: flex; gap: 10px; margin-bottom: 20px; }
        .friend-add-search-group input { flex-grow: 1; padding: 10px; border: 1px solid #ddd; border-radius: 5px; }
        .friend-add-search-group button { padding: 10px 15px; background-color: #6c5ce7; color: white; border: none; border-radius: 5px; cursor: pointer; }
        .friend-add-result-item { display: flex; align-items: center; justify-content: space-between; padding: 10px 12px; border: 1px solid #eee; border-radius: 8px; margin-bottom: 8px; background-color: #fdfdfd; box-shadow: 0 1px 2px rgba(0,0,0,0.03); font-size: 15px; }
        .friend-add-actions { margin-top: 20px; text-align: right; }
        .friend-add-actions .btn-add-selected { padding: 10px 20px; background-color: #2ecc71; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 16px; }

        /* 마이페이지 고유 스타일: 매너/실력 섹션 */
        .score-display {
            display: flex;
            justify-content: space-around;
            margin-bottom: 30px;
            padding: 15px;
            background: #e6e6ff;
            border-radius: 10px;
        }
        .score-item {
            text-align: center;
            font-size: 14px;
            color: #2c3e50;
        }
        .score-item strong {
            display: block;
            font-size: 26px;
            font-weight: 800;
            color: #6c5ce7;
            margin-top: 5px;
        }

        /* 캘린더 이벤트 색상 구분 (match/private 타입 반영) */
        .calendar-event.match-event {
            background-color: rgba(108, 92, 231, 0.2); /* 매치: 보라색 */
            border-left: 3px solid #6c5ce7;
        }
        .calendar-event.private-event {
            background-color: rgba(231, 76, 60, 0.2); /* 개인: 빨간색 */
            border-left: 3px solid #e74c3c;
        }
    </style>
</head>
<body>

<header class="quick-menu">
    <div class="logo"><a href="/">FUTSAL MATCH</a></div>
    <div class="header-icons">
        <button id="profile-menu-toggle" class="profile-icon" style="position: relative; display: none;">
            <i class="fas fa-user-circle"></i>
            <span id="notification-badge" class="notification-badge"></span>
        </button>
        <div id="profile-menu" class="user-menu">
            <div class="user-info">
                <strong><span id="user-menu-username">사용자</span>님</strong>
                <p>환영합니다!</p>
            </div>
            <ul>
                <li><a href="/notifications" id="nav-notifications-link"><i class="fas fa-bell"></i> 알림 목록</a></li>
                <li><a href="/mypage"><i class="fas fa-user"></i> 마이페이지</a></li>
                <li><a href="/profile/edit"><i class="fas fa-user-edit"></i> 프로필 수정</a></li>
                <li><a href="#" id="logout-button"><i class="fas fa-sign-out-alt"></i> 로그아웃</a></li>
            </ul>
        </div>
        <button id="menu-toggle" class="menu-toggle-btn"><i class="fas fa-bars"></i></button>
    </div>
    <nav id="main-menu" class="main-nav">
        <ul>
            <li><a href="/"><i class="fas fa-home"></i> 메인 (Home)</a></li>
            <li><a href="/fields"><i class="fas fa-search"></i> 구장검색</a></li>
            <li><a href="/community"><i class="fas fa-users"></i> 커뮤니티</a></li>
            <li><a href="/chat"><i class="fas fa-comments"></i> 실시간채팅</a></li>
            <li><a href="/schedule"><i class="fas fa-calendar-alt"></i> 일정</a></li>
        </ul>
    </nav>
</header>

<main class="login-page-main">
    <div class="main-wrapper">
        <div class="login-section" style="padding-right: 70px;">
            <div class="login-container">
                <h1 class="title-login">마이페이지</h1>

                <div class="tab-buttons">
                    <button class="tab-btn active" data-tab="tab-info">회원정보</button>
                    <button class="tab-btn" data-tab="tab-calendar">캘린더 관리</button>
                    <button class="tab-btn" data-tab="tab-friends">친구 관리</button>
                </div>

                <div id="tab-info" class="tab-content active">
                    <h3 style="font-size: 24px; color: #2c3e50; margin-top: 20px; margin-bottom: 25px;">회원정보 확인</h3>

                    <div style="text-align: center; margin-bottom: 15px;">
                        <img id="profile-preview-view" th:src="@{/images/default-profile.png}" alt="프로필 사진" class="info-view-profile-pic">
                    </div>

                    <div class="score-display">
                        <div class="score-item">
                            매너 점수
                            <strong id="view-manner-score">4.8 / 5.0</strong>
                        </div>
                        <div class="score-item">
                            실력 레벨
                            <strong id="view-skill-level">중급</strong>
                        </div>
                    </div>
                    <div class="info-view-group">
                        <label>이메일</label>
                        <div id="view-email" class="info-view-text">...</div>
                    </div>

                    <div class="info-view-group">
                        <label>아이디</label>
                        <div id="view-username" class="info-view-text">...</div>
                    </div>

                    <div class="info-view-group">
                        <label>닉네임</label>
                        <div id="view-nickname" class="info-view-text">...</div>
                    </div>

                    <div class="info-view-group">
                        <label>포지션</label>
                        <div id="view-position" class="info-view-text">...</div>
                    </div>

                    <div class="info-view-group">
                        <label>주소</label>
                        <div id="view-address" class="info-view-text">...</div>
                    </div>

                    <a href="/profile/edit" class="login-button" style="text-decoration: none; text-align: center; margin-top: 25px;">
                        회원정보 수정하기
                    </a>
                </div>

                <div id="tab-calendar" class="tab-content">
                    <h3 style="font-size: 24px; color: #2c3e50; margin-top: 20px; margin-bottom: 20px;">내 일정 (캘린더)</h3>
                    <a href="/schedule/add" id="add-schedule-btn" class="login-button" style="margin-bottom: 20px; padding: 12px; font-size: 16px; text-decoration: none; display: block; text-align: center;">
                        <i class="fas fa-plus-circle" style="margin-right: 8px;"></i>새 일정 추가하기
                    </a>
                    <div class="calendar-container">
                        <div class="calendar-header">
                            <nav class="calendar-nav">
                                <button id="prev-month">&lt;</button>
                            </nav>
                            <h2 id="current-month-year">2025년 10월</h2>
                            <nav class="calendar-nav">
                                <button id="next-month">&gt;</button>
                            </nav>
                        </div>
                        <div class="calendar-grid" id="calendar-days-header">
                            <div class="calendar-header-cell">일</div>
                            <div class="calendar-header-cell">월</div>
                            <div class="calendar-header-cell">화</div>
                            <div class="calendar-header-cell">수</div>
                            <div class="calendar-header-cell">목</div>
                            <div class="calendar-header-cell">금</div>
                            <div class="calendar-header-cell">토</div>
                        </div>
                        <div class="calendar-grid" id="calendar-days-grid"></div>
                    </div>
                </div>

                <div id="tab-friends" class="tab-content">
                    <h3 style="font-size: 24px; color: #2c3e50; margin-top: 20px; margin-bottom: 20px;">친구 관리</h3>

                    <div class="tab-buttons sub-tabs">
                        <button class="sub-tab-btn active" data-sub-tab="sub-tab-friend-list">친구 목록</button>
                        <button class="sub-tab-btn" data-sub-tab="sub-tab-friend-add">친구 추가</button>
                    </div>

                    <div id="sub-tab-friend-list" class="sub-tab-content active">
                        <p style="font-size: 14px; color: #6c5ce7; font-weight: 600; text-align: right; margin-bottom: 15px;">
                            총 <span id="friend-count-display">0</span>명
                        </p>

                        <div class="friend-list-search-group">
                            <input type="text" id="friend-list-search-input" placeholder="친구 닉네임 검색">
                            <button onclick="searchFriendList()">검색</button>
                        </div>

                        <ul id="friend-list" class="friend-item-list">
                        </ul>
                        <p id="no-friends-message" style="color: #777; text-align: center; padding: 20px; display: none;">
                            등록된 친구가 없습니다. '친구 추가' 탭에서 친구를 찾아보세요.
                        </p>
                    </div>

                    <div id="sub-tab-friend-add" class="sub-tab-content">
                        <p style="font-size: 14px; color: #6c5ce7; margin-bottom: 15px;">추가하고 싶은 사용자의 닉네임을 검색해 주세요.</p>

                        <div class="friend-add-search-group">
                            <input type="text" id="friend-add-search-input" placeholder="친구 닉네임 검색">
                            <button onclick="searchNewFriends()">검색</button>
                        </div>

                        <div id="friend-add-search-results" style="border: 1px dashed #ddd; border-radius: 8px; padding: 15px; min-height: 100px;">
                            <p style="color: #999; text-align: center;">검색 결과가 없습니다.</p>
                        </div>

                        <div class="friend-add-actions" style="display: none;">
                            <button class="btn-add-selected" onclick="addSelectedFriends()">선택한 친구 추가</button>
                        </div>
                    </div>

                </div> </div>
        </div>
        <div class="background-image-section"></div>
    </div>
</main>

<script>
    // --- 공통 메뉴 토글 (생략) ---
    const menuToggle = document.getElementById('menu-toggle');
    const mainMenu = document.getElementById('main-menu');
    const profileMenuToggle = document.getElementById('profile-menu-toggle');
    const profileMenu = document.getElementById('profile-menu');
    const logoutButton = document.getElementById('logout-button');

    if (menuToggle) {
        menuToggle.addEventListener('click', () => {
            mainMenu.classList.toggle('show');
            profileMenu.classList.remove('show');
        });
    }
    if (profileMenuToggle) {
        profileMenuToggle.addEventListener('click', () => {
            profileMenu.classList.toggle('show');
            mainMenu.classList.remove('show');
        });
    }
    document.addEventListener('click', (event) => {
        if (!mainMenu.contains(event.target) && !menuToggle.contains(event.target) &&
            !profileMenu.contains(event.target) && !profileMenuToggle.contains(event.target)) {
            mainMenu.classList.remove('show');
            profileMenu.classList.remove('show');
        }
    });
    if (logoutButton) {
        logoutButton.addEventListener('click', (e) => {
            e.preventDefault();
            localStorage.removeItem('accessToken');
            window.location.href = '/login';
        });
    }

    // --- 알림 배지 및 인증 상태 로직 ---
    const badge = document.getElementById('notification-badge');
    let hasReviewNotif = false;
    let hasScheduleNotif = false;

    function updateGlobalBadge() {
        badge.style.display = (hasReviewNotif || hasScheduleNotif) ? 'block' : 'none';
    }

    async function checkPendingReviews() {
        await new Promise(r => setTimeout(r, 200));
        hasReviewNotif = localStorage.getItem('hasReadReviews') !== 'true';
    }
    async function checkUpcomingSchedules() {
        await new Promise(r => setTimeout(r, 500));
        hasScheduleNotif = true;
    }

    document.addEventListener('DOMContentLoaded', async () => {
        const accessToken = localStorage.getItem('accessToken');
        if (!accessToken) {
            alert("로그인이 필요한 페이지입니다.");
            window.location.href = '/login';
        } else {
            profileMenuToggle.style.display = 'block';
            await checkPendingReviews();
            await checkUpcomingSchedules();
            updateGlobalBadge();
            fetchMyInfo(accessToken);
            renderCalendar();

            const initialActiveMainTab = document.querySelector('.tab-btn.active');
            if (initialActiveMainTab && initialActiveMainTab.getAttribute('data-tab') === 'tab-friends') {
                document.querySelector('.sub-tab-btn[data-sub-tab="sub-tab-friend-list"]').click();
            } else {
                fetchMyInfo(accessToken);
            }
        }
    });

    // --- 내 정보 (더미, ERD 반영) ---
    async function fetchMyInfo(token) {
        const myInfo = {
            email: "real.user@example.com",
            username: "RealUser123",
            nickname: "리얼유저",
            position: "미드필더 (MF)",
            address: "서울시 서초구",
            mannerScore: "4.8", // ERD: User.manner_score
            skillLevel: "중급"    // ERD: User.skill_level
        };
        document.getElementById('view-email').textContent = myInfo.email;
        document.getElementById('view-username').textContent = myInfo.username;
        document.getElementById('view-nickname').textContent = myInfo.nickname;
        document.getElementById('view-address').textContent = myInfo.address;
        document.getElementById('view-position').textContent = myInfo.position;

        // ERD 반영된 필드 업데이트
        document.getElementById('view-manner-score').textContent = myInfo.mannerScore + ' / 5.0';
        document.getElementById('view-skill-level').textContent = myInfo.skillLevel;
    }

    // --- 메인 탭 전환 (친구 관리 탭 클릭 시 서브 탭 초기화 포함) ---
    const tabButtons = document.querySelectorAll('.tab-btn');
    const tabContents = document.querySelectorAll('.tab-content');
    tabButtons.forEach(button => {
        button.addEventListener('click', () => {
            const targetTab = button.getAttribute('data-tab');
            tabButtons.forEach(btn => btn.classList.remove('active'));
            tabContents.forEach(content => content.classList.remove('active'));
            button.classList.add('active');
            document.getElementById(targetTab).classList.add('active');

            if (targetTab === 'tab-friends') {
                const defaultSubTabBtn = document.querySelector('.sub-tab-btn[data-sub-tab="sub-tab-friend-list"]');
                if (defaultSubTabBtn) {
                    defaultSubTabBtn.click();
                }
            }
        });
    });

    // --- 캘린더 (더미, ERD 반영: 매치 타입 색상 구분 및 링크 분기) ---
    const monthYearElement = document.getElementById('current-month-year');
    const daysGrid = document.getElementById('calendar-days-grid');
    const prevMonthBtn = document.getElementById('prev-month');
    const nextMonthBtn = document.getElementById('next-month');
    let currentDate = new Date(2025, 9, 1);

    // ERD 반영: 일정 데이터 (match/private 타입 구분)
    const MOCK_SCHEDULES = [
        { day: 5, type: 'match', title: '강남 팀 매치', id: 1 },
        { day: 12, type: 'private', title: '개인 연습 예약', id: 2 },
        { day: 25, type: 'match', title: '수원 팀 매치', id: 3 },
        { day: 26, type: 'private', title: '장비 점검', id: 4 }
    ];

    function handleEventClick(event, schedule) {
        event.stopPropagation();
        if (schedule.type === 'match') {
            // 경기 일정: 기존 상세 페이지로 이동
            window.location.href = `/schedule/detail/${schedule.id}`;
        } else if (schedule.type === 'private') {
            // 개인 일정: 새로 만든 개인 일정 상세 페이지로 이동
            window.location.href = `/schedule/private/detail?id=${schedule.id}`;
        }
    }

    function renderCalendar() {
        daysGrid.innerHTML = '';
        const year = currentDate.getFullYear();
        const month = currentDate.getMonth();
        monthYearElement.textContent = `${year}년 ${month + 1}월`;
        const firstDayOfMonth = new Date(year, month, 1).getDay();
        const daysInMonth = new Date(year, month + 1, 0).getDate();

        // 이전 달 빈 칸
        for (let i = 0; i < firstDayOfMonth; i++) {
            const cell = document.createElement('div');
            cell.classList.add('calendar-day-cell', 'other-month');
            daysGrid.appendChild(cell);
        }

        // 이번 달 날짜
        for (let day = 1; day <= daysInMonth; day++) {
            const cell = document.createElement('div');
            cell.classList.add('calendar-day-cell');
            cell.textContent = day;

            // 일정 데이터 삽입
            const schedulesToday = MOCK_SCHEDULES.filter(s => s.day === day);
            if (schedulesToday.length > 0) {
                schedulesToday.forEach(schedule => {
                    const eventDiv = document.createElement('div');
                    let typeClass = schedule.type === 'match' ? 'match-event' : 'private-event';

                    eventDiv.className = 'calendar-event ' + typeClass;
                    eventDiv.textContent = schedule.title;
                    eventDiv.title = schedule.title; // 툴팁

                    // 이벤트 리스너에서 타입에 따라 분기 처리
                    eventDiv.onclick = (e) => handleEventClick(e, schedule);
                    cell.appendChild(eventDiv);
                });
            }
            daysGrid.appendChild(cell);
        }
    }
    prevMonthBtn.addEventListener('click', () => {
        currentDate.setMonth(currentDate.getMonth() - 1);
        renderCalendar();
    });
    nextMonthBtn.addEventListener('click', () => {
        currentDate.setMonth(currentDate.getMonth() + 1);
        renderCalendar();
    });

    // --- 친구 관리 서브 탭 로직 (기존 로직 유지) ---
    const subTabButtons = document.querySelectorAll('.sub-tab-btn');
    const subTabContents = document.querySelectorAll('.sub-tab-content');

    subTabButtons.forEach(button => {
        button.addEventListener('click', () => {
            const targetSubTab = button.getAttribute('data-sub-tab');
            subTabButtons.forEach(btn => btn.classList.remove('active'));
            subTabContents.forEach(content => content.classList.remove('active'));
            button.classList.add('active');
            document.getElementById(targetSubTab).classList.add('active');

            if (targetSubTab === 'sub-tab-friend-list') {
                renderFriendList();
                document.getElementById('friend-list-search-input').value = '';
            } else if (targetSubTab === 'sub-tab-friend-add') {
                document.getElementById('friend-add-search-input').value = '';
                document.getElementById('friend-add-search-results').innerHTML = '<p style="color: #999; text-align: center;">검색 결과가 없습니다.</p>';
                document.querySelector('.friend-add-actions').style.display = 'none';
            }
        });
    });

    // 더미 친구 데이터 (초기 목록)
    let myFriends = [
        { nickname: 'User1', username: 'user1_id', status: 'online' },
        { nickname: 'User2', username: 'user2_id', status: 'offline' },
        { nickname: '축구왕', username: 'soccerKing_id', status: 'online' }
    ];

    // 친구 목록 탭 - 친구 목록 렌더링
    function renderFriendList(filterQuery = '') {
        const friendListEl = document.getElementById('friend-list');
        const friendCountDisplay = document.getElementById('friend-count-display');
        const noFriendsMessage = document.getElementById('no-friends-message');

        friendListEl.innerHTML = '';

        const filteredFriends = myFriends.filter(friend =>
            friend.nickname.toLowerCase().includes(filterQuery.toLowerCase()) || friend.username.toLowerCase().includes(filterQuery.toLowerCase())
        );

        if (filteredFriends.length === 0) {
            noFriendsMessage.style.display = 'block';
            friendCountDisplay.textContent = myFriends.length;
            return;
        } else {
            noFriendsMessage.style.display = 'none';
        }

        filteredFriends.forEach(friend => {
            const li = document.createElement('li');
            li.dataset.username = friend.username;

            li.innerHTML = `
                <strong>${friend.nickname} (${friend.username})</strong>
                <div class="action-buttons">
                    <button class="btn-chat" onclick="startOneOnOneChat(event, '${friend.username}')">1:1 채팅</button>
                    <button class="btn-delete" onclick="removeFriend(event, '${friend.username}')">친구 삭제</button>
                </div>
            `;

            li.addEventListener('click', function(e) {
                if (e.target.closest('.action-buttons')) {
                    e.stopPropagation();
                    return;
                }
                document.querySelectorAll('.friend-item-list li').forEach(item => {
                    if (item !== li) {
                        item.classList.remove('active');
                        const actions = item.querySelector('.action-buttons');
                        if (actions) { actions.style.display = 'none'; }
                    }
                });
                li.classList.toggle('active');
                const actions = li.querySelector('.action-buttons');
                if (actions) {
                    actions.style.display = li.classList.contains('active') ? 'flex' : 'none';
                }
            });

            friendListEl.appendChild(li);
        });
        friendCountDisplay.textContent = myFriends.length;
    }

    // 친구 목록 탭 - 친구 검색 (필터링)
    function searchFriendList() {
        const query = document.getElementById('friend-list-search-input').value.trim();
        renderFriendList(query);
    }

    // 친구 목록 탭 - 1:1 채팅 시작 (더미)
    function startOneOnOneChat(event, username) {
        event.stopPropagation();
        alert(`${username}님과 1:1 채팅을 시작합니다! (채팅 페이지로 이동)`);
        window.location.href = `/chat?user=${username}`;
    }

    // 친구 목록 탭 - 친구 삭제
    function removeFriend(event, username) {
        event.stopPropagation();
        if (confirm(`정말로 ${username}님을 친구 목록에서 삭제하시겠습니까?`)) {
            myFriends = myFriends.filter(friend => friend.username !== username);
            renderFriendList();
            alert(`${username}님을 친구 목록에서 삭제했습니다.`);
        }
    }

    // 더미 친구 검색 결과 (친구 추가 탭에서 검색 시 사용할 목록)
    const MOCK_SEARCH_ADD_FRIENDS = [
        { nickname: '새로운친구1', username: 'newFriend1_id', location: '서울 강남구' },
        { nickname: '새로운친구2', username: 'newFriend2_id', location: '경기 수원시' },
        { nickname: '테스트맨', username: 'testMan_id', location: '부산 해운대구' },
        { nickname: '개발자', username: 'dev_id', location: '제주도' },
        { nickname: '풋살매니아', username: 'futsal_man', location: '인천 연수구' },
    ];
    let currentAddSearchResults = [];

    // 친구 추가 탭 - 새로운 친구 검색
    function searchNewFriends() {
        const query = document.getElementById('friend-add-search-input').value.trim();
        const searchResultsContainer = document.getElementById('friend-add-search-results');
        const addActions = document.querySelector('.friend-add-actions');
        searchResultsContainer.innerHTML = '';
        currentAddSearchResults = [];

        if (!query) {
            searchResultsContainer.innerHTML = '<p style="color: #e74c3c; text-align: center;">검색할 닉네임을 입력해 주세요.</p>';
            addActions.style.display = 'none';
            return;
        }

        const found = MOCK_SEARCH_ADD_FRIENDS.filter(f =>
            f.nickname.toLowerCase().includes(query.toLowerCase()) || f.username.toLowerCase().includes(query.toLowerCase())
        );

        let potentialFriendsCount = 0;
        if (found.length > 0) {
            found.forEach(user => {
                const isAlreadyFriend = myFriends.some(f => f.username === user.username);
                const isAlreadyInSearchResults = currentAddSearchResults.some(f => f.username === user.username);

                if (!isAlreadyFriend && !isAlreadyInSearchResults) {
                    currentAddSearchResults.push(user);
                    const div = document.createElement('div');
                    div.className = 'friend-add-result-item';
                    div.dataset.username = user.username;
                    div.innerHTML = `
                        <div class="friend-add-info">
                            <input type="checkbox" id="add-user-${user.username}" value="${user.username}">
                            <label for="add-user-${user.username}">
                                <strong>${user.nickname}</strong> <span>(${user.username})</span>
                            </label>
                        </div>
                        <button class="btn-remove-search-result" onclick="removeSearchResultItem(this, '${user.username}')">X</button>
                    `;
                    searchResultsContainer.appendChild(div);
                    potentialFriendsCount++;
                }
            });

            if (potentialFriendsCount > 0) {
                addActions.style.display = 'block';
            } else {
                searchResultsContainer.innerHTML = '<p style="color: #6c5ce7; text-align: center;">검색 결과 중 추가 가능한 친구가 없습니다.</p>';
                addActions.style.display = 'none';
            }
        } else {
            searchResultsContainer.innerHTML = `<p style="color: #e74c3c; text-align: center;">'${query}' (으)로 검색된 사용자가 없습니다.</p>`;
            addActions.style.display = 'none';
        }
    }

    // 친구 추가 탭 - 검색 결과에서 X 버튼 클릭 시 항목 제거 (UI상)
    function removeSearchResultItem(button, usernameToRemove) {
        button.closest('.friend-add-result-item').remove();
        currentAddSearchResults = currentAddSearchResults.filter(user => user.username !== usernameToRemove);

        if (document.getElementById('friend-add-search-results').children.length === 0) {
            document.querySelector('.friend-add-actions').style.display = 'none';
        }
    }

    // 친구 추가 탭 - 선택한 친구 추가
    function addSelectedFriends() {
        const checkboxes = document.querySelectorAll('#friend-add-search-results input[type="checkbox"]:checked');
        if (checkboxes.length === 0) {
            alert('추가할 친구를 선택해 주세요.');
            return;
        }

        const addedFriendNames = [];
        checkboxes.forEach(checkbox => {
            const username = checkbox.value;
            const friendToAdd = MOCK_SEARCH_ADD_FRIENDS.find(f => f.username === username);
            if (friendToAdd && !myFriends.some(f => f.username === username)) {
                myFriends.push({ ...friendToAdd, status: 'offline' });
                addedFriendNames.push(friendToAdd.nickname);
            }
        });

        if (addedFriendNames.length > 0) {
            alert(`${addedFriendNames.join(', ')}님에게 친구 요청을 보냈습니다!`);
            document.querySelector('.sub-tab-btn[data-sub-tab="sub-tab-friend-list"]').click();
        } else {
            alert('이미 친구이거나 추가할 친구가 없습니다.');
        }

        document.getElementById('friend-add-search-results').innerHTML = '<p style="color: #999; text-align: center;">검색 결과가 없습니다.</p>';
        document.querySelector('.friend-add-actions').style.display = 'none';
        document.getElementById('friend-add-search-input').value = '';
    }
</script>
</body>
</html>