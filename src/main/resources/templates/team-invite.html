<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MULTI FC - 팀원 초대</title>

    <link rel="stylesheet" th:href="@{/css/style.css}">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700;900&family=Noto+Sans+KR:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">

    <style>
        .team-main {
            padding: 100px 40px 40px 40px;
            background-color: #f7f7f7;
            min-height: 100vh;
        }
        .team-container {
            max-width: 650px;
            margin: 0 auto;
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        }
        .team-title {
            font-size: 28px;
            font-weight: 700;
            color: #4a90e2; /* 초대 강조색 */
            margin-bottom: 25px;
            border-bottom: 2px solid #ddd;
            padding-bottom: 10px;
            text-align: center;
        }
        .info-bar {
            background-color: #e6e6ff;
            color: #6c5ce7;
            padding: 10px 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-weight: 600;
            font-size: 15px;
            display: flex;
            justify-content: space-between;
        }
        .search-bar {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }
        .search-bar input {
            flex-grow: 1;
            padding: 10px 15px;
            border: 1px solid #ddd;
            border-radius: 8px;
        }
        .search-bar button {
            background-color: #f0f0f0;
            color: #333;
            border: 1px solid #ddd;
            padding: 10px 15px;
            border-radius: 8px;
            cursor: pointer;
        }

        .friend-list {
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid #eee;
            border-radius: 8px;
            padding: 10px 0;
        }
        .friend-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 20px;
            border-bottom: 1px solid #f7f7f7;
            transition: background-color 0.1s;
        }
        .friend-item:hover {
            background-color: #f5f5f5;
        }
        .friend-item input[type="checkbox"] {
            transform: scale(1.3);
            accent-color: #6c5ce7;
            cursor: pointer;
        }
        .friend-item label {
            flex-grow: 1;
            margin-left: 10px;
            cursor: pointer;
            font-weight: 500;
        }

        .action-buttons {
            margin-top: 30px;
            text-align: right;
        }
        .btn-invite-send {
            background-color: #6c5ce7;
            color: white;
            padding: 12px 25px;
            border-radius: 8px;
            font-weight: 700;
            border: none;
            cursor: pointer;
        }
        .btn-invite-send:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }
    </style>
</head>
<body>

<header class="quick-menu">
</header>

<main class="team-main">
    <div class="team-container">
        <h1 class="team-title"><i class="fas fa-user-plus"></i> [팀 이름] 팀원 초대</h1>

        <div class="info-bar">
            <span>현재 인원: <strong><span id="current-members-count">3</span> / <span id="max-members-count">10</span> 명</strong></span>
            <span>추가 가능 인원: <strong id="available-slots">7</strong>명</span>
        </div>

        <div class="search-bar">
            <input type="text" id="member-search-input" placeholder="초대할 친구 닉네임 검색">
            <button onclick="searchFriends()"><i class="fas fa-search"></i></button>
        </div>

        <h3 style="font-size: 18px; margin-bottom: 10px;">초대 가능한 친구 목록</h3>

        <div id="friend-list-to-invite-container" class="friend-list">
            <!-- JS로 친구 목록이 렌더링 됩니다. -->
        </div>

        <div class="action-buttons">
            <button id="send-invite-btn" class="btn-invite-send" disabled>
                <i class="fas fa-paper-plane"></i> 선택한 <span id="selected-count">0</span>명에게 초대 보내기
            </button>
        </div>
    </div>
</main>

<script>
    // --- 더미 데이터 ---
    const CURRENT_TEAM = { id: 101, name: "FC 매칭 히어로즈", current: 3, max: 10, participants: ["UserA", "캡틴손", "구원투수"] };

    // 더미 친구 목록 (팀에 없는 친구 목록)
    let MOCK_FRIENDS_FOR_INVITE = [
        { id: 1, name: '사용자B', username: 'user_b' },
        { id: 2, name: '사용자C', username: 'user_c' },
        { id: 3, name: '축구왕', username: 'soccer_king' },
    ];

    let selectedUsers = new Set();
    const MAX_SLOTS = CURRENT_TEAM.max - CURRENT_TEAM.current;

    // --- DOM 로드 시 초기화 ---
    document.addEventListener('DOMContentLoaded', () => {
        // 인증 로직은 생략

        // UI 정보 업데이트
        document.getElementById('team-title').innerHTML = `<i class="fas fa-user-plus"></i> ${CURRENT_TEAM.name} 팀원 초대`;
        document.getElementById('current-members-count').textContent = CURRENT_TEAM.current;
        document.getElementById('max-members-count').textContent = CURRENT_TEAM.max;
        document.getElementById('available-slots').textContent = MAX_SLOTS;

        renderFriendList(MOCK_FRIENDS_FOR_INVITE);
    });

    // --- 친구 목록 렌더링 ---
    function renderFriendList(friends) {
        const container = document.getElementById('friend-list-to-invite-container');
        container.innerHTML = '';

        if (friends.length === 0) {
            container.innerHTML = '<p style="text-align: center; color: #999; padding: 10px;">초대할 친구가 없습니다.</p>';
            return;
        }

        friends.forEach(friend => {
            const item = document.createElement('div');
            item.className = 'friend-item';

            const checkboxId = `friend-${friend.id}`;
            const isChecked = selectedUsers.has(friend.id);

            item.innerHTML = `
                <input type="checkbox" id="${checkboxId}" data-id="${friend.id}"
                    ${isChecked ? 'checked' : ''}
                    ${selectedUsers.size >= MAX_SLOTS && !isChecked ? 'disabled' : ''}>
                <label for="${checkboxId}">${friend.name} (${friend.username})</label>
            `;

            // 체크박스 클릭 이벤트 핸들러
            item.querySelector('input[type="checkbox"]').addEventListener('change', handleSelectionChange);

            container.appendChild(item);
        });
    }

    // --- 선택 변경 핸들러 ---
    function handleSelectionChange(e) {
        const friendId = parseInt(e.target.dataset.id);
        const isChecked = e.target.checked;

        if (isChecked) {
            if (selectedUsers.size < MAX_SLOTS) {
                selectedUsers.add(friendId);
            }
        } else {
            selectedUsers.delete(friendId);
        }

        // UI 상태 업데이트
        updateInviteButton();
        renderFriendList(MOCK_FRIENDS_FOR_INVITE); // 목록을 다시 렌더링하여 비활성화 상태 업데이트
    }

    // --- 버튼 상태 업데이트 ---
    function updateInviteButton() {
        const button = document.getElementById('send-invite-btn');
        const countSpan = document.getElementById('selected-count');

        const count = selectedUsers.size;
        countSpan.textContent = count;

        if (count > 0 && MAX_SLOTS > 0) {
            button.disabled = false;
            button.textContent = `초대 보내기 (${count}명)`;
        } else {
            button.disabled = true;
            button.textContent = `초대 보내기 (0명)`;
        }
    }

    // --- 친구 검색 기능 (더미) ---
    function searchFriends() {
        const query = document.getElementById('member-search-input').value.toLowerCase();

        const filteredFriends = MOCK_FRIENDS_FOR_INVITE.filter(friend =>
            friend.name.toLowerCase().includes(query) || friend.username.toLowerCase().includes(query)
        );

        renderFriendList(filteredFriends);
    }
    document.getElementById('member-search-input').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            searchFriends();
        }
    });

    // --- 초대 전송 (더미) ---
    document.getElementById('send-invite-btn').addEventListener('click', function() {
        if (selectedUsers.size === 0) return;

        // ⭐ 백엔드 API 호출: POST /api/teams/invite/{teamId}
        const inviteeIds = Array.from(selectedUsers);
        alert(`팀 ID ${CURRENT_TEAM.id}에 ${inviteeIds.length}명 초대 요청 전송 (시뮬레이션).`);

        // 성공 시 상태 초기화 및 팀 관리 페이지로 리다이렉트
        selectedUsers.clear();
        window.location.href = `/team/manage?id=${CURRENT_TEAM.id}`;
    });
</script>
